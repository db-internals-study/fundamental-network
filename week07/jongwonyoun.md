```toc
```


# 통신을 도와주는 네트워크 주요 기술

## 7.1 NAT/PAT
- NAT(Network Address Translation)은 사용자 모르게 실생활에서 많이 쓰는 기술
- 무선랜은 공유기, LTE는 통신사 장비 어디선가 등 NAT을 수행해 외부랑 통신
- 회사에서도 NAT, PAT 많이 쓴다
- 라우터나 L3 스위치 같은 L3 장비에서도 쓰이고
- 방화벽, 로드 밸런서처럼 세션을 다루는 L4 이상의 장비에서는 매우 빈번하게 쓰인다

- NAT는 말 그대로 네트워크 주소 변환
- 1 : 1 변환이 기본이지만 IP 주소 고갈 문제를 해결하기 위해 여러 개의 IP를 하나로 변환하기도 한다
	- 이는 NAPT(Network Address Port Translation)이 공식 명칭, NAT라고도 통칭해서 부르는 것
	- NAPT는 PAT(Port Address Translation)으로도 많이 쓴다.

- 사설 주소 <-> 공인 주소 변환도 하고
- IPv4 <-> IPv6 변환도 한다.
	- IP 주소를 변환하는 기술인 AFT(Adress Family Translation)도 NAT 기술의 일종
	- NAT64(IPv6 사용자가 IPv4 서버 접속), DNS64(IPv6 주소가 없으면 IPv4 기반으로 가짜 IPv6 주소 만들어줌) 등등
- 가장 많이 쓰는 건 사설 -> 공인

### 7.1.1 NAT/PAT의 용도와 필요성
- IPv4 주소 고갈 문제 해결방법으로 NAT 쓰임
	- 외부에 공개해야 하는 서비스에 공인 IP 쓰고, 외부에 공개할 필요 없는 일반 사용자의 PC나 기타 종단 장비에 사설 IP 사용
- 보안을 강화하는 데 쓰임
	- 외부에 IP를 숨겨 외부에 사내 IP 주소 체계를 숨길 수 있다
	- NAT는 주소 변환 후 역변환이 이루어져야 정상 통신이 가능하다
		- 이를 이용해 네트워크 방향성을 쉽게 통제 가능하다
		- 내부 -> 외부는 허용, 외부 -> 내부는 방어
- IP 주소 체계가 같은 네트워크 간 통신 가능
	- 사설 IP 주소는 내부에서만 사용하므로 다른 네트워크와 통신 가능
	- 카드사, 은행 연결은 별도 전용 회선이나 암호화된 별도 네트워크 많이 씀
	- 따라서 IP 대역이 같을 수도 있으므로 출발지와 도착지를 한꺼번에 변환하는 Double NAT 기술을 사용
		- 양쪽 앞에 NAT가 있고, 그 사이에 통신할 때는 미리 규약해둔 IP를 써서 변환한다는 것 같은데.. 자세하게는 모르겠습니다.
- 불필요한 설정 변경 줄이기
	- 대부분 통신사업자나 IDC 쪽에서 IP 할당 받아서 쓴다
		- 즉, 임시로 빌려 쓰는 것
		- 회선 사업자를 바꾸거나 IDC를 이전하면 공인 IP를 쓸 수 없으므로 IP 변경이 필요
	- NAT/PAT로 내부 네트워크 구성하면 외부 IP 쪽 설정만 변경하면 된다
	- 즉, 내부 네트워크를 특정 사업자에 종속되지 않게 만들 수 있다.

- 물론 장점만 있지는 않다
- 네트워크 운영자 입장에서는 장애가 발생하면 문제 해결이 힘들다
- IPv6 전환은 주소 부족 문제 해결도 있지만, NAT이 주는 어려움을 없애려는 목표도 있다
- 단말 간 직접 연결이 거의 이루어지지 않으므로 개발자는 항상 NAT 환경을 고려해야만 한다
- NAT의 이런 한계를 극복하기 위해 NAT 밑에 있는 단말까리 연결해주는 Hole Punching 기술이 나오고, 이를 위해 애플리케이션이 다시 복잡해지고 등등
	- STUN (Session Traversal Utilities for NAT)
		- 내부 서버 입장에서 공인 IP 주소, 포트 번호를 모름
		- -> STUN 프로토콜 사용해서 외부 서버에게 물어보면 공인 IP + 포트 번호를 알려줌
		- 덕분에 내부 서버도 자신이 외부에서 어떤 공인 IP + 포트 번호로 보이는지 알 수 있음
			- 단, 일부 NAT 혹은 Symmetric NAT은 외부로 나갈 때마다 포트 번호가 랜덤하게 바뀌어서 알아낸 포트 번호가 무용지물이 될 수 있음
		- 서로 알아낸 공인 IP + 포트 번호로 직접 통신을 시도
			- 이 정보를 시그널링 서버를 통해 교환
			- 대부분의 NAT 장비는 한 번 외부로 나간 요청에 대한 응답을 받는 것을 허용하므로 둘 사이의 통신이 성공할 수 있음
			- 이렇게 P2P 채널이 만들어질 수 있음
		- 그러나 모든 NAT에서 이런 게 가능하지는 않음
	- TURN (Traversal Using Relays around NAT)
		- P2P 연결에 실패했을 때 쓰는 최후의 수단
		- 대신 데이터를 중계해주는 서버
		- 거의 모든 NAT 환경에서 통신 가능
		- 그러나 느리고, TURN 서버의 부하가 심함
	- ICE (Interactive Connectivity Establishment)
		- STUN, Hole Punching, TURN 등 NAT 환경에서 사용 가능한 모든 수단을 총 동원해서 가장 효율적인 경로를 선택해 연결을 시도하는 프레임워크? 연결 방법?
		- WebRTC 등에서 사용
		- 후보 선택
			- 사설 IP(같은 네트워크일 수도 있으니까), STUN을 통해 알아낸 공인 IP(Server Reflexive Candidate), TURN 서버를 통해 할당 받은 중계 서버(Relay Candidate)
		- 후보 교환
			- 시그널링 서버를 통해 서로 수집한 후보 주소 목록을 교환
		- 연결 확인
			- 서로 교환한 목록을 조합해 다양한 경로로 연결 시도
			- 모든 조합으로 테스트 패킷을 주고 받음
		- 경로 선택
			- 연결에 성공한 경로 중 우선순위에 따라 최적의 경로 선택
			- 사설 IP 간 직접 연결 -> 공인 IP 간 직접 연결 -> TURN 서버를 통한 중계 연결
		- 통신 시작

- Symmetric NAT 환경에서는
	- STUN 서버를 통해 알아낸 나의 공인 IP, 포트 정보는 오직 그 STUN 서버와 통신할 때만 유효
	- 보안 혹은 ISP 입장에서 네트워크 관리나 자원 활용 등의 이유로 사용하곤 함 (특히 모바일 네트워크)

### 7.2.2 NAT 동작 방식
![](files/Pasted%20image%2020250405174046.png)

- 외부로 통신할 때 NAT가 출발지 IP를 공인 IP로 바꾸고, IP를 NAT 테이블에 저장
- 응답을 받은 NAT는 다시 IP를 보고, 이를 내부 IP로 변환해서 내부 네트워크에 전달

### 7.1.3 PAT 동작 방식
![](files/Pasted%20image%2020250405174227.png)

- 이번엔 NAT가 외부로 패킷 보낼 때 사설 IP, 포트 번호를 공인 IP + 새로운 포트로 변환. 그리고 이를 NAT 테이블에 저장
- 반대로 외부에서 응답이 오면 공인 IP + 새로운 포트 번호를 보고 다시 사설 IP + 기존 포트로 변환
- 덕분에 여러 개의 사용자를 지원할 수 있음
- 단, 서비스 포트의 개수는 제한되어 있어 재사용된다
- 만약 서비스 포트 모두 쓰고 있거나 재사용할 수 없을 때는 정상적으로 동작하지 않음
- 따라서 동시 사용자가 매우 많을 때는 PAT에서 사용하는 공인 IP 주소를 IP 하나가 아닌 풀로 구성해야 함

- PAT는 다수의 IP가 있는 출발지에서 목적지로 갈 때는 NAT 테이블이 생성되고, 응답에서 이를 참조
- 그러나 PAT IP가 목적지일 때는 해당 IP가 어느 IP에 바인딩되는지 확인할 수 있는 NAT 테이블이 없어 사용할 수 없다
- 즉, PAT는 SNAT만 적용되고 DNAT는 적용되지 않음

![](files/Pasted%20image%2020250405175409.png)

### 7.1.4 SNAT와 DNAT
![](files/Pasted%20image%2020250405175638.png)
- Source NAT : 출발지 주소 변경 NAT
- Destination NAT : 도착지 주소 변경 NAT
- 기준은 트래픽이 어디서 출발하느냐

![](files/Pasted%20image%2020250405175949.png)

- SNAT
	- 사설 -> 공인 통신할 때 많이 사용
		- 외부에서는 사설 대역으로의 경로를 알 수 없으므로 요청을 보낼 때 공인 IP로 바꿔야만 함
		- 공유기처럼 PAT 사용 등등
	- 혹은 보안상 SNAT 사용
		- 별도의 다른 IP로 전송해 실제 내부의 IP를 숨길 수 있음
		- 혹은 사내 IP가 다른 사내 IP랑 중복될 때도 변경해야 할 수 있음
			- 이 경우는 변경된 IP가 공인 IP가 아니어도 됨
	- LB 구성에 따라 SNAT 쓰기도 함
		- 출발지, 목적지 서버가 동일한 대역이라면 트래픽이 로드밸런서 거치지 않고 응답할 수 있어 SNAT를 통해 응답이 LB 거치지 않고 응답 -> DSR?

![](files/Pasted%20image%2020250405180721.png)

- DNAT
	- LB에서 많이 사용
		- 외부 -> LB의 VIP로 보냄
		- LB는 실제 서버에게 보낼 때 VIP를 실제 IP로 바꿔서 보냄 -> DNAT
	- 대외망 네트워크 구성에 사용
		- 사내 IP 주소는 중앙에서 관리하니 중복되지 않지만
		- 대외망끼리 연동하면 IP는 중복될 수 있다
		- 또한 IP가 중복되지 않아도 IP 주소가 제각각이므로 신규 대외사 연동마다 라우팅 개별 설정 필요
		- 대외망에 NAT 장비를 이용해 대외사의 IP를 특정 IP 대역으로 NAT
		- 이렇게 하면 사내에서는 어떤 대외사든 대외망 전용 NAT 대역으로 변경된 네트워크 대역으로 라우팅처리하면 되므로 대외사 추가해도 별도 라우팅 설정 필요 없고, 사내 IP와 중복되는 IP도 라우팅 이슈 없이 구성 가능
		- 즉, 외부 회사에 대한 NAT를 적용해 사내에서 쉽게 외부 회사를 지정할 수 있는 IP를 할당
		- 라우터 입장에서도 특정 IP 대역은 NAT 장비로 보내라고 설정하면 됨

### 7.1.5 동적 NAT와 정적 NAT
- 미리 출발지, 도착지 IP를 매핑해두는 것이 정적 NAT
- NAT 수행할 때 동적으로 변경되는 것이 동적 NAT

- 동적 NAT는 출발지, 도착지 모두 정의된 것이 아니라 다수의 IP 풀에서 정해지므로 최소한 출발지나 목적지 중 한 곳이 다수의 IP로 구성된 IP 풀이나 레인지로 설정됨
- NAT가 필요할 때 IP 풀에서 어떤 IP로 매핑될 것인지 판단해 NAT 테이블 만들어서 관리함
- NAT 테이블은 설정된 시간 동안 유지되고, 통신이 없으면 사라지므로 동적 NAT 설정은 서비스 흐름을 고려해 적용

- 정적 NAT는 출발지, 목적지 매핑 관계가 특정 IP로 사전 정의된 것이므로 1:1 NAT라고도 부른다. 
- 서비스 방향 고려도 필요 없음

![](files/Pasted%20image%2020250405180932.png)

![](files/Pasted%20image%2020250405180940.png)

- 정적 NAT를 설정하면 방향성 없이 어느 방향에서 시작되더라도 같은 IP로 변환
- 외부 -> 내부 DNAT, 내부 -> 외부 SNAT
- 하지만 지정된 방향으로만 1:1 NAT가 적용되는 장비도 있음. 이건 두 개의 NAT 각각 설정 필요

## 7.2 DNS

[How DNS works. What is DNS? Learn how step by step.](https://howdns.works/)

- 네트워크 프로토콜은 크게 2개로 나뉨
- 데이터 프로토콜, 이를 도와주는 컨트롤 프로토콜

- 컨트롤 프로토콜은 통신에 직접 관여하지는 않지만, 통신 관계를 맺거나 유지에 도움

- TCP/IP에는 ARP, ICMP, DNS 등
- DNS는 도메인 주소를 IP 주소로 변환하는 역할

### 7.2.1 DNS 소개
- 도메인 주소가 쉽기도 하고
- 하나의 도메인 주소로 여러 개의 서버를 운영하거나, IP 주소 변경에 대처도 쉽다
- 또한 지리적으로 여러 위치에서 서비스하는 것도 가능

- 서비스에서 도메인 주소를 사용하더라도 실제로 패킷을 만들어 통신하려면 3계층의 IP 주소를 알아야 하고, 이를 위해 문자열로 된 도메인 주소를 실제 통신에 필요한 IP 주소로 변환하는 DNS 정보를 네트워크 설정 정보에 입력해야 함

- 도메인 주소를 사용하면, DNS로 해당 도메인에 대한 IP 주소 질의를 보내고, 그 결괏값으로 IP 주소를 받는다
![](files/Pasted%20image%2020250405184558.png)

- 내부 서비스 연결에도 DNS 사용
- 도메인 주소를 사용하면 DNS 변경만으로 복잡한 서비스 간 연결을 쉽게 변경 가능
- 보통 인터넷 DNS와 내부 DNS를 분리해서 운영

### 7.2.2 DNS 구조와 명명 규칙
- 도메인은 계층 구조
- 역트리 구조로, 최상위 루트부터 Top-Level 도메인, Second-Level 도메인, Third-Level 도메인 등 하위 레벨에 원하는 주소를 단계적으로 찾아감
- 각 계층의 경계를 `.`로 표시, 뒤에서 앞으로 해석

![](files/Pasted%20image%2020250405184742.png)
- 루트를 시작으로 Top-Level, Second-Level, Third-Level 등

- 도메인은 최대 128계층까지 구성, 계층별 길이는 63바이트, 전체 도메인 네임 길이는 255바이트
- 알파멧, 숫자, `-`만 사용 가능, 대소문자 구분 없음

#### 7.2.2.1 루트 도메인
- DNS 서버는 도메인을 직접 가지고 있거나, 캐싱된 정보를 활용
- 해당 도메인을 모르면 루트 도메인을 관리하는 루트 DNS에 쿼리

- 전 세계에는 13개의 루트 DNS가 있음
- DNS 서버 설치하면 루트 DNS의 IP 주소를 기록한 Hint 파일을 가지고 있어 별도 설정 필요 없음

[DNS 루트 서버 | Cloudflare](https://www.cloudflare.com/ko-kr/learning/dns/glossary/dns-root-server/)

![](files/Pasted%20image%2020250405185701.png)

#### 7.2.2.2 Top-Level Domain(TLD)
- 최상위 도메인인 TLD는 IANA에서 구분한 6가지 유형으로 구분
[Root Zone Database](https://www.iana.org/domains/root/db)
- Generic(gTLD)
	- 특별한 제한 없이 일반적으로 사용
	- 세 글자 이상으로 구성
	- com, edu, gov, mil, net, org 등등
- country-code(ccTLD)
	- 국가 최상위 도메인. ISO 3166에 따른 두 글자 국가 코드
- sponsored(sTLD)
	- 특정 목적을 위한 스폰서를 두고 있는 최상위 도메인
	- 민족공동체, 전문가 집단, 지리적 위치 등등
	- aero, asia, edu, museum 등
- infrastructure
	- 운용상 중요한 인프라 식별자 공간을 지원하기 위해 사용되는 최상위 도메인
	- `.arpa`
	- 인터넷 안정성을 유지하기 위해 새로운 모든 인프라 하위 도메인이 배치될 도메인 공간 역할
	- `.IN-ADDR.ARPA`가 이런 하위 도메인 중 하나로, IPv4 주소를 도메인 이름에 매핑하는 역방향 도메인에서 사용
		- in-addr.arpa(IPv4용)와 ip6.arpa(IPv6용)
		- 142.250.196.196의 역방향 조회는 `196.196.250.142.in-addr.arpa` 라는 도메인에 질의하는 방식으로 이루어진다
- generic-restricted(grTLD)
	- 특정 기준을 충족하는 사람이나 단체가 사용
	- `.biz`, `.name`, `.pro` 등
- test(tTLD)
	- IDN 개발 프로세스에서 테스트 목적으로 사용
	- `.test`

### 7.2.3 DNS 동작 방식
- DNS 서버에 도메인을 쿼리해야 함
- 그러나 DNS 서버 없이 로컬에 도메인과 IP 주소를 설정해서 사용하는 것도 가능
- `hosts` 파일에서 도메인과 IP 주소를 관리
- 이 파일에 설정하면 해당 도메인 리스트는 항상 DNS 캐시에 저장됨

- 도메인을 쿼리하면 DNS 서버에 쿼리하기 전 로컬에 있는 DNS 캐시부터 확인
- DNS 캐시에는 동적으로 확인한 DNS 정보와 `hosts` 파일 정보가 있다
- 캐시에 정보가 없으면 DNS 서버로 쿼리하고, 응답을 받으면 캐시에 저장

![](files/Pasted%20image%2020250405190626.png)

- 과거에는 인터넷 연결 단말이 적어 `hosts`에 전화번호부처럼 저장해놓곤 했음
- 인터넷 상용화되면서 DNS 체계가 생김
- 관리 문제를 해결하기 위해 중앙집중식 시스템을 구성하고, 폭증한 단말을 수용하기 위해 계층 구조를 채택

![](files/Pasted%20image%2020250405190727.png)

- 전세계 도메인 정보를 하나의 DNS 서버에 저장할 순 없다
- 데이터도 방대하지만, 인터넷에 엄청나게 많은 사용자가 등록하고 삭제하는 도메인 리스트를 실시간으로 업데이트할 수 없다
- 그래서 분산된 데이터베이스로 서로 도와주는 방식으로 설계됨
- 자신이 가진 도메인 정보가 아니면 다른 DNS에 질의해 결과를 받음

- DNS 기능을 서버에 올리면 기본적으로 루트 DNS 정보를 알고 있음
- 모르는 도메인은 루트 DNS에 쿼리하고, 루트 DNS에서는 쿼리한 도메인의 TLD를 확인해 해당 TLD를 관리하는 DNS가 어디인지 응답

- `zigispace.net` 도메인을 질의하면 DNS 서버는 루트 DNS 서버에 다시 쿼리하고, 루트 DNS는 `.net` 정보를 관리하는 DNS 서버 주소 정보를 DNS 서버에 응답
- 이 응답을 받은 DNS 서버는 다시 `.net`을 관리하는 DNS 서버에 `zigispace.net`에 대해 쿼리
- `.net`을 관리하는 DNS 서버는 다시 `zigispace.net`을 관리하는 DNS 관련 정보를 처음 DNS 서버에 응답
- DNS 서버는 마지막으로 `zigispace.net` 관리하는 DNS 서버에 질의하고, 최종 결괏값을 받는다
- 클라는 한 번만 질의하지만, DNS 서버는 여러 단계로 쿼리를 나눠서 정보를 얻음
- 호스트가 DNS 서버에 질의했던 방식을 재귀적 쿼리라고 하고, DNS 서버가 루트 NS, TLS NS, zigispace NS에 질의하는 방식을 반복적 쿼리라고 한다.

- 재귀적 쿼리는 쿼리를 보낸 클라이언트에 서버가 결과를 반환하는 서버 중심 쿼리
- 반복적 쿼리는 최종값을 받을 때가지 클라이언트에서 계속 쿼리하는 방식
- 재귀적 쿼리는 클라이언트와 로컬 DNS 사이에서 사용, 반복적 쿼리는 로컬 DNS와 상위 DNS 구간에서 사용
- 로컬 DNS는 클라이언트로 동작해 상위 DNS에 반복적으로 쿼리

![](files/Pasted%20image%2020250405191148.png)

### 7.2.4 마스터와 슬레이브
![](files/Pasted%20image%2020250405191219.png)

- DNS 서버는 마스터 서버와 슬레이브 서버로 나눌 수 있다
- 마스터 서버가 우선순위가 더 높은 건 아니고, 둘 다 쿼리에 응답
- 도메인에 대한 Zone 파일을 직접 관리하는지 여부로 구분
- 마스터 서버는 존 파일을 직접 생성해 도메인 관련 정보를 관리하고, 슬레이브 서버는 마스터에 만들어진 존 파일을 복제
- 이를 영역 전송(Zone Transfer)이라고 한다.

- 이를 위해 슬레이브 서버를 만들 때 도메인을 복제해올 마스터 서버 정보를 입력
- 마스터 서버는 인가받지 않은 다른 DNS 서버가 복제해가지 못하도록 슬레이브 서버를 지정해 복제를 제한할 수도 있다
- 마스터 서버에 별 설정을 하지 않으면 무제한 복제가 가능

- Active-Standby, Active-Active로 구성하지 않는다
- 보통 이중화 방식은 액티브 장비의 문제가 발생하더라도 또 다른 액티브나 스탠바이 장비가 그대로 서비스
- DNS 서버는 마스터 서버에 문제가 발생하고 일정 시간이 지나면 슬레이브 서버도 정상 응답이 불가능해진다
- 이 시간을 만료 시간(Expiry Time)이라고 하고, SOA 레코드에 설정
- 만료 시간 안에 슬레이브 서버가 마스터 서버에서 존 정보를 받아오지 못하면 슬레이브의 존 정보는 사용할 수 없음
- 즉, 만료 시간 안에 마스터 서버 복구하거나 슬레이브 서버를 마스터로 전환해야 서비스 장애를 막을 수 있다.

- 액티브-스탠바이, 액티브-액티브
	- 액티브-액티브는 두 개의 노드가 동시에 서비스를 제공, 한 노드에 문제가 발생하면 다른 노드에서 서비스 계속 제공
	- 액티브-스탠바이는 두 개의 노드 중 액티브 노드만 서비스를 제공하고, 스탠바이 노드는 대기하고 있다가 액티브 노드에 장애가 발생하면 서비스를 시작
	- 두 가지 모두 한 대의 노드에 장시간 문제가 생겨도 두 대가 모두 죽지 않으면 정상적으로 서비스 제공

### 7.2.5 DNS 주요 레코드
![](files/Pasted%20image%2020250405194823.png)
#### 7.2.5.1 A(IPv4) 레코드
- 도메인 주소를 IP 주소로 변환
- 하나의 A 레코드에는 한 개의 도메인 주소와 한 개의 IP 주소
- 동일한 도메인을 가진 A 레코드를 여러 개 만들어 서로 다른 주소의 IP 주소와 매핑도 가능
- 반대로 다수의 도메인을 하나의 IP에 매핑하는 것도 가능

#### 7.2.5.2 AAAA(IPv6) 레코드
- IPv6 체계에서 사용하는 A 레코드

#### 7.2.5.3 CNAME(Canonical Name) 레코드
- CNAME 레코드는 도메인 주소를 매핑
- 네임 서버가 CNAME 레코드에 질의를 받으면 CNAMEA 레코드에 설정된 도메인 정보를 확인하고 그 도메인 정보를 내부적으로 다시 질의한 결과 IP를 응답
- 대표적인 예는 `www`

![](files/Pasted%20image%2020250405195138.png)

#### 7.2.5.4 SOA(Start of Authority) 레코드
- 도메인 영역에 관한 권한 레코드
- 현재 네임 서버가 이 도메인 영역에 대한 관리 주체임을 의미
- 해당 도메인에 대해서는 다른 네임 서버에 질의하지 않고 직접 응답
- 도메인 영역 선언 시 SOA 레코드는 필수 항목
- 그 외에 현재 도메인 관리에 필요한 송석값 설정
- 동기화에 필요한 타이머 값, TTL 값과 함께 네임 서버나 관리자 정보도 설정

#### 7.2.5.5 NS(Name Server) 레코드
- 도메인에 대한 권한이 있는 네임 서버 정보를 설정
	- 특정 도메인 정보를 가지고 있고, 그 정보에 대한 책임을 진다는 것
- 하위 도메인에 대한 권한을 다른 네임 서버로 위임하는 역할로도 많이 사용
	- 관리 편의를 위해 해당 하위 도메인은 ~~ NS에 가서 물어보세요~를 지정할 수 있음

#### 7.2.5.6 MX(Mail eXchange) 레코드
- 메일 서버 구성할 때 사용
- 해당 도메인을 메일 주소로 갖는 메일 서버를 MX 레코드를 통해 선언
- 메일 서버에서 메일을 보낼 때 MX 레코드를 참조해 동작
- 우선순위 값을 이용해 다수의 MX 레코드를 선언
- 우선순위가 높은 서버로 메일을 보내고, 실패하면 다음 순서의 MX 레코드의 메일 서버에서 처리

#### 7.2.5.7 PTR(Pointer) 레코드
- IP 주소에 대한 질의를 도메인 주소로 응답
- A 레코드와 달리 하나의 IP 주소에 대해 하나의 도메인 주소만 가질 수 있음
- 주로 화이트 도메인 구성에 사용

#### 7.2.5.8 TXT(TeXT) 레코드
- 도메인 설명 등 간단한 텍스트 입력
- 화이트 도메인을 위한 SPF 레코드로도 사용
- 공백 포함 가능, 대소문자 구문, 최대 255자

### 7.2.6 DNS에서 알아두면 좋은 내용
#### 7.2.6.1 도메인 위임(DNS Delegation)
- 자신이 가진 도메인 권한을 다른 곳으로 일부 위임해 위임한 곳에서 세부 레코드를 관리
- CND, GSLB 사용 등이 대표적
- 도메인은 계층 구조라서 특정 계층의 레코드를 위임하면 해당 레코드의 하위 계층도 함께 위임 처리

- `zigspace.net` 관리하는 NS는 'A' DNS 서버
- 'A' DNS 서버에는 `home.zigspace.net`, `a.home.zigspace.net`, `blog.zigspace.net`, `b.blog.zigspace.net` 등에 대한 레코드 정보 포함됨
- 이때 `zigspace.net` 도메인 하윙에 `post` 영역을 추가하고 이 영역을 'A;' DNS 서버가 아니라 'B' GSLB에서 관리하려고  할 때 'A' DNS 서버는 post 영역 권한을 'B' GSLB로 넘겨줄 수 있다
- 이를 위임이라고 한다
- post 영역을 'B' GSLB로 위임한다는 레코드 설정이 'A' DNS 서버에 들어가고, `post.zigspace.net`을 포함한 하위 영역 세부 레코드 `c.post.zigspace.net`은 'B' GSLB에서 관리

![](files/Pasted%20image%2020250405200041.png)

#### 7.2.6.2 TTL
- TTL은 DNS 질의 결과를 캐시에서 유지하는 시간
- 로컬 캐시에 저장된 도메인 정보를 무작정 계속 갖고있는 게 아니라 DNS 설정된 TTL 값에 따라 그 시간만 로컬 캐시에 저장
- TTL 늘리면 캐시를 많이 써 질의를 줄여 응답 시간을 줄일 수 있지만 DNS 변경이 발생하면 DNS 정보 갱신이 그만큼 지연된다는 단점 존재.
- 반대로 너무 작으면 DNS 쿼리량이 늘어난다.

- 서비스의 성질과 도메인 정보의 갱신 빈도에 따라 TTL 적절히 조절

![](files/Pasted%20image%2020250405200215.png)

- 도메인 관련 시간
	- refresh
		- 보조 네임 서버에서 Zone Transfer를 통해 정보를 주기적으로 받아오는 주기
	- retry
		- 보조 네임 서버가 주 네임 서버로 접근이 불가능할 때 재시도하는 주기
	- expire
		- 보조 네임 서버가 주 네임 서버로부터 도메인 정보를 받아오지 못할 때 유지되는 시간
		- 해당 시간 동안 도메인 정보를 못 받아오면 주 네임서버에서 삭제된 것으로 간주하고 보조 네임 서버에서도 해당 도메인 정보 삭제

#### 7.2.6.3 화이트 도메인
- 정상 대량 이메일이 RBL 이력으로 간주되어 차단되는 것을 예방하기 위해 사전에 등록된 이메일 전송을 보장해주는 제도

- 정상 도메인을 인증, 관리하는 제도가 화이트 도메인
- 반대로 스팸메일 발송하는 사이트를 블랙리스트 정보로 관리해 메일 발송을 제한 -> RBL(Realtime Blackhole List, Realtime Blocking List)

- KISA RBL 사이트에서 화이트 도메인으로 등록 가능
- 이를 위해서는 SPF 레코드가 설정되어 있어야 한다
- SPF 레코드로 사전에 메일 서버 정보를 공개하면, 수신 측 메일 서버에서 해당 도메인을 통해 발송된 메일이 실제 등록된 메일 서버와 일치하는지 알 수 있다
- SPF 레코드 길이 제한이 있으므로, 하나의 도메인에 화이트 도메인으로 등록할 수 있는 메일 서버 개수가 제한되어 있다. (약 13개)

#### 7.2.6.4 한글 도메인
- 한글 도메인도 가능
- DNS에서 해당 한글을 퓨니코드로 변경하고, 퓨니코드로 DNS에 도메인 생성해야 함
- 퓨니코드(Punycode)
	- IDNA 기반 하에서 다국어 도메인이 아스키로 변환된 구문.
	- 즉, 다국어 문자 셋으로부터 온 코드 포인트들을 기본적인 문자열들로 유일하게 표현한 것
	- 한글뿐만 아니라 영어가 아닌 자국어 도메인을 사용할 수 있도록 해주는 표준 코드

- 퓨니코드로 변환된 문자열은 접두어 `xn--`이 붙는다

### 7.2.7 DNS 설정(Windows)

### 7.2.8 DNS 설정(Linux)
- `bind` 패키지 써서 DNS 서버 구축할 수 있다

### 7.2.9 호스트 파일 설정
- `hosts` 파일에 도메인-IP 주소 쿼리를 할 수 있다
- 테스트 목적으로 사용됨

- hosts 파일을 임의로 조작해 정상 사이트가 아니라 사용자의 정보를 빼내기 위한 유해 사이트로 접근을 유도하기도 한다



## 7.3 GSLB
- DNS로 하나의 레코드에 여러 IP 주소를 설정할 수 있다
- 이를 이용해 IP 주소를 나누어 로드밸런싱할 수 있다.
- 이를 DNS 로드밸런싱이라고 한다.
- 하지만 DNS만으로는 정상적인 서비스를 할 수 없다
- DNS는 설정된 서비스가 정상인지 확인하지 않고 응답한다.
- 즉, 가용성 향상 방법으로는 부족하다.


![](files/Pasted%20image%2020250405224128.png)

- GSLB(Global Server/Service Load Balancer)는 DNS의 이런 문제점을 해결한 도메인을 이용한 로드밸런싱 구현을 도와준다
- DNS와 동일하게 도메인 질의에 응답하면서 로드밸런서처럼 연결된 서비스가 정상인지 헬스 체크를 수행한다.

![](files/Pasted%20image%2020250405224436.png)

- 이런 이유로 GSLB를 인텔리전스 DNS라고도 부른다

### 7.3.1 GSLB 동작 방식
![](files/Pasted%20image%2020250405224520.png)

- LDNS는 `web.zigispace.net`을 관리하는 NS 서버 찾기 위해 root부터 질의
- `zigispace.net` 관리하는 NS 서버에게 `web.zigispace.net`에 대해 질의
- DNS 서버는 GSLB로 `web.zigispace.net` 위임했으므로 GSLB가 NS 서버라고 LDNS에 응답
- LDNS는 다시 GSLB에 `web.zigispace.net` 질의
- GSLB는 `web.zigispace.net`에 대한 IP 주솟값 중 현재 설정된 분산 방식에 따라 서울 또는 부산 데이터 센터 IP 응답

- GSLB는 `zigispace.net`이라는 FQND에 대한 IP 주소 정보를 단순히 갖고 있다가 응답하는 것이 아니라 헬스 체크를 통해 IP가 정상적인 서비스가 가능한 상태인지 확인
- 모두 정상이라면 정의된 알고리즘을 통해 IP를 결정
- 즉, GSLB는 일반 DNS와 거의 동일하게 동작. 단, 헬스 체크와 사전에 지정한 분산 방법을 이용한 부하 분산이 일반 DNS와의 차이점
	- 일반 DNS는 라운드 로빈으로 응답
### 7.3.2 GSLB 구성 방식
- GSLB 도메인 설정 방법은 2가지
	- 도메인 자체를 GSLB로 사용
	- 도메인 내의 특정 레코드만 GSLB 사용

- 도메인 자체를 GSLB로 사용하면 해당 도메인의 모든 레코드 설정을 GSLB 장비에서 관리
- 도메인 구입 시 도메인 권한을 갖는 네임 서버를 지정하는데 이 네임 서버가 도메인을 관리
- 즉, 도메인에 대한 네임 서버를 GSLB로 지정하고, GSLB에서 도메인에 대한 모든 레코드를 등록해 처리
- 이는 헬스 체크가 불필요한 경우뿐만 아니라 모든 레코드에 대한 질의가 GSLB를 통해 이루어져 GSLB에 부하를 준다.

- 보통 GSLB가 필요한 레코드는 많지 않아 특정 레코드만 GSLB가 처리하도록 한다.
- 두 가지 방법이 있다
	- 별칭(Alias) 사용 (CNAME)
	- 위임 사용 (NS 레코드 사용)

- 별칭을 이용해 GSLB를 사용하는 방법은 실제 도메인과 다른 별도의 도메인 레코드로 GSLB에 등록
- 외부 CND을 이용하거나 회사 내부에 GSLB를 사용해야 할 도메인이 많은 경우 한 꺼번에 관리하기 위해 사용
- 위임을 사용해 GSLB를 사용하는 경우, 실제 도메인과 동일한 레코드를 사용하며 도메인 전체를 위임하는 것이 대표적인 예
- DNS 서버에 CNAME 레코드로 CND 같은 외부 GSLB를 지정하면 CNAME 레코드의 값으로 등록된 FQND을 GSLB로 재질의해 서버를 찾아간다
	- 즉, CNAME 값으로 등록되는 FQDN이 GSLB가 네임 서버로 등록된 도메인을 사용해 GSLB로 재질의하게 만드는 것
	- 쉽게 말하면 GSLB 사용하는 FQDN을 CNAME에 등록

![](files/Pasted%20image%2020250405231120.png)

![](files/Pasted%20image%2020250405231216.png)

- NS 레코드에 GSLB 서버를 저장
- 이렇게 하면 최초 요청한 FQDN을 그대로 GSLB에 질의

![](files/Pasted%20image%2020250405231312.png)

- 하나의 FQDN을 위임 처리하면 해당 FQDN의 하위 도메인은 별도의 위임 처리 없이 이미 상위 계층에서 위임 처리되므로 특정 도메인 내에서 GSLB를 사용한 하부 도메인을 계층화하면 DNS 서버 설정을 최소화해 GSLB로 다수의 FQDN을 위임 처리할 수 있다

- 즉, 별칭을 이용해 GSLB를 사용하는 경우 CND처럼 외부 사업자가 있거나 도메인이 매우 많아 별도의 GSLB를 운영하기 위해 사용
- 위임의 경우 DNS와 같은 도메인으로 GSLB를 운영하면서 계층적으로 GSLB를 이용한 FQND을 관리할 때 사용
- 두 방식으로 혼재해서 사용하기도 함

### 7.3.3 GSLB 분산 방식
- 헬스 체크를 통한 트래픽 분산
- 지리적으로 멀리 떨어진 다른 데이터 센터에 트래픽 분산
- 지역적으로 가까운 서비스에 접속

- 헬스 체크를 이용해 서비스를 안정적으로 제공하는 건 GSLB의 주요 역할
- 이를 위해 LB처럼 라운드 로빈, 최소 접속, 해싱 등 여러 추가적인 방식을 제공 

- GSLB는 장비마다 다르지만 보통 다음 두 가지 헬스 체크 모니터링 요소 지원
	- 서비스 응답 시간 / 지연 (RTT/Latency)
		- 응답이 얼마나 빠른지 혹은 지연이 얼마나 없는지 확인하고 이를 이용해 분산 처리
	- IP에 대한 지리 정보
		- 가까운 사이트로 분산 처리

- 결국 목표는 정상인 서비스에 트래픽을 보내면서, 가능한 빠르게 서비스를 제공하는 쪽으로 보내는 것

- 이때 응답 시간이나 IP 주소에 대한 Geo 값은 사용자 기준이 아니라 LDNS와 GSLB 간 값
- 즉, 사용자가 해외 DNS 사용하면 사용자의 서비스 접속 시간은 더 길어질 수도 있다.

## 7.4 DHCP
- 네트워크와 통신하려면 물리적 네트워크 구성 외에도 IP 주소, 서브넷 마스크, 게이트웨이, DNS 서버 주소 등 여러 설정이 필요하다
- 사용자가 IP 정보를 직접 설정하거나 IP 정보를 할당해주는 서버를 이용해 자동으로 설정해야 한다
- 수동으로 IP와 네트워크 정보를 설정하는 것을 정적 할당, 자동으로 설정하는 것을 동적 할당이라고 한다.

- 데이터 센터의 서버팜 등 운영 망에서 사용되는 IP는 주로 정적 할당을 사용하지만
- PC 사용자를 위해 운영되는 사무실 네트워크에서는 동적 할당 방식을 주로 사용
- 핸드폰도 마찬가지, 공유기도 마찬가지

- IP를 동적으로 할당할 때 사용하는 프로토콜이 바로 DHCP(Dynamic Host Configuration Protocol)
- DHCP를 사용하면 사용자가 직접 입력해야 하는 IP 주소, 서브넷 마스크, 게이트웨이, DNS 정보를 자동으로 할당 받아 사용
- 별도 설정 없이 네트워크 이용 가능, 사용하지 않는 IP 정보는 회수되어 재사용되므로 유용하다
- 설정 오류나 중복 IP 할당 같은 문제도 피할 수 있다.

### 7.4.1 DHCP 프로토콜

- BOOTP(Bootstrap Protocol) 프로토콜 기반
- DCHP는 BOOTP와 유사하게 동작하지만, BOOTP에서 지원하지 않는 몇 가지 기능이 추가되어있음
- 둘 사이에는 호환성이 있어 서비스 포트가 같고, 호환도 됨

- DCHP는 서버와 클라이언트로 동작하며, 클라이언트 포트는 68, 서버 포트는 67
- 자세한 건 [RFC 2131](https://datatracker.ietf.org/doc/html/rfc2131), [RFC 3046](https://datatracker.ietf.org/doc/html/rfc3046), [RFC 3942](https://datatracker.ietf.org/doc/html/rfc3942)에서 찾아볼 수 있다

### 7.4.2 DCHP 동작 방식
![](files/Pasted%20image%2020250406143621.png)

- 호스트가 DCHP 서버로 IP를 할당받는 과정은 4단계로 진행된다.
1. DCHP Discover
	- DCHP 클라이언트는 DCHP 서버를 찾기 위해 DCHP Discover 메시지를 브로드캐스트로 전송
	- 클라이언트 IP가 아직 없으므로 출발지는 zero ip, 목적지는 브로드캐스트
	- 서비스 포트는 출발지가 UDP 68, 목적지는 UDP 67
	- IP를 할당받는 과정이라 패킷을 정상적으로 주고받을 수 없어 UDP 사용
2. DCHP Offer
	- DCHP Discover를 수신한 DCHP 서버는 클라이언트에 할당할 IP 주소와 서브넷, 게이트웨이, DNS 정보, Lease Time 등의 정보를 포함한 DCHP 메시지를 전송
	- DCHP  서버는 IP 리스트인 DCHP IP Pool 중 할당할 IP를 선택
	- 별도 설정이 없으면 IP Pool에서 임의로 할당하지만 특정 클라이언트의 MAC 주소와 IP 주소를 사전에 정의해두면 설정된 IP를 할당하므로 DHCP를 사용하면서 고정된 IP도 할당 가능하다
	- 이때 IP 주소뿐만 아니라 서브넷, 게이트웨이, DNS 정보, IP 주소 임대 시간, DCHP 서버 자신의 IP 정보를 포함한 메시지를 전송한다
3. DCHP Request
	- DCHP 서버로부터 제안받은 IP 주소(Requested IP)와 DCHP 서버 정보(DHCP Server identifier)를 포함한 DCHP 요청 메시지를 브로드캐스트로 전송
	- IP를 이미 아니 유니캐스트로 보내도 되지만 DCHP 서버 여러 대가 동작하는 환경을 위해 브로드캐스트로 전송
	- DCHP 서버가 여러 대인 경우 클라이언트는 DCHP Offer 메시지를 여러 개 동시에 수신하고, 그 중 한 Offer 메시지에 대해 Request 메시지를 전송
	- 클라이언트가 Request 메시지를 브로드캐스트로 전송해 Discover 메시지를 보내온 클라이언트가 자신이 제안한 IP 주소를 사용하는지 여부를 명시적으로 알 수 있음.
4. DCHP Acknowledgement
	- DCHP 클라이언트로부터 IP 주소를 사용하겠다는 요청을 받으면 DCHP 서버에 해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록하고 DCHP Request 메시지를 정상적으로 수신했다는 응답을 전송

- DCHP에서 IP 할당은 DCHP IP Pool에서 정해진 시간 동안 IP를 사용할 수 있도록 할당하는 것 -> 임대(Lease) 과정이라고 함
- 이 잠시라는 기간은 어떻게 정할까
- 임대 시간이 만료되면 클라이언트에 할당된 IP를 다시 IP Pool로 회수한다.
- 만약 클라이언트가 IP를 사용하던 중 임대 시간이 지나면 어떻게 될까
- IP는 다시 수거되고 다시 새롭게 할당 받아야 한다. 이때 기존 IP를 받을 수도 있고 새로운 IP를 받을 수도 있다.
- 물론 실제 동작은 이렇지는 않다.
- 클라이언트가 IP를 사용 중인 경우, 갱신(Renewal) 과정을 거쳐 사용 중인 동안 IP 주소가 IP 풀에 다시 반환되지 않고 계속 사용할 수 있다.

![](files/Pasted%20image%2020250406144517.png)

- 임대 시간 50% 지나면 DCHP 갱신 과정을 수행
- 이미 사용 중인 IP 정보가 있으니 Discover, Offer 과정을 생략하고 Request를 바로 전송하고 ACK를 받아 갱신을 진행
- 초기 임대에 비해 절차도 짧고, 유니캐스트로 진행되 불필요한 브로드캐스트 발생 X

- 만약 임대 시간 50% 지난 시점에서 갱신이 실패하면 남은 시간의 50%가 지난 시점, 즉 초기 임대 시간의 75%가 지난 시점에 갱신을 다시 시도
- 이떄도 실패하면 임대 시간 후에 IP 반납하고 다시 할당

- 임대 시간은 권고 시간이 있는 건 아니고, 환경에 맞춰 설정 가능
- 클라이언트가 어느 정도 고정되어있고 IP 풀 범위가 넓다면 임대 시간 길게 잡아도 됨
- 클라이언트가 불특정하면서 자주 바뀐다면 짧게 설정해 임대한 IP가 빨리 반환되도록 설정

- 실제로는 DCHP 관련 메시지가 더 많다.

|메시지 타입|내용|
|---|---|
|DHCP Discover|클라이언트가 사용한 DHCP 서버를 찾는 메시지|
|DHCP Offer|DHCP 서버가 IP 설정값에 대해 클라이언트에게 제안하는 메시지|
|DHCP Request|DHCP 서버에서 제안받은 설정값을 요청하는 메시지|
|DHCP Decline|현재 IP가 사용 중임을 클라이언트가 서버에 알려주는 메시지|
|DHCP Ack|DHCP 서버가 클라이언트에 받은 요청을 수락하는 메시지|
|DHCP Nak|DHCP 서버가 클라이언트에 받은 요청을 수락하지 않는다는 메시지|
|DHCP Release|클라이언트가 현재 IP를 반납할 때 사용하는 메시지|
|DHCP Inform|클라이언트가 서버에 IP 설정값을 요청하는 메시지|

- DCHP Starvation 공격
	- IP 풀에 IP 주소가 남아있지 않을 때 Discover 메시지를 보내면 IP를 할당할 수 없다
	- 이런 점을 악용해 DCHP 서버에서 가용한 모든 IP를 가짜로 할당받아 실제 클라이언트가 IP 주소를 할당받지 못하게 하는 공격 방식을 DCHP Starvation 공격이라고 한다.

### 7.4.3 DCHP 서버 구성
- DCHP 서비스를 사용하거나 DCHP 데몬을 사용해 구성 가능
- 스위치, 라우터, 방화벽, VPN 같은 네트워크 보안 장비에서도 DCHP 서비스가 가능

- DCHP 서버를 구성할 때 IP 주소 풀을 포함해 여러 송석 있다
	- IP 주소 풀(IP 범위)
		- 클라이언트에 할당할 IP 주소 범위
	- 예외 IP 주소(예외 IP 범위)
		- 클라이언트에 할당할 IP 주소로 선언된 범위 중 예외적으로 할당하지 않을 대역
	- 임대 시간
		- 클라이언트에 할당할 IP 주소의 기본 임대 시간
	- 서브넷 마스크
		- 클라이언트에 할당할 IP 주소에 대한 서브넷 마스크 정보
	- 게이트웨이
		- 클라이언트에 할당할 게이트웨이 정보
	- DNS
		- 클라이언트에 할당할 DNS 주소

#### 7.4.3.1 윈도에서 DCHP 서버 구성

#### 7.4.3.2 리눅스에서 DCHP 서버 구성

### 7.4.4 DCHP 릴레이
- DCHP 서버에서 IP 주소를 할당받기 위해 클라이언트와 서버 간에 전송되는 패킷은 모두 브로드캐스트
- 즉, 각 네트워크마다 DCHP 서버가 있어야 한다

- 네트워크 대역이 하나로 운영되는 작은 곳에서는 공유기와 같이 간단한 장비로 운영할 수 있어 고려할 사항이 별로 없지만
- 네트워크 영역이 여러 개인 환경에서 DCHP를 이용한다면 DCHP 서버 배치, 이중화와 관련된 다양한 사항 고려 필요
- 네트워크가 여러 개로 나뉜 환경에서는 DCHP의 브로드캐스트가 전달되지 않으므로 각 네트워크 환경마다 DCHP 서버를 개별 구축해야 할 수도 있다.

![](files/Pasted%20image%2020250406151443.png)

- 하지만 여러 개의 네트워크를 지닌 환경에서도 DCHP 릴레이 에이전트를 사용하면 DCHP 서버 한 대로 여러 네트워크 대역에서 IP 풀 관리 가능
- DCHP 릴레이 에이전트가 DCHP 패킷을 중간에서 중계하는 역할을 해준다.
- 브로드캐스트로 전달되는 DCHP 패킷을 동일 네트워크 대역의 DCHP 릴레이 에이전트가 수신하면 DCHP 서버로 갈 수 있도록 유니캐스트로 변환해준다
- 즉, 릴레이 에이전트를 사용하면 DCHP 서버를 네트워크마다 구성하지 않고 중앙 DCHP 서버만으로도 여러 네트워크에서 DCHP 환경 운영 가능

![](files/Pasted%20image%2020250406151610.png)
![](files/Pasted%20image%2020250406151623.png)

- DCHP 클라이언트와 DCHP 릴레이 에이전트 간에는 브로드캐스트로 동작하고 다시 DCHP 릴레이 에이전트와 DCHP 서버 간에는 유니캐스트로 동작
- 이를 위해 DCHP 릴레이 에이전트는 DCHP 클라이언트와 같은 L2 네트워크 내에 존재해야 하고, DCHP 서버에는 유니캐스트로 전달하기 위해 DCHP 서버의 IP 주소가 등록되어 있어야 한다.
