```toc

```

- 인프라도 다중화 필요
- 이를 위해서는 동일한 역할을 하는 인프라를 두 대 이상 구성하거나
- 하나의 장비 내에 NIC와 같은 내부 구성요소를 다중으로 구성하기도 하고
- 동일한 역할을 하는 애플리케이션을 동시에 여러 개 띄워 서비스하기도 함

## 11.1 이중화 기술 개요
### 11.1.1 SPoF
> 단일 장애점(單一障礙點, 영어: single point of failure, SPOF)은 시스템 구성 요소 중에서, 동작하지 않으면 전체 시스템이 중단되는 요소를 말한다. 예를 들어 이더넷 케이블과 전원, 이더넷 허브(HUB), 접속 단말들의 NIC(Network Interface Card) 등으로 이루어진 간단한 이더넷(Ethernet) 네트워크 시스템에 있어서 네트워크 허브(HUB) 장치의 전원은 SPOF이다. 허브의 전원이 차단됨과 동시에 나머지 모든 요소들은 네트워크를 사용할 수 없다. 높은 가용성을 추구하는 네트워크, 소프트웨어 애플리케이션, 상용 시스템에 단일 장애점이 있는 것은 바람직하지 않다. 단일 고장점, 단일 실패점이라고도 한다. 
> 잠재적인 단일 장애점을 평가함으로써, 복잡한 시스템 안에서 오작동 시 전체 시스템 중단을 야기하는 치명적인 컴포넌트를 판별할 수 있다. 높은 신뢰성을 요구하는 시스템은 단일 컴포넌트에 의존하지 않는 것이 좋다.

- 인프라의 본질적인 목표는 더 가용성 높은 서비스에 필요한 인프라를 안정적으로 제공하는 것
- 가용성, 연속성, 안정성 등의 항목을 보는 것도 인프라를 안정적으로 제공하는 데 필요한 주 지표이기때문
- 따라서 인프라를 설계할 때, 단일 접점의 장애가 전체 서비스에 영향을 미치지 않도록 SPoF를 만들지 않아야 한다.

![](files/Pasted%20image%2020250507181818.png)

#### 11.1.2 이중화의 목적
- 인프라를 구성하는 각 요소가 복수 개 이상으로 인프라를 구성해 특정 인프라에 문제가 발생하더라도 이중화된 다른 인프라를 통해 서비스가 지속되도록 해준다
- 서비스에 필요한 출발 지점부터 끝 지점까지 속하는 모든 인프라에 이중화 구성을 고려해야 한다
- 물리적 또는 가상 머신 서버, 인터페이스, 스위치, L4/L7 스위치, 방화벽, IGW, 회선 등 모든 요소가 이중화가 필요하다
- 이 모든 요소가 속한 데이터 센터도 이중화가 필요해 DR 센터나 액티브-액티브 데이터 센터를 구축

![](files/Pasted%20image%2020250507182223.png)

- 액티브-액티브로 구성하거나 액티브-스탠바이로 구성하거나 등등
- 앞에서 스위치의 스패닝 트리 프로토콜도 액티브-스탠바이 형태로 구성된 이중화라고 볼 수 있다.

- 근데 이중화하지 않아도 장애가 발생하지 않으면 아무런 문제가 없다
- 근데 왜 이중화 할까?

- 이중화하면 특정 지점에 문제가 생겨도 서비스 가능하다
- 즉, 서비스의 연속성 보장
- Fault Tolerance 보장

- 액티브-액티브로 구성하면 이중화된 인프라에서 서비스 요청을 동시 처리할 수 있으므로 처리 가능한 전체 용량이 증가
- 네트워크 연결, 회선 대역폭도 증가
- 단, 특정 지점에 장애가 발생하면 인프라 용량이 절반으로 떨어지므로 정상적인 서비스 불가능
- 즉, 결국 서비스에 문제가 발생할 수 있다
- 따라서 이중화할 때는 일부 장애가 나더라도 정상적인 서비스가 가능하도록 용량을 산정해서 설계해야 한다.

## 11.2 LACP
- 1990년대 중반까지는 각 벤더별로 장비 간 대역폭을 늘리기 위해 독자적인 방법을 연구
- 근데 독자적인 방법이다보니 다른 장비끼리 연결할 때는 호환성 문제가 발생
- 그래서 상호호환 가능한 연결 계층(Link Layer) 표준화를 시작
- 이 표준화가 바로 LACP(Link Aggregation Control Protocol)

- 이는 대역폭 화장을 통한 다음을 제공
	- 링크 사용률 향상(Improved Utilization of Available Link)
	- 향상된 장애 회복(Improved Resilence)

- LAC P 사용하면 두 개 이상의 물리 인터페이스로 구성된 논리 인터페이스를 이용해 모든 물리 인터페이스를 액티브 상태로 사용
- 스위치와 스위치, 스위치와 서버 간 네트워크 대역폭이 물리 인터페이스 수만큼 확장됨
- 또한 논리 인터페이스를 구성하는 물리 인터페이스 중 일부에 문제가 발생해도 나머지 물리 인터페이스로 서비스 유지
	- 액티브-액티브 -> 문제 생겨도 지연 없이 서비스 제공 가능

- LACP 구성 시 유의사항
- 액티브-액티브이므로 LACP로 구성하는 논리 인터페이스의 대역폭을 전체 기준으로 잡으면 안 됨

- 또한 LACP로 구성하는 물리 인터페이스들의 속도가 동일해야 함


### 11.2.1 LACP 동작 방식
- LACP를 통해 장비 간 논리 인터페이스 구성을 위해서는 LACPDU(LACP Data Unit)이라는 프레임 사용
- 출발지, 목적지, 타입, 서브 타입, 버전 정보 등을 매초마다 주고 받음

- 멀티캐스트 사용하고, 목적지 주소로 `01:80:c2:00:00:02`부터 `01:80:c2:00:00:10`까지 사용

![](files/Pasted%20image%2020250507185600.png)

- LACP 연결되려면 LACPDU를 주고받는 장비가 한 장비여야 함
- 즉, 두 개 이상의 물리 인터페이스가 서로 다른 장비에 연결되어 있으면 LACP를 이용한 이중화 불가능
	- 이는 MC-LAG

![](files/Pasted%20image%2020250507185700.png)

- LACP는 두 장비 간 LACPDU 패킷을 주고받으면서 구성되는데 한쪽 장비에서만 LACP 설정하면?
- LACP 논리 인터페이스 구성하려면 LACPDU 패킷을 주고받아야 하는데 LACP 설정이 있는 장비에서만 LACPDU를 상대방 장비로 보낼 수 있음
- 반대편 장비는 LACPDU를 보내지 않고 수신한 LACPDU에 대한 응답도 보내지 않음
- 즉, LACP 구성 불가능

![](files/Pasted%20image%2020250507185837.png)

|  모드  |                              동작                               |
|:------:|:---------------------------------------------------------------:|
| 액티브 | LACPDU를 먼저 송신하고 상대방이 LACP로 구성된 경우, LACP를 구성 |
| 패시브 | LACPDU를 송신하지 않지만 LACPDU를 수신받으면 응답해 LACP를 구성 |

![](files/Pasted%20image%2020250507194335.png)

- 보통 액티브 옵션을 사용
- LACPDU를 상대방 자입에 보내거나 받음
- 패시브 옵션이라면 LACPDU를 먼저 보내지 않지만 상대가 보낸 LACPDU에 대한 응답을 통해 LACP 구성됨
- 다만 양 단 장비 모두 패시브로 설정하면 LACPDU를 아무도 먼저 보내지 않으므로 정상적으로 LACP 연결 불가능

- LACP 구성 가능한 인터페이스 수는 장비에 따라 다르지만 보통 1~8개
	- 16개 이상을 하나의 논리 인터페이스로 묶는 기능이 지원되기도 함
- 반드시 동일한 속도의 인터페이스로 구성

### 11.2.2 LACP와 PXE
- 서버와 액티브-액티브 형태로 인터페이스 이중화를 구성할 때도 LACPDU를 사용
- 서버의 인터페이스를 하나의 논리 포트로 묶는 Bonding/Teaming 기술은 서버 운영체제에서 설정

- 하지만 PXE(Pre-boot eXectuion Environment)를 이용할 때는 운영체제 설치 전이므로 본딩과 티밍 같은 논리 인터페이스를 설정할 수 없음
- 따라서 네트워크 장비에서는 서버로부터 LACPDU를 수신할 수 없으므로 해당 인터페이스는 정상적으로 활성화되지 않음
- 따라서 LACP로 구성하려는 서버를 PXE로 운영체제를 설치할 때는 LACP 인터페이스가 아닌 일반 인터페이스로 구성해 운영체제를 설치하고, 운영체제에서 LACP 섧정을 다시 한 후 스위치 포트 설정을 변경해야 함

> PXE는 컴퓨터가 하드 드라이브나 CD/DVD, USB 같은 로컬 저장 장치 없이 **네트워크를 통해 운영 체제(OS) 또는 부팅 이미지를 로드하여 실행**할 수 있게 하는 표준화된 클라이언트-서버 환경입니다. 간단히 말해, 컴퓨터의 네트워크 카드(NIC)에 내장된 펌웨어를 사용하여 네트워크상의 다른 서버로부터 부팅에 필요한 파일을 받아오는 기술입니다.

- 이를 해결하기 위해 네트워크 장비에서 LACP를 설정할 때, 일정 시간 동안 LACPDU를 수신하지 못하면 한 개의 인터페이스만 활성화하고 LACPDU를 다시 수신하기 시작하면 두 개의 인터페이스를 모두 활성화할 수 있는 옵션을 제공

![](files/Pasted%20image%2020250507195235.png)

![](files/Pasted%20image%2020250507195244.png)

![](files/Pasted%20image%2020250507195249.png)

- 벤더마다 이 기술을 부르는 명칭이 조금씩 다름

![](files/Pasted%20image%2020250507195314.png)

## 11.3 서버의 네트워크 이중화 설정(Windows, Linux)
- 서버도 인터페이스 이중화에 사용되는 기술 이름이 OS마다 다르다
	- 윈도우 : Team, Teaming
	- 리눅스 : Bond, Bonding

- 서버 인터페이스도 이중화하면 논리 인터페이스 생성됨
- 생성되는 논리 인터페이스 이름이 각 운영체제의 네트워크 이중화 기술명
	- 리눅스 : Bond
	- 윈도우 : Team

- 레드햇 리눅스7부터 본딩 이외에 티밍이라는 기술도 추가되었지만 아직 본딩을 주로 사용하고, 티밍이 본딩을 대체하지 않으므로 여기서는 본딩만 다룸

- 서버 인터페이스 이중화는 네트워크 인터페이스 이중화와 다름
- 네트워크 이중화는 액티브-액티브 상태
- 그러나 서버는 액티브-액티브 구성도 가능하지만 선택할 수 있는 동작 중 하나일뿐

| 구분     | 윈도                                                 | 리눅스                                                                |
| ------ | -------------------------------------------------- | ------------------------------------------------------------------ |
| 기술명    | 티밍                                                 | 본딩                                                                 |
| 인터페이스명 | team #1, #2                                        | bond 0, bond 1                                                     |
| 동작 모드  | - Switch Independent<br>- LACP<br>- Static Teaming | 0: 라운드 로빈<br>1: 액티브-스탠바이<br>2: balance-xor<br>3: 브로드캐스트<br>4: LACP |

### 11.3.1 리눅스 본딩 모드
- 여러 모드가 있지만 실무에서 이중화할 때 액티브-스탠바이 모드로는 1을, 액티브-액티브 모드에는 4를 사용
- 나머지는 잘 사용하지 않음

#### 11.3.1.1 모드 1 : 액티브-스탠바이
![](files/Pasted%20image%2020250507211826.png)

- 평소 액티브 인터페이스로만 패킷 전달되다가 액티브 죽으면 스탠바이 인터페이스가 자동 활성화되어 패킷 전송
- 원래 액티브가 살아나면 설정에 따라 액티브 인터페이스가 자동으로 다시 활성화(Auto Fail Back)되거나 수동으로 넘기기 전까지 스탠바이 인터페이스가 활성화 상태 유지

#### 11.3.1.2 모드 2 : LACP
![](files/Pasted%20image%2020250507211921.png)

### 11.3.2 윈도우 티밍 모드
-  총 7가지 있지만 주로 쓰이는 두 가지만 다룬다

#### 11.3.2.1 스위치 독립(Switch Independent) 구성
- 팀을 구성하는 멤버 인터페이스가 스위치 구성에 독립적인 경우
- 스위치에서는 팀의 이중화에 관여하지 않으며, 액티브-스탠바이 구성

#### 11.3.2.2 LACP
- 리눅스 서버 모드 4와 동일한 LACP 구성
- 표준 프로토콜인 LACP 이용해서 팀을 액티브-액티브로 구성

> 서버에서 인터페이스 이중화를 위해 본드, 팀을 구성할 때 액티브-스탠바이 모드인 경우 네트워크 장비에서 이중화 관련 인터페이스 설정을 별도로 하지 않는다

### 11.3.3 리눅스 본드 설정 및 확인
#### 11.3.3.1 CentOS에서 본드 설정 및 확인
- 네트워크 설정 파일이 있는 디렉터리에 `bond` 인터페이스 파일을 생성하고 bon로 묶일 인터페이스에 추가 속성을 설정

```
cd /etc/sysconfig/network-scripts
```

- `bond` 인터페이스 파일 `ifcg-bond0`을 생성하고 아래처럼 설정

```
DEVICE=bond0
BOOTPROTO=none
onBOOT=yes
BOOTPROTO=static
IPADDR=10.10.10.11
NETMASK=255.255.255.0
GATEWAY=10.10.10.1
```

- bond 인터페이스 파일을 설정했으면 물리 인터페이스 파일, ifcfg-eth0, ifcfg-eth1 등에도 bond 인터페이스 사용을 위한 추가 속성을 정의
- 여기에는 ifcfg-eth0만 있지만 eth1도 똑같이 설정

```
DEVICE=eth0
BOOTPROTO=none
onBOOT=yes
MASTER=bond0
SLAVE=yes
```

- 이후에는 bonding 설정 파일 위치로 이동해 속성을 변경한다.

```
cd /etc/modprobe.d/
```

- bonding 설정 파일

```bonding.conf
alias bond0 bonding
options bond0 mode=4 miimon=100
```

- mode는 본드 구성에 대한 모드 번호
- miimon은 해당 밀리초마다 bond로 묶인 링크를 확인하는 옵션
- bond 모드의 기본값은 0(라운드 로빈)이며 miimon 값은 0 또는 1(0.001초)
- miimon이 0이면 상태 체크를 하지 않아 페일오버가 동작하지않음
	- 즉 반드시 다른 값으로 변경

- 본드 모듈 설정 대신 ifcfg-bond0 설정에 다음과 같이 본드 옵션 추가해도 동일하게 동작

```
BONDING_OPTS="mode=4 miimon=100"
```

- 모드 1을 사용해 액티브-스탠바이 구성으로 본드를 구성할 때는 위 옵션값 외에 어떤 인터페이스를 액티브로 사용할지에 대한 옵션 추가 설정 필요
- 설정 대신 ifcfg-bond0 설정에 다음 bond 옵션을 추가해도 동일하게 동작

```
BONDING_OPTS="mode=1 miimon=100 primary=eth0"
```

- 그러고는 리눅스 커널에 본드 모듈을 적재

```sh
modprobe bonding # 또는 modprobe bond0
```

- 본드 인터페이스를 게이트웨이로 설정하고 싶다면 다음 설정 추가

```sh
# /etc/sysconfig/network
GATEDEV=bond0
```

- bond 인터페이스를 설정하거나 수정한 후에는 네트워크 재시작 필요

```sh
service network restart # CentOS 6
systemctl restart network # CentOS 7
```

- 본드 설정 및 네트워크 재시작 후에는 본드가 정상적으로 잘 구성되었는지 확인

```sh
cat /proc/net/bonding/bond0
```

- 그러면 아래 내용 확인 가능
- 이는 현재 상태 값 확인은 물론 트러블 슈팅에도 사용된다

```sh
cat /proc/net/bonding/bond0

Ethernet Channel Bonding Driver: v3.6.0 (September 26, 2009)

Bonding Mode: fault-tolerance (active-backup)
Primary Slave: None
Currently Active Slave: eth0
MII Status: up
MII Polling Interval (ms): 100
Up Delay (ms): 0
Down Delay (ms): 0

Slave Interface: eth0
MII Status: up
Speed: Unknown
Duplex: Unknown
Link Failure Count: 0
Permanent HW addr: 00:13:5d:00:07:00
Slave queue ID: 0

Slave Interface: eth1
MII Status: up
Speed: Unknown
Duplex: Unknown
Link Failure Count: 0
Permanent HW addr: 00:13:5d:00:07:92
Slave queue ID: 0
```

- 본드 모듈 적재는 직접 수행하지 않아도 네트워크 서비스 재시작하면 모듈 적재가 되므로 생략해도 된다

- 본드 설정 후 bond0 인터페이스가 정상적으로 활성화되지 않을 때
	- 본드 설정 후 네트워크를 다시 시작하는 과정에서 본드 인터페이스가 정상적으로 활성화되지 못하는 경우가 있다
	- 이때는 NetworkManager를 중지하고 실행하면 된다
	- `service networkmanager stop`
	- `chkconfig metworkmanager off`

#### 11.3.3.2 우분투에서 본드 설정 및 확인
- 본드 설정하려면 먼저 `ifenslave` 패키지 설치

```sh
apt-get install ifenslave
```

- 그리고 커널 모듈에 bonding이라는 값이 필요
- 부팅 시점에 적재되므로 없다면 `/etc/modules` 파일에 `bonding` 값 추가하고 재부팅

```sh
# /etc/modules
bonding
```

- 본딩 설정을 위해 인터페이스 파일인 `/etc/network/interfaces`에 인터페이스 eth0과 eth1을 bond0 인터페이스로 만들기 위한 설정을 다음과 같이 수행

```sh
# /etc/network/interfaces

auto eth0
iface eth0 inet manual
    bond-master bond0

auto eth1
iface eth1 inet manual
    bond-master bond0

auto bond0
iface bond0 inet static
     address 192.168.1.10
     gateway 192.168.1.1
     netmask 255.255.255.0
     bond-mode 4
     bond-miimon 100
     bond-slaves none
```

### 11.3.4 윈도우 팀 설정 및 확인

## 11.4 MC-LAG
- LACP를 구성할 때는 LACPDU를 주고받는 장비 상호 간 구성이 1:1이어야 한다
- 즉, LACP 구성할 때 MAC 주소가 1:1 이어야 함
- 그래서 서버에서 본딩이나 티밍과 같은 이중화 구성을 할 때 각 네트워크 카드별로 물리 MAC 주소를 따로 사용하지 않고 두 개의 물리 MAC 주소 중 하나를 Primary MAC 주소로 사용한다
- 즉, 여러 개의 물리 인터페이스를 쓰더라도 하나의 MAC 주소를 사용해야 이 조건을 만족할 수 있다

- 서버에 인터페이스를 두 개 이상 구성하더라도 상단 스위치가 한 대로 구성된 경우에는 상단 스위치에 장애가 발생하면 서버는 통신이 불가능하다
- 이를 피하려면 서버의 인터페이스를 서로 다른 스위치로 연결해야 한다
	- 이를 양팔 벌린 구성이라고 한다
	- 서로 다른 스위치로 이중화 구성을 하면 두 스위치 간 MAC 주소가 달라 LACP를 사용할 수 없다
	- 그래서 서버에서도 액티브-스탠바이로 구성한다

![](files/Pasted%20image%2020250510221234.png)

- 그렇다면 스위치에서도 서버 이중화 구성처럼 서로 다른 스위치 간의 단일 MAC 주소를 사용해서 액티브-액티브 이중화를 할 수는 없을까?

![](files/Pasted%20image%2020250510221259.png)

- MC-LAG(Multi-Chasis Link Aggregation Group) 기술로 서로 다른 스위치 간의 실제 MAC 주소 대신 가상 MAC 주소를 만들어서 논리 인터페이스로 LACP 구성이 가능하다
- MC-LAG 기술을 이용하면 단일 스위치로 LACP 구성해 대역폭을 확장하거나 서로 다른 스위치로 구성해 장비 이중화로 가용성을 확보할 것인지 선택 가능

- MC-LAG는 벤더마다 이름이 좀 다르다
	- 시스코 Nexus 시리즈에서는 vPC(Virtual Port Channel)
	- Arista, Extrem Networks에서는 MLAG
	- 알카텔-루슨트나 주니퍼에서는 MC-LAG
	- 자세한 건 [Multi-chassis link aggregation group - Wikipedia](https://en.wikipedia.org/wiki/MC-LAG)

### 11.4.1 MC-LAG 동작 방식
- MC-LAG 구현은 벤더마다 조금씩 다르다
- 하지만 세부 동작은 달라도 개념은 비슷

![](files/Pasted%20image%2020250510221731.png)

- 구성 요소
	- Peer 장비
		- MC-LAG 구성하는 장비를 피어 장비라고 한다
	- MC-LAG 도메인
		- 두 Peer 장비를 하나의 논리 장비로 구성하기 위한 영역 ID
		- Peer 장비는 이 영역 ID를 통해 상대방 장비가 Peer를 맺으려는 장비인지 판단
	- Peer Link
		- MC-LAG를 구성하는 두 Peer 장비 간의 데이터 트래픽을 전송하는 인터링크

- 벤더에 따라 MC-LASG 같은 기능을 위해 피어 링크처럼 데이터 트래픽을 전송하는 링크랑 MC-LAG를 구성하기 위한 제어용 패킷을 전송하는 인터페이스를 별도로 구성하기도 한다.

- MC-LAG를 구성하려면 피어들은 하나의 도메인으로 구성해야 함
- 즉, 각 피어에 동일한 도메인 ID 설정

![](files/Pasted%20image%2020250510221902.png)

![](files/Pasted%20image%2020250510221910.png)

- 피어는 피어 간 데이터 트래픽 전송을 위해 피어 링크 구성
- 피어 링크는 다양한 네트워크가 통신할 수 있는 경로이므로 보통 Trunk로 구성된다
	- MC-LAG로 묶인 스위치는 보통 다양한 VLAN을 다룸
	- 따라서 여러 VLAN에 대한 별도 연결 없이 다룰 수 있도록 Trunk 사용
- MC-LAG를 구성하려면 피어 장비 간의 MC-LAG 관련 제어 패킷을 주고받아야 하는데 이 제어 패킷의 경로를 일단 데이터 트래픽 경로용의 인터링크인 피어 링크를 사용할 것인지 별도 제어 패킷을 위한 경로를 구성할 것인지에 따라 두 가지 경우로 구성 가능

- 피어 링크를 이용하면 각 피어의 VLAN 인터페이스의 IP를 설정하고 이 IP로 통신
- 별도 인터페이스 사용하면 해당 인터페이스를 L3 인터페이스로 구성해 이 인터페이스의 IP를 이용해 통신 가능

![](files/Pasted%20image%2020250510222303.png)

- MC-LAG 설정을 마치면 두 피어 장비는 MC-LAG를 맺기 위한 제어 패킷 주고받음

![](files/Pasted%20image%2020250510222338.png)

- 구성을 위한 협상이 잘 이루어지면 두 대의 장비는 하나의 MC-LAG 도메인으로 묶이고 인터페이스 이중화 구성에 사용할 가상 MAC 주소를 피어 장비 간에 동일하게 생성
- 이렇게 되면 MC-LAG 피어 장비들은 다른 장비와 LACP를 구성할 수 있다

![](files/Pasted%20image%2020250510222402.png)

- 두 장비 간에 LACP 구성할 때는 각 장비의 MAC 주소가 출발지의 MAC 주소가 된다
- MC-LAG 이용해 LACP 구성하면 MC-LAG 구성할 때 생성된 가상 MAC 주소로 LACPDU 전송
- 이렇게 장비의 개별 MAC 주소가 아니라 가상의 MAC 주소를 사용하므로 MC-LAG과 연결된 장비는 MC-LAG 피어들이 동일한 MAC 주소로 보이고 서로 다른 장비로도 LACP 구성이 가능해짐

- MC-LAG 도메인은 표준 용어가 아니다
	- 이해를 돕기 위해 사용된 용어
	- 주니퍼에서는 피어 링크를 ICL(Inter Chasis Link)라고 부른다

### 11.4.2 MC-LAG를 이용한 디자인
- 서로 다른 스위치로 서버를 액티브-액티브 구성하여 루프나 STP에 의한 차단 없는 네트워크 구조를 만들 수 있다.

![](files/Pasted%20image%2020250510222602.png)

- MC-LAG로 서버를 연결하면 스위치를 물리적으로 이중화하면서 액티브-액티브 구성으로 연결 가능

![](files/Pasted%20image%2020250510222637.png)

- 스위치 간의 MC-LAG 이용하면 루프 구조가 사라지므로 STP에 의한 차단 포트 없이 모든 포트 사용가능

![](files/Pasted%20image%2020250510222645.png)

- 상하단을 모두 MC-LAG로 구성하는 디자인도 만들 수 있다

## 11.5 게이트웨이 이중화
### 11.5.1 게이트웨이 이중화란?
- 목적지가 출발지 호스트의 서브넷에 포함되지 않은 외부 네트워크의 경우 목적지와 통신하기 위해 게이트웨이를 통해야 함
- 이런 통신을 L3 통신이라고 함
- 호스트에 게이트웨이 설정이 없거나 잘못 되면 외부 네트워크와 통신 불가능
- 마찬가지로 게이트웨이에 장애가 발생하면 장애가 발생한 게이트웨이를 바라보는 하단의 호스트는 외부 네트워크와 통신 불가능

![](files/Pasted%20image%2020250510222823.png)

- 게이트웨이 장애뿐만 아니라 인터페이스, SFP와 같은 광모듈이나 케이블에 문제가 생겨도 게이트웨이와 통신할 수 없으므로 외부 네트워크와 통신 불가능

- 위 장애 모두 10.1.1.1 IP를 가진 장비와 동일하게 게이트웨이 역할을 수행할 수 있도록 외부 네트워크와 연결된 10.1.1.2 장비가 있음에도 불구하고 하단 호스트는 하나의 게이트웨이만 바라보므로 외부 네트워크와 통신할 수 없다
- 즉, 물리적인 경로는 있지만 경로를 쓸 수 없어 장애가 발생

![](files/Pasted%20image%2020250510223413.png)

- 그러면 게이트웨이 역할을 하는 두 대의 장비가 하나의 IP 주소를 지니면 어떻게 될까
- 하나의 IP 주소와 하나의 MAC 주소를 갖고 하단 호스트들이 그 가상 IP 주소와 MAC 주소를 알 수 있다면 장애를 막을 수 있을까?
- 이럴 때 사용하는 게 바로 FHRP(First Hop Redundancy Protocol)라는 게이트웨이 이중화 프로토콜

- 게이트웨이 이중화 프로토콜을 사용하면 두 라우터는 실제 IP 외에도 가상 IP 주소와 MAC 주소를 갖는다
- 가상 IP는 그룹 내에서 우선순위가 높은 장비가 Active 상태로 유지되고 ARP 요청에 응답
- 가상 IP에 대한 Active 상태를 가진 장비에 문제가 발생하면 Standby 상태인 장비가 Active 상태가 된다

- 프록시 ARP
	- 호스트에 게이트웨이 설정이 없거나 틀려도 게이트웨이 장비에 Proxy ARP가 설정되어 있다면 호스트의 다른 네트워크와 통신 가능
	- 그러나 이런 구성은 FHRP 프로토콜 전부터 쓰던 오래된 구성이고 여러 가지 보안 문제가 있어 비활성화하는 것을 권고

### 11.5.2 FHRP
- FHRP는 외부 네트워크와 통신하기 위해 사용되는 게이트웨이 장비를 두 대 이상의 장비로 구성할 수 있는 프로토콜
- 우선순위 정해서 어느 장비가 Active가 될지 결정할 수 있음
- FHRP 그룹의 장비는 물리적으로 다른 장비지만 동일한 가상 IP, MAC 주소 제공

- FHRP를 구성한 게이트웨이는 그룹 ID 설정해서 같은 그룹으로 인식
- 게이트웨이 주소로 사용할 동일한 가상 IP도 각 장비에 설정
- 그룹 ID는 MAC 주소 생성에 쓰이므로 FHRP 장비는 동일한 가상 IP, MAC 주소 가짐

![](files/Pasted%20image%2020250512181811.png)

- 하단 호스트가 가상 IP 주소로 ARP 요청 보내면 브로드캐스트로 동일 네트워크의 모든 장비로 전달
- FHRP 그룹 장비 중 액티브 장비가 ARP 응답 보냄
- 덕분에 하단 서버는 FHRP 그룹 장비 중 액티브 상태의 장비를 게이트웨이로 인식해 다른 네트워크와 통신 가능

![](files/Pasted%20image%2020250512181926.png)

- 액티브 장비에 장애가 발생하면 스탠바이 장비는 액티브 장비가 비정상임을 확인 후 가상 IP 주소에 대한 액티브 역할을 가져옴
- 또한 가상 IP 주소에 대한 MAC 주소를 갱신해 하단 호스트들은 아무 설정 변경 없이 절체가 이루어짐
- 운영자 개입 없이 자동을 이루어져 하단 장비의 설정을 변경하지 않아도 됨

![](files/Pasted%20image%2020250512181936.png)

- 또한 이 절체는 장비 장애뿐만 아니라 게이트웨이 외부 인터페이스 상태도 감지해 외부 경로가 다운되면 게이트웨이의 액티브 역할을 스탠바이에게 넘겨줄 수 있음

- FHRP 기술 표준은 VRRP(Virtual Router Redundancy Protocol)
- 표준 프로토콜이므로 거의 모든 벤더 장비가 지원
- x86 리눅스에서도 패키지 설치해서 사용 가능

- 표준 외에도 각 벤더에서 자체 이중화 기술 구현하기도 함
- 가장 널리 알려진 건 시스코의 HSRP(Hot Standby Router Protocol)
- 자체 클러스터링 기술로 장비 IP 없이 가상 IP 한 개만 구성해 게이트웨이 이중화를 구현하기도 함

![](files/Pasted%20image%2020250512182045.png)

- 스위치 A, B로 VRRP 설정된 구성도
- VRRP 그룹을 만들기 위해서는 VRID 값을 사용
- 동일한 VRID를 설정한 장비가 하나의 그룹

- 스위치 A는 우선순위 110, B는 별도 설정 X -> 100

![](files/Pasted%20image%2020250512182151.png)

- VRRP 설정이 끝나면 마스터 선출을 위해 장비 간 Hello 패킷 주고 받음
- 기본 1초마다 Hello 패킷 전달, 우선순위 비교해 액티브가 될 마스터 장비 선정
- Hello 패킷 3회 이상 수신 못하면 비정상으로 간주해 자신이 마스터 장비가 됨
- Hello 패킷은 멀티캐스트 주소인 `224.0.0.18` 사용

![](files/Pasted%20image%2020250512182534.png)

- 위 예시에서는 A가 마스터가 됨
- 따라서 A가 가상 IP, MAC 주소를 가짐
- ARP 테이블을 확인하면 가상 IP와 MAC 주소가 A에서 광고되는 것을 알 수 있음
- 하단 장비는 가상 IP를 게이트웨이로 설정하고 스위치 A 장비가 게이트웨이가 됨

![](files/Pasted%20image%2020250512182604.png)

- A 인터페이스가 죽거나 장비에 문제가 생기면 B가 마스터 역할을 가져감
- 즉, 가상 IP, MAC 주소를 스위치 B에서 광고해 MAC 테이블이 갱신됨
- 가상 IP나 MAC 주소가 바뀐 건 아니니 ARP 테이블은 바뀌지 않음
- VRRP를 이용해 가상 IP와 가상 MAC 주소를 생성해 게이트웨이로 사용함으로써 게이트웨이 장비에 문제가 발생하더라도 하단 장비들이 서비스에 문제가 없도록 게이트웨이 이중화 구현 가능

- VRRP 마스터
```
interface Vlan10
  ip address 1.1.1.2/24                             ㆍ ㆍ ㆍ (1)
  vrrp 10                                           ㆍ ㆍ ㆍ (2)  
ip 1.1.1.1                                          ㆍ ㆍ ㆍ (3)
    priority 110                                    ㆍ ㆍ ㆍ (4)
track 1 decrement 20                                ㆍ ㆍ ㆍ (5)
preempt delay minimum 60                            ㆍ ㆍ ㆍ (6)

track 1 interface ethernet 1/1 line-protocol        ㆍ ㆍ ㆍ (5)
```

- VRRP 백업
```
interface Vlan10
  ip address 1.1.1.3/24
vrrp 10
ip 1.1.1.1
    preempt delay minimum 60
```

- preempt 옵션으로 우선순위가 바뀌더라도 owner를 즉시 가져오지 않고 일정 시간 동안 기다렸다가 owner를 가져오게 할 수 있음
	- 기본은 disable

- 같은 네트워크 안에서는 VRID가 중복되어서는 안 됨
	- 다른 네트워크는 상관 X
- Hello 패킷은 멀티캐스트 주소로 정해지므로 구분을 위해서 필요

- 왜 VRID 중복되면 안 되나?
	- 네트워크 통신에 사용되는 MAC 주소랑 관련있음
	- VRRP는 가상 IP 주소를 만들어 사용
	- 이때 가상 IP도 MAC 주소가 필요함
	- 가상 MAC 주소 만들 때 VRID 사용됨

```
00-00-5E-00-01-XX
```
- XX가 VRID 값
	- 10진수를 16진수로 바꿔서 씀
- 즉, VRID가 동일하면 서로 다른 VIP가 같은 MAC 주소를 지니게 됨

- 시스코의 FSRP도 동일한 방식으로 구현됨
	- 00-00-00-0c-07-AC-XX

- 255까지 설정할 수 있는 VRID와 달리 Priority는 254까지 가능
	- 255는 Owner를 의미하는 예약값

- 멀티 VRIP
	- 스위치 하나에 VRID 두 개 설정하고 하나의 스위치가 여러 VRRP 그룹에 속하게 하는 것도 가능

### 11.5.3 올 액티브 게이트웨이 이중화
![](files/Pasted%20image%2020250512213751.png)

- 가상 IP 주소는 액티브-스탠바이
- 즉, 스탠바이 경로를 거쳐도 트래픽은 항상 액티브 장비로 나감

![](files/Pasted%20image%2020250512213823.png)

- MC-LAG 이용해 게이트웨이 이중화 구성할 때도 액티브 장비를 통해야 하므로 트래픽이 우회해 통신한다.
- 이게 문제가 있는 건 아니지만 비효율적이긴 하다.

![](files/Pasted%20image%2020250512213912.png)

- 따라서 MC-LAG에는 가상 IP의 MAC 주소를 액티브 장비와 스탠바이 장비에서 모두 사용할 수 있도록 해 게이트웨이를 액티브-액티브 형태로 구성하는 기능을 제공한다.
- 이렇게 하면 트래픽 경로를 최적화할 수 있다.

### 11.5.3 애니캐스트 게이트웨이
- 위에서 본 액티브-액티브 게이트웨이는 네트워크가 한 위치에 존재할 때 게이트웨이를 이중화하는 방식
- 오버레이 기반의 SDN 네트워크 구현하면 같은 네트워크가 여러 위치에 존재하도록 네트워크를 디자인할 수 있다
- 이 경우 게이트웨이가 한 곳에 위치하면 모든 트래픽이 하나의 게이트웨이를 거치므로 비효율적이다
- 애니캐스트 게이트웨이로 각 위치에 같은 주소를 갖는 게이트웨이가 여러 개 동작하도록 만들 수 있다.

![](files/Pasted%20image%2020250512214101.png)

- 애니캐스트 사용해서 여러 개의 같은 IP를 갖는 게이트웨이가 존재하지만 가장 가까운 위치에 있는 게이트웨이가 응답하도록 한다
- 하나의 게이트웨이에 문제가 생겨도 랙 하나에서만 장애가 발생하고, 다른 위치에서는 외부로 통신하는 데 문제가 없다.

- 보다 안정적인 네트워크 구성을 위해 액티브-액티브 게이트웨이와 애니캐스트 게이트웨이를 함께 사용하기도 한다.

![](files/Pasted%20image%2020250512214140.png)

- 동일한 가상화 서버에 있는 가상 서버 간에도 서로 다른 네트워크를 갖고 있다면 가상화 서버 외부에 있는 게이트웨이를 거쳐야 한다.

![](files/Pasted%20image%2020250512214220.png)

- 동일한 스위치에 연결된 서로 다른 네트워크를 가진 서버끼리 통신할 때도 네트워크가 서로 다르므로 물리 서버든 가상 서버든 게이트웨이를 반드시 거쳐야 한다.

![](files/Pasted%20image%2020250512214256.png)

- 최근에 등장한 네트워크 가상화 망에서는 게이트웨이 역할을 가상화 서버 자체의 가상 스위치에서 수행하거나 각 ToR 스위치에서 수행하도록 해 트래픽이 우회하지 않고 더 빠른 경로로 통신하는 기능을 제공하고 있다.

- VMWare의 네트워크 가상화 솔루션인 NSX에서는 가상화 서버의 각 하이퍼바이저에 가상 라우터를 통해 각 서버 호스트별로 게이트웨이를 가짐
- 시스코의 ACI에서는 각 ToR 스위치에서 게이트웨이 역할을 수행

- 데이터 센터 내의 트래픽 경로를 최적화하는 것은 매우 중요
- 그러나 실제로 데이터 센터망을 설계할 때 트래픽 경로 최적화만 고려하지는 않는다
- 트래픽 경로의 보안 요건에 따라 보안을 어떻게 설계할 것인지도 매우 중요
- 따라서 VMWare NSX, 시스코 ACI 솔루션에서는 보안 측면을 고려해 가상화 호스트 내의 보안 설정이나 서비스 간의 보안 설정을 할 수 있도록 지원함
