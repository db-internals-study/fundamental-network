```toc
```

# 네트워크 디자인
- 네트워크를 구성하는 건 단지 두 호스트 간 통신이 가능한다고 끝나는 게 아니다
- 네트워크 디자인과 구성에 따라 호스트 간 통신 경로가 달라짐
- 이는 서비스 품질에도 영향을 미침
- 장애가 발생했을 때 서비스 영향 범위나 회복 시간도 달라지고
- 전체적인 인프라 보안에도 영향을 미침

## 13.1 2계층/3계층 네트워크
### 13.1.1 2계층 네트워크
![](files/Pasted%20image%2020250524192252.png)

- 호스트 간 통신이 직접 2계층 통신만으로 이루어지는 네트워크 디자인
- 즉, 동일한 네트워크
	- 게이트웨이를 거치지 않고 직접 호스트 간 통신이 가능한 구조

![](files/Pasted%20image%2020250524192258.png)

- 하나의 브로드캐스트 도메인
- 루프 구조가 생기면 안 되므로 STP를 사용해서 문제 해결

- STP로 인해 블록 포인트가 생기면서 전체 인프라의 대역폭을 사용하지 못하는 문제가 있음
- 이를 해결하려면 논블로킹 구조를 만들어야 함
- MC-LAG 등을 이용하면 루프를 제거하고 논블로킹 구조 구현 가능

### 13.1.2 3계층 네트워크
![](files/Pasted%20image%2020250524192600.png)

- 호스트 간 통신이 IP 라우팅과 같은 3계층 통신
- 라우팅으로 구성되어 루프 문제 발생하지 않음

- 전체 네트워크 인프라의 대역폭을 ECMP(Equal-Cost Multi-Path) 라우팅 기술을 이용해 모두 사용 가능
- 단, 서로 다른 네트워크에 연결되면 브로드캐스트로 상대방 호스트를 찾을 수 없어 이런 통신이 필요하면 이런 3계층 기반 디자인을 사용할 수 없음

![](files/Pasted%20image%2020250524192607.png)

- 단, VxLAN 같이 오버레이 네트워크 기술을 사용해서 하단 호스트 간에 동일한 네트워크를 사용하면서 네트워크 장비 간에 3계층 통신하도록 구성 가능
- 2계층 네트워크를 확장하면서 3계층의 장점인 루프 없이 전체 네트워크 대역폭을 모두 사용할 수 있게 해줌

- 이런 오버레이 기술은 VxLAN, GRE 같은 터널링 프로토콜 기반으로 동작

## 13.2 3-Tier 아키텍처
![](files/Pasted%20image%2020250524192800.png)

- Core-Aggregation-Access 3계층으로 이루어진 네트워크 아키텍처는 전통적인 디자인 기법임

- 호스트가 직접 연결된 액세스 계층의 스위치
- 액세스 스위치를 중간에서 집선하는 애그리게이션 스위치
- 코어 계층 스위치는 애그리게이션 스위치를 다시 모아 서로 통신

- 전통적인 데이터 센터, 일반적인 캠퍼스 네트워크 디자인 기법
- 지금도 많이 씀 

- 상위 레이어로 올라갈수록 집선되므로 높은 대역폭 필요
- 대역폭이 모자라면 병목 현상 발생 -> 업링크에서는 Oversubscription Ratio를 잘 산정해서 구성

- 서버 간 통신보다 사용자로부터 서비스 요청을 받고 서버에서 사용자 요청에 응답하는 North-South 트래픽이 대부분인 경우에 적합

## 13.3 2-Tier 아키텍처
### 13.3.1 스파인-리프 구조
![](files/Pasted%20image%2020250524193643.png)

- 최근에는 Spine-Leaf 2-Tier 디자인 기법이 많이 쓰임
- 하단 호스트가 연결되는 리프 스위치는 상단 스파인 스위치와 연결됨
- 전통적인 스패닝 트리 없이 모든 링크를 사용해 트래픽 전송

- 대용량 분산 처리 기술이 많이 급증한 요즘 데이터 센터 내부 서버 간 통신량이 급증
- 기존 구조는 East-West 트래픽이 많은 현대 네트워크에서 부하가 커지고 성능 지연이 발생할 수 있음
- 이를 보완하기 위해 3계층 아키텍처에서 스파인-리프 아키텍처로 네트워크 디자인 기법이 변하고 있음

- 스파인-리프 네트워크 디자인에서는 동일 리프 스위치에 호스트가 연결된 경우를 제외하면 모든 호스트 간 통신 홉이 동일
- 출발지 리프 스위치를 지나 스파인 스위치를 거쳐 목적지 리프 스위치로 트래픽이 흘러 네트워크 흐름에 대한 홉 수가 짧아지고 트래픽 흐름이 일정

![](files/Pasted%20image%2020250524193846.png)

- 왜 North-South에서 East-West 트래픽으로 트렌드가 변했는가
	- 서버 가상화
		- 서버 호스트 하나에 다수의 가상 머신
		- 서버 가상화를 사용하면 동일한 네트워크에 속한 서버들이 하나의 리프 스위치에 연결되지 않고 다양한 스위치에 연결
		- 동일한 서비스를 위한 서버들의 통신이 바로 옆에서 연결되지 못하고 스파인을 거쳐 통신이 되어야 함
		- 가상 머신은 하나의 호스트 내에 지속적으로 있는 게 아니라 가상 머신 마이그레이션 기술을 이용해 이동하므로 이 작업이 수행되면 대량의 트래픽이 데이터 센터 내에서 발생
	- 빅데이터 대중화
		- 분산 처리가 늘어남
		- 컨트롤 노드, 데이터 저장 노드 분리
		- 노드 간 서버 통신이 많음
		- Hadoop도 동일한 데이터를 기본적으로 3개 복사해서 데이터 노드에 저장 -> 대량의 트래픽이 데이터 센터 내에서 발생
	- 애플리케이션 아키텍처와 개발 방법의 변화
		- MSA 등 아키텍처 변화 -> 서버 간 통신 증가
		- 이런 아키텍처는 빈번한 배포가 가능한 VM, 컨테이너 같은 유연한 인프라 기반으로 이루어지므로 데이터 센터 내 트래픽 증가를 가속화

### 13.3.2 L2 패브릭
![](files/Pasted%20image%2020250524195001.png)

- 스파인-리프 구조에서 스파인-리프 사이를 2계층 네트워크로 구성
- 이를 위해서는 TRILL(TRansparent Interconnection of Lots of Links)이나 SPB(Shortest Path Bridging) 같은 프로토콜 사용
- 일반적인 2계층 구조에서는 루프 제약으로 모든 링크를 쓸 수 없지만 TRILL이나 SPB에서는 이런 문제를 해결 가능

- 시스코의 Fabric Path나 익스트림의 VCS Fabric 같은 기술도 위와 같은 맥락

### 13.3.3 L3 패브릭
![](files/Pasted%20image%2020250524195214.png)

- 스파인-리프 구조에서 스파인과 리프 사이를 3계층 네트워크로 구성
- 스파인과 리프가 연결된 링크는 각각 라우팅이 활성화되어 있고, 일반적인 라우팅 프로토콜로 경로 정보 교환
- 라우팅이므로 별도 기술 없이 루프를 제거하고 ECMP를 통해 모든 링크를 사용

 - 하단 호스트의 네트워크가 리프 간에 서로 다른 네트워크를 가짐
 - 동일한 네트워크가 필요할 때는 VxLAN과 같은 오버레이 네트워크 기술을 이용해 상단에 L3 패브릭으로 구성된 스파인-리프 구조에서도 리프 하단의 L2 네트워크를 확장해 동일한 네트워크를 가질 수 있음

- 이런 환경은 가상화 서버의 라이브 마이그레이션 같은 서비스를 위해 사용됨
- 오버레이 기술을 사용하면 IP 이동이 보장되는 네트워크 구성

## 13.4 데이터 센터 Zone/PoD 내부망/DMZ망/인터넷망

![](files/Pasted%20image%2020250524195435.png)

- 데이터 센터를 설계할 때는 다양한 구성 요소와 역할을 고려해야 함
- 하나의 큰 망 안에서 다양한 역할을 모두 수행할 수도 있지만, 보안이나 관리상 이유로 용도별로 데이터 센터망을 분리해서 설계
- 분리된 망은 용도별로 나뉘어져 있어 망 간 보안을 고려해 방화벽과 같은 보안 장비와 연동해서 구성 

### 13.4.1 인터넷망
- 외부 인터넷에서 사용자가 데이터 센터에 접근할 수 있도록 구성된 영역
- ISP에서 인터넷 회선을 받아 연동됨

- 소규모 데이터 센터는 ISP에서 IP를 할당받아 인터넷에 쉽게 연결
- 어느 정도 규모가 있는 데이터 센터는 ISP와 연동할 때 BGP 프로토콜을 이용하고, 별도의 AS 번호를 가지고 있음

- 단일 회선을 가지고 있더라도 자신이 소유한 IP를 사용하려면 AS 번호를 할당받고, BGP 프로토콜을 이용해 ISP에 연결

- 규모가 커지면 서비스 안정성을 위해 ISP 연결을 이중화, 삼중화

### 13.4.2 공인망(DMZ)
- 데이터 센터에서 외부 사용자에게 직접 노출되는 웹 서비스 등의 서버들이 모인 망
- 공인 IP가 사용됨
- 공인망이라고 부르거나, 서비스망이라고도 부름

- Untrust 네트워크인 데이터센터 외부의 인터넷 구간과 Trust 네트워크인 데이터 센터 내부망의 연결 지점
- -> DMZ라고 부름

### 13.4.3 내부망(사내망/사설망)
- 데이터 센터 내부나 사내에서만 접근 가능
- 사설 대역 IP로 구성 -> 인터넷을 통한 외부망에서는 직접 접근 불가능

- 외부망과 통신할 때는 사설 IP로 통신할 수 없으므로 외부망으로 나가려면 중간에 공인 IP로 변환해주는 NAT가 필요
- 원격지에 있는 내부망 간 연결은 VPN이나 전용선으로 연결

### 13.4.4 데이터베이스망
- 보안을 위해 내부망에 데이터베이스망을 별도로 두기도 함
- 내부망에서 접근할 때 추가로 방화벽을 두고, 별도 망을 구성하기도 함
- 접근 통제 시스템을 두기도 하고

### 13.4.5 대외망
- 회사 대 회사 서비스 연동이 필요한 경우, 인터넷망을 통해 연동할 수도 있지만 별도 전용선이나 VPN을 이용해 서비스를 연동하기도 함
- 금융 서비스처럼 보안이 더 필요한 경우, 전용 회선과 VPN을 동시에 사용하기도 함

- 대외사 연동을 위해 별도 망으로 분리하기도 함. 항상은 아니고
- 대외사와 연동된 지점에서 사내로 접근할 때 최소한의 접근만 허용하기 위해서

### 13.4.6 관리망/OoB(Out of Band)
- 장비 자체를 관리하기 위한 별도 인터페이스를 제공하기도 함
- 네트워크 관리망은 장비 운용을 위한 CLI나 웹 접속을 위해 사용
- 일반 서비스망으로도 장비에 접근할 수 있어 관리망과 별도 서비스망 접근에는 큰 차이가 없음
- 단, 서비스망에 문제가 생기더라도 관리망은 접근 가능하게 하기 위해서 별도 망으로 분리

- 서버 관리망은 일반적인 서비스망과 다름
- 하드웨어 자체를 관리하기 위한 별도의 환경

- 네트워크 장비에서는 관리용 포트를 보통 mgmt 인터페이스라고 부름
- 벤더마다 다르기도 함
	- HP: ILO
	- DELL EMC: iDRAC
	- IBM: IMM
	- CISCO: CIMC
	- Fujitsu: IRMC
	- Supermicro: iKVM

## 13.5 케이블링과 네트워크
- 데이터 센터에는 많은 랙이 있음
- ToR와 EoR은 데이터 센터 내에서 스위치와 서버 간 케이블링 구성 방식에 따라 구분
### 13.5.1 ToR
![](files/Pasted%20image%2020250524202911.png)

- 서버와 스위치가 동일한 랙에 있음
- 개별 랙 내 케이블링은 간단하지만 전체적으로는 복잡성 증가
- 단, 스위치가 많이 필요함 -> 관리 사항이 늘어남
- 전력, 냉각 비용 추가 -> 운영 비용 증가
- 랙별로 사전에 스위치 구성 -> 미사용 중인 포트가 늘어 포트 집적도가 떨어짐

### 13.5.2 EoR
![](files/Pasted%20image%2020250524202918.png)

- 랙이 있는 행 끝에 네트워크 장비를 두고, 케이블로 연결
- 즉, 서버 랙과 네트워크 장비 랙을 분리
- 대형 섀시(Chassis) 스위치에서 라인 카드를 추가하는 방식으로 포트 증가
- ToR보다 필요한 스위치 수가 줄어든다
- 관리하는 장비 수, 통과하는 스위치 수가 줄어들어 대기시간이나 지연에 유리

- 단, 케이블 구성이 멀어져 복잡도 증가, 긴 케이블이 필요
- 케이블 구축 비용 증가, 서버와 스위치 간 인터페이스를 업그레이드해야 하는 경우 케이블 교체 비용 증가

### 13.5.3 MoR
![](files/Pasted%20image%2020250524202901.png)

- Middle of Row
- EoR처럼 서버와 네트워크 장비를 분리
- 단, 네트워크 장비 랙을 중간에 두는 경우
- 케이블 길이가 전반적으로 감소