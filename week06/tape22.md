### 4계층 장비

앞서 스위치나 라우터같은 2,3계층 장비과 달리 4계층 네트워크 장비는 통신의 방향성이나, 순서와 같은 통신에 대한 전반적인 관리를 담당한다.

- 이런 장비는 port 번호, 시퀀스 번호, ack번호에 대한 이해가 있어야하며
- 세션 테이블에 정보를 저장하고 이 정보를 기반으로 동작한다.

4계층 장비를 2,3계층 장비처럼 설계하거나 운용하면 여러 문제가 발생할 수 있어서 기존 네트워크 장비와는 다른 점을 고려해야하는데

세션 테이블과 세션 정보가 이에 해당하며, 이런 특징 때문에 4계층 이상에서 동작하는 로드밸런서, 방화벽 같은 장비를 ‘세션 장비’라고 부르기도 한다.

세션 장비는 추가로 고려해야할 특징들이 있는데, 그중에서 우선적으로 고려해야할 요소들은 다음과 같다.

1. **세션 테이블**
    - 세션 정보를 저장하고 확인하는 작업 전반에 대한 이해가 필요
    - 세션 테이블에 남아있는 라이프타임을 고려해야함
2. **symmetric(대칭) 경로**
    - inbound와 outbound 경로가 일치해야함
    - 비대칭의 경우 세션 상태정보가 없어서 패킷이 정상적으로 전달되지 않을 수 있음.
3. **정보 변경**
    - 로드밸런서의 경우 ip 주소가 변경되며 확장된 L7 로드밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경됨

---

### 로드밸런서

- 트래픽을 분배해주는 기능이 있어 서버나 장비의 부하를 분산하기 위해 사용되는 장비를 로드밸런서라고 한다.
- 4계층 이상에서 동작하면서 ip 주소나 4계층 정보, application 정보를 확인 및 수정하는 기능을 수행한다.
- 일례로 웹 서버의 부하분산을 들 수 있다.
    - 작은 장비 여러 대를 묶어서 운영하는 방식이 비용 효율적임 -> 스케일아웃
    - 여러 대를 운영하더라도 서비스를 사용하는 입장에서는 하나의 서비스로 제공을 받아야하므로, 대표 ip 주소를 기반으로 로드밸런서가 각 서버의 실제 ip로 변경하여 요청을 보내는 방식으로 동작한다.
    - 이런 로드밸런서는 웹 애플리케이션 뿐 만 아니라 FWLB (방화벽 로드밸런싱), VPNLB (VPN 로드밸런싱)에도 활용된다.

> FWLB 와 VPNLB
> 
> - FWLB는 로드밸런서 뒤에 이중화된 방화벽들을 두어서 고가용성을 보장함.
>     - 외부 로드밸런서 → 방화벽 (트래픽 필터링) → 내부 로드밸런서 의 개념
> - VPNLB는 VPN 서버에 들어오는 사용자 트래픽을 분배함.
> 
> https://www.relianoid.com/resources/knowledge-base/misc/what-is-firewall-load-balancing-fwlb/#prettyphoto/0/

<img width="686" alt="Screenshot 2025-04-03 at 5 50 41 PM" src="https://github.com/user-attachments/assets/af2d3548-c1a7-45da-8a09-fb2daf192b89" />

로드밸런서의 경우는 어느 계층에서 동작하느냐에 따라 L4,L7로 나뉜다.

(*실제 데이터센터에서 사용하는 로드밸런서 장비는 L4,L7를 모두 지원하고 설정값에 따라 나뉘지만, 클라우드에서 제공하는 로드밸런서는 컴포넌트가 구분되어있다.)

1. L4 로드밸런싱 (NLB)
    - TCP, UDP 정보를 기반으로 4계층 정보로만 분산 처리하는 경우
2. L7 로드밸런싱 (ADC / ALB)
    - HTTP, FTP, SMTP 와 같은 애플리케이션 프로토콜 정보 기반으로 로드밸런싱 수행한다.
        - HTTP 헤더나 URI 정보를 바탕으로 프로토콜을 이해하고, 부하를 분산함.
        - proxy 역할을 수행하는 셈
 
---

**ADC(Application Delivery Controller)의 개념**

- 애플리케이션 계층에서 동작하는 로드밸런서로, 다양한 부하분산, 정보수정, 정보 필터링이 가능하다.
- 대부분의 ADC 는 4계층부터 애플리케이션 계층까지 로드밸런싱 기능을 제공하고, failover나 리다이렉션 기능도 함께 수행한다.
    - 세션 중간에 서버에 문제가 생겨도 기존 세션 정보를 유지할수도 있고, 애플리케이션 수준에서 부하를 고려해서 라우팅도 가능해짐.
- 또한 캐싱, 압축(compression), 인코딩 변환, 콘텐츠 변환 및 재작성 등이 가능하고 프로토콜을 최적화할 수도 있다.
- 플러그인 형태로 보안을 강화할 수 있으며 WAF(web application firewall) 기능이나 html, xml 검증도 수행할 수 있다.


**L4 스위치**
    - 4계층에서 동작하면서 로드밸런서 기능이 있는 스위치
    - 내부 동작은 4계층 로드밸런서이지만, 여러 개의 port를 가지고 있다.
    - 부하를 분산하고, 성능을 최적화하며, 리다이렉션 기능도 함께 수행한다.
    - TCP, UDP 헤더 정보 기반으로 동작하다보니 연결 실패를 감지해서 대체경로를 찾는 기본적인 failover 정책은 있으나, L7가 세션 정보 바탕으로 failover하는 것만큼은 지원하지는 못하는 편.

  
 ```
=> L4 스위치는 가상서버와 리얼서버가 있는 설정환경에서, virtual IP를 real IP로 변경해주는 역할을 수행한다.
- 가상서버와 가상IP는 사용자가 실제로 접속하는 서비스와 ip주소이고
- real 서버와 real ip는 실제 서비스를 수행하는 주체로 보면 된다.
```

#### L4 스위치와 ADC의 차이?

- `L4 스위치` 는 TCP, UDP 정보 기반으로 부하분산과 더불어 TCP 계층에서의 최적화와 보안 기능도 제공
    - TCP레벨의 간단한 Dos 공격을 방어하거나,
    - TCP 세션 connection pool을 사용해서 세션을 재사용하는 방식으로 서버 부하를 줄이고 성능을 향상하기도 한다.
- `ADC` 의 경우는 애플리케이션 성능 최적화를 위해 부하가 많이 걸리는 작업을 별도로 수행함
    - 이는 이미지나 정적 콘텐츠를 캐싱해서 성능을 최적화하기도 함
    - 혹은 컨텐츠를 압축해서 하드웨어 가속이나 소프트웨어 최적화를 통해 부하작업을 최적화하는 기능이 있다.
    - client-ADC 구간만 SSL 로 처리하고 서버는 http로 통신해서 암복호화 부하를 감소하는 기능도 있다.

---

### 방화벽

네트워크 중간에 위치해 정책 조건에 맞추어 트래픽을 허용(permit)하거나 차단(deny)하는 장비

- 3,4 계층에서 세션을 인지, 관리하는 SPI(Stateful Packet Inspection) 엔진 기반으로 동작하는 장비를 방화벽으로 부름.
    - stateless 로 필터링하면, 단순하게 패킷 정보 기반으로만 필터링한다.
    - SPI (stateful inspection) 은 각 세션의 상태정보를 확인하고 패킷이 정상적인지를 검토하고 필터링한다.

NAT 동작방식과 유사하게 세션 정보를 저장하며, 패킷이 외부로 나갈때 세션 정보를 저장하고 들어오면 해당 세션 정보를 참조해 요청이 어디서부터 시작되었는지 판단한다.

- 상태 정보가 없으면 양방향으로 정책을 설정해야하는데, 이렇게 세션 정보를 관리하면 나가는 패킷만 허용하고 내부로 들어오는 패킷은 차단해서 정책을 보다 간단하게 관리할 수 있음.
    - 패킷을 로깅하고 모니터링까지 가능
 

---


### 4계층 장비를 통과할 때 유의점(세션 관리)
세션 장비는 테이블 정보를 이용해 패킷을 포워드하거나 드롭해서 패킷을 변경, 보안을 강화할 수도 있다.
다만 이 기능을 잘 활용하려면, 애플리케이션과 세션 장비 간 세션 정보를 동일하게 유지해야하고 세션 시간과 서비스의 방향성을 고려해야한다.

#### 1. 세션 테이블을 유지하고, 정보를 동기화

- 종단 장비에서 통신을 시작하면 중간에 있는 세션 장비는 세션 테이블에 기록하고, 적당한 세션 타임아웃 시간동안 데이터를 유지함.
    - 메모리 사용률을 관리하고, 세션 공격으로부터 보호하기 위함
- 하지만 장비의 세션 타임아웃이 application 세션 타임아웃보다 짧으면 application 입장에서는 통신을 유지하고 있는데, 세션 테이블에는 정보가 없어 패킷이 drop 됨

그래서 세션 장비 운영자 입장에서는 아래와 같이 적용하여 문제를 방지한다.

- 세션 만료 시간을 증가시켜서 application 보다 방화벽 세션 유지 시간을 길게 설정
    - port번호나 ip 주소마다 별도의 세션 만료시간을 설정할 수 있으나, 애플리케이션 개발자 측에서 세션 유지시간을 알려줘야한다는 번거로움
- 세션 테이블 정보에 없는 ack 패킷이 들어오면, 세션을 새로 만들어서 통과시킬 수 있는 옵션을 설정
    - 하지만 보안이 취약해지기 때문에 적용하지 않는 것이 좋다.
- 세션 장비에서 타임아웃이 발생하면, **세션 정보에 있는 양 종단장비에 정보가 만료되었다는 정보(RST) 를 통보한다.**
    - TCP RST flag를 1로 설정해서 전송하면, 타임아웃으로 인해 종료된 것을 확인하고 각각 애플리케이션은 세션을 끊게된다. 그리고 필요 시 다시 세션을 맺어서 통신하는 구조

개발자 입장에서는 애플리케이션에서 주기적으로 패킷을 발생하는 기능을 추가해서 애플리케이션과 세션 장비 간의 타임아웃 시간을 동기화할 수 있다.

- **중간에 통신이 없는 구간이어도 주기적으로 패킷을 발생시켜 세션 상태정보를 체크하는 dummy packet을 보내는 방법**
- 세션을 유지하기 위한 이 방법으로 애플리케이션 상태를 체크하는 헬스체크 패킷도 구현 가능해진다.

  ---
#### 2. 비대칭 경로문제

하지만 네트워크 안정성을 높이기 위해 회선과 장비를 이중화하다보면, 패킷이 지나가는 경로가 2개 이상이므로 inbound와  outbound 패킷경로가 다를 수도 있다.

inbound, outbound 패킷이 동일한 장비로 통과하면 대칭 경로이지만, 다른 장비를 통과하면 비대칭 경로(symmetric path)라고 부른다.

다만 패킷이 들어오고 나가는 경로가 일정하게 유지되지 않으면 정상적으로 서비스되기 어렵기 때문에, 비대칭 경로를 사용하지 않도록 디자인하는 것이 중요하다. 하지만 어쩔 수 없이 비대칭 경로가 생기면 세션 장비에서 보정하는 방법을 사용해야한다.

- 장비 간의 세션 테이블을 동기화해서 패킷 경로를 변경하지 않고도 하나의 장비의 경로처럼 동작할 수 있음
    - 하지만 세션을 동기화하는 시간보다 패킷 응답이 빠르면 통과되지 않음
    - 비교적 응답시간이 긴 인터넷 게이트웨이 방화벽에서 유용하게 쓰일 수 있음
- 세션 장비에서 비대칭 경로를 보정하는 방법들을 사용
    - 인바운드 패킷이 없는데 아웃바운드 패킷이 들어온 경우, 인바운드 패킷이 통과한 다른 세션 장비 쪽으로 패킷을 보내서 경로를 수정
    - 다만 강제로 다른 방화벽 장비로 패킷을 보내야하기 때문에 통신용 링크가 필요하고,mac 주소를 변경하는 rewriting, 기존 패킷에 mac 주소를 한 번 더 incapsulation하는 터널링 기법을 사용해야한다.
 
---

#### 3. 하나의 통신에 두 개 이상의 세션이 사용될 때 고려사항

프로토콜은 원래 하나의 통신에 하나의 세션을 사용하는 경우가 대부분이지만, 특별한 목적으로 두 개 이상의 세션을 만드는 경우가 있다.

통신장비도 한 통신에 두 세션이 있다는 것을 파악하고 있어야하는데,

둘 중 한쪽의 세션이 끊겨있거나 세션 테이블에서 삭제되면 단방향만 되거나 통신이 안될 수 있으므로 주의해야한다.

- **FTP(File Transfer Protocol)**
    - 데이터 프로토콜 : 데이터를 싣는 역할
    - 컨트롤 프로토콜 : 데이터가 잘 전송되도록 세션을 제어하는 역할

=> 보통은 하나의 프로토콜에서 헤더나 별도의 메시지로 해결하지만, FTP는 완전히 분리되어있고, 두 가지 모드를 갖고 있다.

- **Active 모드**
    - (컨트롤 프로토콜) 클라이언트 -> 서버로 어떤 port를 사용해서 수신하겠다고 알리면
    - (데이터 프로토콜) 서버는 해당 port로 클라이언트로 데이터를 푸시 (data push)
    - 클라이언트는 데이터를 받았으면 응답
    - <img width="432" alt="Screenshot 2025-04-03 at 5 56 20 PM" src="https://github.com/user-attachments/assets/e9f31bfb-2555-40b4-939d-7f0cb3570e01" />
    - active 모드일 때는 방화벽의 반대방향도 열어주어야함.
    - 외부에서 port로 데이터 수신하겠다고 들어오는 셈이니까, 방화벽 입장에서는 임의의 port로 서버에 연결을 시도하는 셈이어서 보안정책에 다 적혀있지 않으면 차단된다.
- NAT 환경일 때는 **ALG(Application Layer Gateway)와** 같이 FTP 명령어를 이해하고 새로운 연결 정보를 세션 테이블에 등록해주는 기능을 통해,
- 반대방향으로 시작하는 데이터 세션을 인지해서 방화벽과 NAT를 자동으로 동작시킨다.


- **Passive 모드**
    - 클라이언트가 passive 모드를 사용하겠다고 알리면, **서버에서 데이터 수신에 사용할 port를 알림.**
    - 클라이언트에서 서버에 데이터를 요청해서 전송을 받는다.
    - 클라이언트 쪽에 방화벽이나 세션 장비가 있는 경우 특별한 처리 없이 동작할 수 있지만
    - 서버 쪽에 방화벽이 있으면 다운로드를 받기 위한 추가 포트를 열어주어야함.
        - 서버가 클라이언트에게 동적으로 port를 골라서 열었기 때문에 방화벽 정책에 없으면 추가로 작업해야한다는 의미.
        - <img width="417" alt="Screenshot 2025-04-03 at 5 57 20 PM" src="https://github.com/user-attachments/assets/18508738-1205-483a-a83b-65bfeedf6407" />
