# 로드 밸런서

## 부하 분산이란?

서비스를 위한 VIP를 하나 제공하고 동일한 가상 IP를 통해 서버로 접근

서버의 서비스 상태도 체크

***FWLB***

방화벽을 액티브-액티브 구성하기 위해 LB를 사용하기도. 비대칭 동작이 발생할 수 있는데, 이를 방지
FWLB를 사용해도 방화벽 장애가 발생하는 경우를 대비하기 위해 추가 설정을 하기도 함

## 부하 분산 방법

RIP(Real IP) 여러개가 VIP에 binding되는 구조

## 헬스 체크

- ICMP : 서버가 살아있느지만 체크
- TCP 서비스 포트 : SYN - SYN ACK - FIN
- TCP 서비스 포트 Half Open : SYN - SYN ACK - RST
- HTTP 상태 코드 : 웹서비스 확인
- 콘텐츠 확인 : 문자열 체크를 통해 확인

타이머도 함께 사용하는데 주기/응답 시간/시도 횟수/타임아웃/서비스 다운 시의 주기 등으로 확인

## 부하 분산 알고리즘
- 라운드 로빈
- 최소 접속 방식
- 가중치 기반 라운드 로빈
- 가중치 기반 최소 접속 방식
- 해시

## 로드 밸런서 구성 방식

로드 밸런서 위치에 따라 One-Arm(중간 스위치 옆, 부하분산 트래픽만 LB 경유)과 Inline(경로 상에 로드밸런서가 연결, 모두 경유)으로 나뉨

***물리적 원암, 논리적 인라인***

물리적으로는 원암 구성을 띠더라도 실제로는 인라인 구성인 경우도 있음.

VRF, VLAN을 이용해서 구성이 가능. 물리적 구상만 보고 원암 / 인라인 구성을 구분하면 안 됨

## 로드 밸런서 동작 모드

- 트랜스패턴트(TP) 또는 브릿지(Bridge) : 네트워크에 L2 스위치 넣는 것처럼 동작. VIP와 실제 서벅가 같은 네트워크를 사용. 원암/인라인 둘 다 가능
- 라우티드(Routed) : 로드밸런서가 라우팅 역할. 사용자 방향 / 서버 방향이 서로 다른 네트워크로 분리. 원암/인라인 구성 모두 가능
- DSR(Direct Server Return) : 사용자의 요청 패킷에만 LB가 관여. DSR은 응답 시 LB 경유가 없기 때문에 원암. 실제 서버까지의 통신이 L2면 L2 DSR, L3면 L3 DSR. 추가 서버 설정이 필요(루프백 IP여도 패킷 수신이 가능하게)

## 로드 밸런서 유의 사항

### 원암 구성의 동일 네트워크 사용 시

서비스, 서버 네트워크가 동일하면 : VIP가 아닌 RIP의 응답을 받으면서 패킷을 폐기

해결책

- 게이트웨이를 LB로 설정해 해결 :외부 사용자의 호출에 대한 응답이 항상 LB를 통하도록 하면 정상 응답 가능. 단, 부하 감소 효과가 줄어듦
- Source NAT 사용 :LB에서 Source IP를 VIP로 바꾸고, 응답이 LB를 거쳐가게 함. 단 서버 애플리케이션에서는 유저 구분이 어려움
- DSR 모드

### 동일 네트워크 내에서 VIP 호출

VIP를 호출했는데, 다른 서버가 직접 응답하면서 생기는 이슈 : SNAT 혹은 DSR 모드를 사용하기 등 방법 다양

### HA Proxy
