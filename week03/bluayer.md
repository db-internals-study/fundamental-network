# Chapter 3. 네트워크 통신하기

## 3.1 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트

- 유니캐스트
  - 1:1 통신
  - 출발지와 목적지가 1:1 통신
- 브로드캐스트
  - 1:모든 통신
  - 동일 네트워크에 존재하는 모든 호스트가 목적지
- 멀티캐스트
  - 1:그룹 통신
  - 하나의 출발지에서 다수의 특정 목적지로 데이터 전송
- 애니캐스트
  - 1:1 통신
  - 다수의 동입 그룹 중 가장 가까운 호스트에서 응답
  - IPv4에서는 일부 기능 구현, IPv6는 모두 구현 가능
  - 가장 가까운 게이트웨이를 찾는 기능에도 사용
    - Kakao https://tech.kakao.com/posts/307

**BUM(Broadcast, Unknown Unicast, Muticast) 트래픽** -> 불필요한 트래픽이 많아지면 네트워크 성능 저하 but, 이더넷 환경에서는 ARP 브로드캐스트를 먼저 보내고 통신하기 때문에 BUM 트래픽이 많이 발생하지 않음

## 3.2 MAC 주소

2계층에서 통신을 위해 NIC에 할당된 고유 식별자 (이더넷, 와이파이 포함한 IEEE 802 네트워크 기술에서 사용)

## MAC 주소 체계
- 변경할 수 없도록 하드웨어 고정되어 출하
- 48비트 16진수 12자리 -> OUI 24비트, UAA 24비트. OUI는 IEEE가 할당
- BIA(Burned-In Address)라고도 부름

## MAC 주소 동작
패킷으로 변환하여 도착지 MAC 주소 확인

**무차별 모드 (Promiscuous Mode)**
다른 목적지를 가진 패킷을 분석하거나 수집해야하는 경우, 무차별 모드로 NIC를 구성함.
자신의 MAC 주소와 상관없는 패킷이 들어와도 이를 분석할 수 있도록 메모리에 올려 처리할 수 있게 함 (Wireshark)

## 3.3 IP 주소
3계층 주소 특징
1. 사용자가 변경 가능한 논리 주소
2. 주소에 레벨이 있음. 그룹을 의미하는 네트워크 주소와 호스트 주소로 나뉨

### IP 주소 체계
IPv4 : 32비트 / IPv6 : 128비트

- 네트워크 주소 : 네트워크 주소가 동일한 네트워크를 로컬 네트워크라고 함
- 호스트 주소 : 호스트 구분하기 위한 주소

네트워크, 호스트 주소를 구분하는 경계점이 고정되어 있지 않음.
필요한 호스트 IP 개수에 따라 네트워크 크기를 다르게 할당할 수 있는 Class 개념을 도입
현재는 사용하지 않고 있음. 현재는 더 세밀하게 분할, 할당하기 위해 1 bit 단위로 네트워크를 상세히 분할
- A 클래스 : 약 1600만 개
- B 클래스 : 약 65000개
- C 클래스 : 약 250개

***IP 체계에서 맨 앞의 숫자를 네트워크 주소로, 맨 뒤의 숫자를 브로드캐스트 주소로 사용하기 때문에 각 클래스에서 -2해야 함***

### 클래스풀과 클래스리스

IP 주소 부족과 낭비 문제
1. 단기 대책 : 클래스리스(CIDR)
2. 중기 대책 : NAT, private IP
3. 장기 대책 : IPv6

네트워크 주소와 호스트 주소의 경계점/구분자 -> 서브넷 마스크
255.0.0.0 == /8
255.255.0.0. == /16
255.255.255.0 == /24

### 서브네팅(Subnetting)
- 네트워크 사용자 입장 : 네트워크에서 사용할 수 있는 IP 범위 파악
- 네트워크 설계자 입장 : 네트워크 범위 설계

### 네트워크 사용자 입장
유효 범위 파악
1. 내 IP를 2진수로 표현
2. 서브넷 마스크를 2진수로 표현
3. 2진수 AND 연산으로 서브네팅된 네트워크 주소를 알아낸다
4. 호스트 주소 부분을 2진수 1로 모두 변경해 브로드캐스트 주소를 알아낸다
5. 유효 IP 범위를 파악한다. 서브네팅된 네트워크 주소 +1은 유효 IP 중 가장 작은 IP다
6. 브로드캐스트 주소-1은 유효 IP 중 가장 큰 IP다
7. 2진수로 연산되어 있는 결괏값을 10진수로 변환한다

### 네트워크 설계자 입장
- 서브넷된 하나의 네트워크에 몇 개의 IP를 할당해야 하는가?
- 서브넷된 네트워크는 몇 개 필요한가?

잘 설계된 네트워크는 관리하기 쉽고, 네트워크 장비 성능도 향상됨.

### Public IP와 Private IP

사설 네트워크 -> NAT -> Public IP -> 인터넷

**IANA가 여러 목적으로 예약해두어 공인 IP로 할당하지 않는 주소 Bogon IP**

## 3.4 TCP와 UDP

정확한 주소 제공이 목적인 2, 3계층과 다르게 4계층은 1/ 목적지 프로세스를 정확히 찾아가고, 2/ 패킷 순서가 바뀌지 않도록 조합해 3/ 원래 데이터를 잘 만드는 것이 목적
포트 번호를 Source, Destination으로 구분해서 사용

### TCP
"신뢰할 수 없는" 공용망에서도 정보 유실 없는 통신을 보장하기 위해 분할 및 잘 전송되었는지 확인 (w/ Sequence, Ack, Window size)
SYN -> SYN, ACK -> ACK

#### 윈도 사이즈와 슬라이딩 윈도

ACK 번호를 확인하고 다음 패킷을 전송. 보통은 뭉쳐서 보내게 됨.
적절한 송신량을 정하기 위해 윈도 사이즈를 조절해서 보내게 됨.

데이터에 유실이 발생하면 윈도 사이즈를 절반으로 떨어뜨리고 정상적인 통신이 되는 경우 서서히 하나씩 늘림

#### 3way handshake

헤더에 TCP 플래그를 통해 현재 상황 파악
- SYN
- ACK
- FIN
- RST
  연결 종료 시 1로 표시. 강제 종료를 위해 연결을 일방적으로 끊을 때 사용
- URG
  - 긴급 데이터인 경우, 1로 표기
  - (별도의 추가 로직, 메커니즘 등이 있어서 일반적으로 비추천한다고 하는데...)
- PSH
  서버 측에서 전송할 데이터가 없거나 데이터를 버퍼링 없이 응용 프로그램으로 즉시 전달할 것을 지시하는 경우

### UDP

UDP 헤더 : 발신지, 목적지 포트 / 길이 / 체크섬

첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용하고 유실

## ARP (Address Resolution Protocol)

상대방의 MAC 주소를 알아내기 위해 (브로드캐스트해서) 사용되는 프로토콜, IP 주소 체계와 MAC을 연결시켜주는 프로토콜

패킷을 보낼 때마다 ARP 브로드캐스트를 하는 것이 아니라, 메모리에 저장해두고 재사용 (일반적으로 CPU에서 직접 수행하기 때문에 큰 부하)

### ARP 동작

송신자 MAC, IP, 대상자 MAC, IP를 사용

1. ARP 요청을 브로드캐스트
2. ARP 프로토콜 필드의 대상자 IP가 자신이 아닌지 맞는지 확인
3. 대상자는 자신의 MAC, IP를 송신자 주소로 채워서 원래 송신자에게 전달 (유니캐스트)
4. ARP 캐시 테이블 갱신

### GARP
Gratuitous ARP의 약자.

대상자 IP 필드에 자신의 IP 주소를 채워 ARP 요청을 보냄 -> 자신의 IP, MAC 주소를 알리는 용도

1. IP 주소 충돌 감지 : 다른 사용자가 나랑 같은 IP를 사용하고 있는가?
2. 상대방의 ARP 테이블 갱신 : 스탠바이 장비가 액티브 상태로 올라왔을 때, 네트워크 장비에게 알려주기 위해 GARP 패킷을 보냄 (HA 용도)
3. HA 용도의 클러스터링, FHRP, First Hop Redundancy Protocol, (VRRP, HSRP) : 디폴트 게이트웨이 장비 장애를 대비해 두대의 라우터가 한대처럼 동작할 수 있게 해줌

### RARP
IP 주소가 정해져 있지 않은 단말이 IP 주소를 요청할 때 사용. BOOTP, DHCP로 대체되어 사용되지 않음

## 서브넷과 게이트웨이

다른 LAN과의 통신에 사용하는 장비 게이트웨이(3계층 장비, 라우터 & L3 스위치)

ARP 브로드캐스트는 원격지 네트워크로 보낼 수 없기 때문에 게이트웨이를 거쳐감.

서브넷 마스크를 통해 자신이 속한 네트워크의 범위인지 확인하는 작업이 필요

**프록시 ARP** : 게이트웨이가 대신 답변. 단, 장애가 발생했을 때 쉽게 해결하기 어려운 요소가 되기도 함.

### 2계층 통신 vs 3계층 통신 (로컬 네트워크 통신 vs 원격지 네트워크 통신)

