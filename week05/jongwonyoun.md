# 5장 라우터/L3 스위치 : 3계층 장비

- 라우터는 3계층에서 동작하는 여러 네트워크 장비의 대표. 경로를 지정해줌
- 패킷의 목적지 IP를 보고 자신이 가진 경로 정보를 가지고 최적의 경로로 포워딩
- 원격지 네트워크 연결에 필수


- 라우터? L3 스위치?
    - 스위치는 2계층 장비지만 라우터처럼 3계층에서 동작하는 L3 스위치라고 부르는 장비도 많이 쓰인다
    - 기존에는 라우터는 소프트웨어로 구현하고, 스위치는 하드웨어로 구현하는 형태로 구분하거나 다양한 기능의 라우터와 패킷을 빨리 보내는 데 최적화된 스위치로 구분했지만 최근은 기술의 발달로 구분이 어렵다
    - 이 장에서는 라우터로 설명하지만 L3 스위치도 동일하게 적용된다

## 5.1 라우터의 동작 방식과 역할

- 도착지 IP 주소와 라우팅 테이블 비교 후 최선의 경로로 보냄 -> 경로 지정
- 스위치와 달리 라우터는 들어온 패킷의 목적지 주소가 라우팅 테이블에 없으면 버린다 -> 브로드캐스트 컨트롤
- 패킷 포워딩 과정에서 기존 2계층 헤더 정보 제거 후 새로운 2계층 헤더 만든다 -> 프로토콜 변환

### 5.1.1 경로 지정

![](files/Pasted%20image%2020250315163225.png)

- 라우터는 IP 주소 사용해서 원격지에 패킷 전달
- 경로 정보를 얻는 역할과 이를 바탕으로 패킷 포워딩하는 역할로 구분
- 정확하게 경로가 일치하는 패킷만 보내므로 경로 정보 습득이 중요하다
    - IP 주소 입력하면서 자연스럽게 인접 네트워크 정보 얻는 방법
    - 관리자가 직접 경로 정보 입력
    - 라우터끼리 서로 경로 정보 교환

### 5.1.2 브로드캐스트 컨트롤(Broadcast Control)

- 스위치는 모르는 패킷을 플러딩
    - 쓸모없는 패킷이 전송될 수 있지만 LAN은 크기가 작아 영향이 작고
    - NIC에서 다르면 버리기에 큰 무리가 없다


- 그러나 라우터는 이상한 패킷이 네트워크 차지하는 걸 막으려고 노력


- 라우터는 바로 연결된 네트워크를 제외하고는 경로 습득 설정을 하지 않으면 패킷을 포워딩할 수 없다
- 기본 동작은 멀티캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않는다
    - 이 기능으로 브로드캐스트가 다른 네트워크로 전파되는 걸 막을 수 있다
    - 이를 브로드캐스트 컨트롤 / 멀티캐스트 컨트롤이라고 한다.
- 네트워크에 브로드캐스트가 많으면 라우터로 네트워크 분리하면 성능 높일 수 있다

### 5.1.3 프로토콜 변환

- 서로 다른 프로토콜로 구성된 네트워크끼리연결
- 현대는 이더넷 많이 쓰지만 과거에는 (현재도 일부) LAN 프로토콜과 WAN 프로토콜이 달랐다
- 이런 기술 사이에 변환이 필요했고, 이는 라우터가 담당한다

![](files/Pasted%20image%2020250315163504.png)

- 3계층 장비이므로 3계층 주소 정보 기반 동작
- 라우터에 패킷 들어오면 2계층까지의 헤더 정보 없애고 3계층 주소 확인 후 2계층 헤더 정보 새롭게 만들어서 외부로 보낸다
- 그래서 들어올 때랑 나갈 때랑 헤더 정보가 다르다
- 덕분에 전혀 다른 기술 간 변환이 가능하다

## 5.2 경로 지정 - 라우팅 / 스위칭

- 인터넷에 주소, 경로는 매우 늘고 있고
- 클래스리스 네트워크 등장으로 경로 정보는 더 복잡해지고 많아짐
- 라우터는 이런 경로 정보를 얻어 최적의 경로 정보인 라우팅테이블을 잘 유지해야 함


- 라우터는 다양한 정보를 얻을 수 있지만, 원하는 목적지 정보와 정확히 일치하지 않는 경우가 더 많다
- 라우터는 서브넷 단위로 라우팅 정보 습득하고 라우팅 정보를 최적화하기 위해 서머리(Summary) 작업을 통해 여러 개의 서브넷 정보를 뭉쳐서 전달
- 따라서 패킷과 테이블이 정확히 일치하지 않아도 목적지에 가장 근접한 정보를 찾아 패킷 전달한다

### 5.2.1 라우팅 동작과 라우팅 테이블

- 현대 인터넷에서 라우터는 인접 라우터까지만 경로를 지정하면 인접 라우터에서 다시 최적 경로 지정해서 라우팅한다
- 네트워크를 한 단계 뛰어넘는다는 의미로 이 기법을 Hop-by-Hop 라우팅이라고 부른다
- 인접한 라우터는 Next Hop

![](files/Pasted%20image%2020250315163923.png)

- 넥스트 홉 지정할 때는 일반적으로 3가지 방법 사용
    - 다음 라우터의 IP 지정
    - 라우터의 나가는 인터페이스 지정
    - 둘 다 동시에 지정


- 일반적으로 상대방 라우터의 인터페이스 IP 주소를 지정
- 특수한 경우에만 라우터의 나가는 인터페이스 지정 방법을 쓸 수 있는데 넥스트 홉 라우터 IP를 모르더라도 MAC 주소 정보를 알아낼 수 있을 때만 사용 가능
- WAN 구간 전용선에서는 PPP나 HLDC와 같은 프로토콜을 사용해 MAC 주소를 몰라도 되거나 상대방 라우터에서 프록시 ARP가 동작해 정확한 IP 주소를 모르더라도 상대방의 MAC 주소를 알 수 있는 경우 쓸
  수 있다
- 물론 이건 특수한 경우


- 인터페이스 설정하면 라우터의 나가는 물리 인터페이스 설정하는 게 일반적이지만 IP 주소와 인터페이스 동시에 사용할 때는 VLAN 인터페이스와 같은 논리적인 인터페이스를 사용할 수 있다

![](files/Pasted%20image%2020250315164140.png)

- 라우터가 경로를 정할 때는 출발지를 고려하지 않는다
- 그래서 라우팅 테이블 만들 때는 목적지 정보만 수집한다.


- 라우팅 테이블에는 아래 정보가 포함된다
    - 목적지 주소
    - 넥스트 홉 IP 주소, 나가는 로컬 인터페이스(선택 가능)


- 라우터에서 패킷의 출발지 주소를 이용해 라우팅하도록 PBR(Policy-Based Routing) 기능을 사용할 수 있지만 목적지 주소만 수집하는 라우팅 테이블로는 이 기능을 활성화할 수 없고 라우터 정책과
  관련된 별도 설정 필요
- 다른 라우터로의 전파가 어렵고 일반적이지 않은 별도 동작 필요
- 소스 라우팅(Source Routing) 혹은 폴리시 라우팅(Policy Routing)이라고 불리는 이 기능은 관리가 어렵고 문제가 생기면 해결이 어려워 특수한 목적으로만 사용한다.


- 소스 라우팅과 PBR, 정책 라우팅
    - PBR은 출발지 IP뿐만 아니라 도착지 IP, 포트 번호 등 다양한 조건을 쓸 수 있다
    - PBR을 출발지 주소를 지정한다는 이유로 소스 라우팅이라고 부르기도 하지만 소스 라우팅의 원래 의미는 출발지에서 경로를 지정한다는 뜻

![](files/Pasted%20image%2020250315164604.png)

- 루프가 없는(Loop Free) 3계층 : TTL(Time To Live)
    - 3계층 IP 헤더에는 TTL 있다
    - 패킷이 네트워크에 살아 있을 수 있는 시간(홉)을 제한
    - 라우터는 불분명한 패킷을 버리지만 서버가 사라지거나 대안 경로를 찾다가 순간적으로 마주보는 라우터가 생길 수도 있다
        - 라우터끼리 서로 패킷 주고받는 현상을 라우팅 루프라고 한다
    - 그래서 모든 패킷에는 TTL이라는 수명 값이 있고 이 값이 0이 되면 네트워크 장비에서 버려진다
    - TTL은 실제 시간은 아니고, 홉을 하나 지날 때마다 1씩 줄어든다

![](files/Pasted%20image%2020250315164618.png)

### 5.2.2 라우팅(라우터가 경로 정보를 얻는 방법)

#### 5.2.2.1 다이렉트 커넥트

- IP 주소를 입력할 때 사용된 IP 주소와 서브넷 마스크로 네트워크 주소 정보를 얻을 수 있다
- 라우터나 PC는 이 정보로 네트워크에 대한 라우팅 테이블 자동으로 만든다
- 이 경로 정보를 Direct Connected라고 부른다


- 인터페이스에 IP를 설정하면 자동으로 생성되는 정보이므로 강제로 지울 수 없고, 해당 네트워크 설정 삭제하거나 해당 네트워크 인터페이스 비활성화되어야만 자동으로 사라진다

![](files/Pasted%20image%2020250315164741.png)

#### 5.2.2.2 스태틱 라우팅

![](files/Pasted%20image%2020250316143033.png)

- 관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정해 경로 정보를 입력하는 것
- 관리자가 직접 지정하므로 매우 직관적으로 설정, 관리할 수 있다


- 연결된 인터페이스 정보가 사라지거나 비활성화되면 연관된 스태틱 라우팅 정보도 자동 삭제된다
- 다만 물리 인터페이스가 아닌 논리 인터페이스는 물리 인터페이스가 비활성화됟라도 함께 비활성화되지 않는 경우도 있어 라우팅 테이블에서 사라지지 않을 수도 있다.

#### 5.2.2.3 다이나믹 라우팅

- 스태틱 라우팅은 변화가 적은 네트워크에서 관리자가 네트워크를 손쉽게 관리할 수 있다
- 하지만 큰 네트워크는 관리가 어렵다
- 라우터 너머의 상태 정보를 파악할 수 없어 라우터 사이의 회선이나 라우터에 장애가 발생하면 장애 상황을 파악하고 대체 경로로 패킷을 보낼 수 없기 때문이다.

![](files/Pasted%20image%2020250316143328.png)

- 관리해야 할 네트워크 수가 많아지거나 연결이 복잡해지면 관리해야 할 네트워크 수도 기하급수적으로 늘어나므로 관리자가 수동으로 관리하는 데 한계가 있다


- 다이나믹 라우팅은 스태틱 라우팅의 이런 단점을 보완한다
- 라우터끼리 자신이 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습
- 주기적으로 혹은 상태 정보가 변경될 때 라우터끼리 경로 정보가 교환되므로 라우터를 연결하는 회선이나 라우터 자체에 장애가 발생하면 이 상황을 인지해 대체 경로로 패킷을 포워딩할 수 있다


- 관리자의 개입 없이 라우터끼리 정보 교환만으로 장애를 인지하고 트래픽 우회가 가능하므로 대부분 다이나믹 라우팅을 쓴다

![](files/Pasted%20image%2020250316143524.png)

- 다이나믹 라우팅에서는 자신이 광고할 네트워크를 선언해줘야 한다
- 프로토콜따라 설정 방법은 다르지만 네트워크 선언해야 하는 건 똑같다


- 사실 다이나믹 라우팅은 여러 종류로 분류할 수 있다
- 라우터는 단순히 경로 정보를 얻는 것뿐만 아니라
- 다양한 경로 정보를 체계적으로 데이터베이스화하고 순위를 적절히 부여해 최선의 경로 정보만 수집하는 것
    - 이후 라우팅 할 때 경로 찾는 작업을 단순화하기 위함


- 라우터가 수집한 경로 정보 중 원시 데이터를 토폴로지 테이블이라고 하고
- 최적 경로를 저장하는 테이블을 라우팅 테이블이라고 한다


- 중요한 건 패킷을 보낼 때는 전체 경로를 고려하는 게 아니라 다음 라우터까지만 패킷을 포워딩하는 것
- 이를 홉-바이-홉 라우팅이라고 하고
- 다움 라우터가 다시 다음 라우터까지의 최적의 경로로 패킷을 포워딩

### 5.2.3 스위칭(라우터가 경로를 지정하는 방법)

- 패킷이 들어와 라우팅 테이블을 참조하고 최적의 경로를 찾아 라우터 외부로 포워딩하는 작업을 스위칭이라고 한다
    - 2계층 스위치와 용어가 비슷하지만 3계층 장비인 라우터가 패킷 경로를 지정해 보내는 작업을 말한다


- 패킷을 보낼 때는 다음도 고려해야 한다
    - 패킷의 목적지가

![](files/Pasted%20image%2020250316144134.png)

- 10.1.1.9와 완전히 매칭되는 경로가 없으므로 Longest Prefix Match 기법으로 가장 가까운 경로를 택한다


- Longest Prefix Match
    - 라우팅 테이블 중 가장 좋은 항목을 찾는 알고리즘을 Longest Prefix Match나 Maximum Prefix Length Match라고 한다
    - 이런 작업을 수행하는 걸 Longest Prefix Matching, Longest Match Rule이라고 부르기도 한다
    - LPM 용어는 다른 곳에서도 찾아볼 수 있는데
    - 라우팅 테이블을 LPM 테이블이라고 부르며 도입해야 할 장비가 관리할 수 있는 테이블 양으로 대략적인 성능을 확인할 수 있다


- 라우터에서는 LPM에 부하가 많이 걸린다
- 정확한 정보 매칭은 쉽지만 Longest Match처럼 부정확한 정보 중 가장 비슷한 경로를 찾는 작업은 리소스가 많이 든다
- 패킷이 들어올 때마다 이 작업을 수행하면 많은 리소스를 소모하므로 대부분의 라우터는 이런 반복작업을 줄여주는 기술을 채용하고 있다.


- 한 번 스위칭 작업을 수행한 정보는 캐싱한다.
- 캐시가 가능한 것은 동일한 출발지, 목적지를 지닌 패킷 여러 개가 연속적으로 보내지기 때문이다
- 이런 캐시 기술도 캐시하는 정보에 따라 다양하다.


- 단순히 목적지 IP만 캐시하는 경우, 출발지와 목적지 모두 캐시하는 경우, 포트 정보까지 포함해 플로를 모두 저장하는 정도
- 한 단계 더 나아가 넥스트 홉 L2 정보도 캐시해 스위칭 시간을 줄이는 기법도 사용된다.

### 5.2.4 라우팅, 스위칭 우선순위

- 좋은 경로 정보의 우선순위는 경로 정보를 받은 방법과 거리를 기준으로 정한다.

![](files/Pasted%20image%2020250316145005.png)

- 목적지 네트워크가 동일한 서브넷을 사용하는 경우 정보 소스에 따라 가중치를 정한다.
    - 다이렉트 커넥티드 > 스태틱 라우팅 > 다이나믹 라우팅
    - 라우팅 프로토콜에 따라 어떤 라우팅 프로토콜을 통해 경로 정보를 얻었는가에 따라 우선순위가 다르다.


- 기본적인 우선순위는 정해져있지만 필요에 따라 관리자가 우선순위를 조정해 라우팅 경로를 조정할 수 있다
- 이를 AD(Administrative Distance, 관리 거리)라고 부르며 라우터 생산업체마다 AD 값이 조금씩 다르다.

| 우선순위 | 기본 디스턴스                        |
|------|--------------------------------|
| 0    | Connected Interface(다이렉트 커넥티드) |
| 1    | Static Route(스태틱 라우팅)          |
| 20   | External BGP                   |
| 110  | OSPF                           |
| 115  | IS-IS                          |
| 120  | RIP                            |
| 200  | Internal BGP                   |
| 255  | Unknown                        |

- 소스도 같아서 가중치 값이 동일한 경우 Cost 값으로 우선순위를 정한다
- 이것까지 같으면 ECMP(Equal-Cost Multi-Path) 기능으로 동일한 코스트 값을 가진 경로 값 정보 모두 활용해 트래픽을 분산한다.


- Cost는 일종의 거리를 나타내는 값으로 라우팅 프로토콜마다 기준이 다르다
- RIP은 홉수, OSPF는 대역폭, EIGRP는 다양한 값들을 연산해 나온 값으로 코스트를 정한다.


- 라우터의 라우팅, 스위칭 역할을 하나로 묶어 다시 설명하면 전체적인 우선순위는 아래와 같다.

![](files/Pasted%20image%2020250316145633.png)

- 기존 정보보다 우선순위가 높은 라우팅 정보를 입력하고 싶다면 우선순위 참조해 입력하면 된다

## 5.3 라우팅 설정 방법

### 5.3.1 다이렉트 커넥티드

- IP 주소, 서브넷 마스크 입력하면 라우팅 테이블 생긴다

![](files/Pasted%20image%2020250316145721.png)

- 목적지가 다이렉트 커넥티드라면 라우터는 L2 통신(ARP 요청을 직접 보내는)으로 목적지에 도달한다
- 목적지가 외부 네트워크인데 다이렉트 커넥티드 라우팅 테이블 정보만 있다면 통신이 불가능하다
- 외부 네트워크로 통신하려면 스태틱 라우팅이나 다이나믹 라우팅에서 얻은 원격지 네트워크에 대한 라우팅 정보가 있어야 한다.


- 외부 네트워크 정보가 있어도 다이렉트 커넥티드 정보를 잘못 입력하면 외부 네트워크와 통신할 수 없다
- 외부 네트워크로 나가는 첫 번째 길목이 다이렉트 커넥티드이기 때문
- IP 주소를 잘못 설정하거나 서브넷 마스크를 잘못 설정하면 외부 네트워크와 단절된 독립된 네트워크가 되거나 특정 네트워크와 통신할 수 없는 상태가 될 수 있다.

### 5.3.2 스태틱 라우팅

- 네트워크 정보 추가하고 경로 제거 쉬운 건 스태틱 라우팅
- 다이렉트 커넥티드 제외하고 우선순위도 제일 높음
- 서버 담당자도 경로 관리에 사용하는 경우가 많으니 잘 알아두면 좋다.


- 운영 체제따라 문법 다르지만 보통 아래처럼 한다
    - `ip route NETWORK NETMAST NEXTHOP`
    - `route add -net NETWORK /Prefix gw NEXTHOP`

> 저는 거의 해본 적이 없고 필요할 때 그때그때 찾아서 했던 편인데 다들 자주 해보셨나요 혹은 익숙하신가요

- 이 문법을 쉽게 표현하면 아래와 같다.
    - 목적지(네트워크/호스트 - 서브넷/서브넷 마스크)로 가려면 패킷을 넥스트 홉으로 보내야 한다

![](files/Pasted%20image%2020250316151328.png)

- `ip route 20.20.20.0 255.255.255.0 1.1.1.2`


- 위 명령을 입력 후 R1 라우팅 테이블은 아래와 같다.

![](files/Pasted%20image%2020250316151419.png)

![](files/Pasted%20image%2020250316151642.png)

- 2025년 3월 기준 라우팅 정보 1,000,000 개 이상
- 많은 라우팅 정보를 처리하기 위해서는 일반적인 라우터, 스위치가 아니라 대용량의 인터넷 전용 라우터 필요
- 인터넷 정보를 모두 가질 수 있는 라우터는 KT, SK, LGU+ 등의 ISP에서 운영

![](files/Pasted%20image%2020250316151748.png)

- 일반적인 회사 라우터는 보통 회선 임대해서 하므로 모든 인터넷 경로 정보 받아서 처리하는 건 부적절
- 스태틱 라우팅을 확장한 디폴트 라우팅 사용하면 문제를 쉽게 해결할 수 있다

![](files/Pasted%20image%2020250316151835.png)

- 모든 패킷을 인터넷 사업자에게 보내기 위해 A 클래스 단위로 스태틱 라우팅을 만든다면 200개 이상의 스태틱 라우팅이 필요하다.

```
ip route 0.0.0.0 255.0.0.0 1.1.1.1
ip route 1.0.0.0 255.0.0.0 1.1.1.1
ip route 2.0.0.0 255.0.0.0 1.1.1.1
ip route 3.0.0.0 255.0.0.0 1.1.1.1
... (계속)
```

![](files/Pasted%20image%2020250316152115.png)

- 이런 디폴트 라우팅을 사용하면 손쉽게 라우팅 정보를 처리할 수 있다
- 인터넷으로 향하는 경로나 자신에게 경로가 없는 경우 디폴트 라우팅을 사용한다.
- 서버에서 디폴트 게이트웨이를 설정하면 서버의 라우팅 테이블에 디폴트 라우팅이 생성된다.

![](files/Pasted%20image%2020250316152329.png)

- Router `192.168.0.1`

![](files/Pasted%20image%2020250316152349.png)

- default `192.168.0.1`


- 네트워크 장비에서는 디폴트 라우팅과 디폴트 게이트웨이를 구분하기도 한다
- 디폴트 라우팅은 라우팅 능력이 있는 장비에서 사용하고 디폴트 게이트웨이는 이런 능력이 없는 장비에서 사용
- 라우터에서도 라우팅이 불가능하게 설정하면 일반 PC와 같은 상태가 되어 인터넷에 접속하려면 `default gateway` 명령을 이용해야 한다.

### 5.3.3 다이나믹 라우팅

- SPoF 없애기 위해서 두 개 이상의 경로를 유지
- 이 경우 대체 경로에 대한 고민 필요
- 대체 경로가 필요한 네트워크를 스태틱 라우팅으로만 구성하면 한 홉이 넘어간 네트워크 상태가 변경될 때 신속하게 대응할 수 없다
- 관리자가 수동으로 수정해야 함.

![](files/Pasted%20image%2020250316152548.png)

- 스태틱 라우팅은 최적 경로 뿐만 아니라 대체 경로까지 고려해야 해 경로 설정이 아주 많아진다
- 설정해야 할 라우터도 많아진다


- 다이나믹 라우팅 프로토콜 사용하면 개입 없이 라우터끼리 정보 교환해서 정보를 최신으로 유지할 수 있다


- 다이나믹 라우팅 뒤에 프로토콜이 붙는 건 라우터들끼리 자신들만의 프로토콜로 정보를 교환하기 때문
- 주기적으로나 특별한 변화가 있으면 경로 정보를 교환하므로 중간 경로에 문제가 발생하더라도 대체 경로를 찾는 작업이 자동으로 수행된다.


- RIP, OSPF, IS-IS IGRP, EIGRP, BGP 등 여러 프로토콜 있는데
- 최근에는 OSPF나 BGP 프로토콜이 주로 쓰인다.

![](files/Pasted%20image%2020250316153034.png)

![](files/Pasted%20image%2020250316153048.png)

- 유니캐스트 경로 정보를 교환하는 프로토콜과 멀티캐스트 경로 정보를 교환하는 라우팅 프로토콜이 별도로 있다
- RIP, IGRP, OSPF, IS-IS, EIGRP, BGP는 유니캐스트 라우팅 프로토콜이고 DVMRP, MOSPF, PIM은 멀티캐스트 라우팅 프로토콜이다.

#### 5.3.3.1 역할에 따른 분류

- 일반적으로 라우팅 프로토콜은 유니캐스트 라우팅 프로토콜을 말한다
- 주로 사용하는 역할과 동작 원리에 따라 구분한다.


- 인터넷에는 AS(Autonomous System)라는 자율 시스템이 존재
- 인터넷 사업자가 한 개 이상의 AS를 운영
- AS 내부에서 사용하는 라우팅 프로토콜을 IGP(Interior Gateway Protocol)이라고 하고, AS 간 통신에 사용하는 라우팅 프로토콜을 EGP(Exterior Gateway Protocol)이라고
  한다.


- [RFC4271](https://datatracker.ietf.org/doc/html/rfc4271)
    - Autonomous System (AS)
    - The classic definition of an Autonomous System is a set of routers under a single technical administration, using
      an interior gateway protocol (IGP) and common metrics to determine how to route packets within the AS, and using
      an inter-AS routing protocol to determine how to route packets to other ASes. ... The use of the term Autonomous
      System stresses the fact that, even when multiple IGPs and metrics are used, the administration of an AS appears
      to other ASes to have a single coherent interior routing plan, and presents a consistent picture of the
      destinations that are reachable through it.
    - single technical administration 아래에 있는 라우터 집합
    - 내부에서는 여러 개의 IGP, 지표를 사용해도 외부에서는 하나의 통일되고 일관된 라우팅 정책을 지닌 것처럼 보임
    - 즉, 고유한 라우팅 정책을 가지고 있는 ISP, 정부, 회사 등
    - AS 간 연동에 BGP 사용


- AS는 하나의 조직이므로 AS 내부에서는 자체적으로 규칙을 세워 운영할 수 있지만 다른 AS와 연결하기 위해서는 내부와 다른 방법으로 정보를 전달해야 한다
- AS 내부 연결은 효율성이 중요하지만 다른 AS 연결에서는 조직 간 정책이 더 중요하다.

![](files/Pasted%20image%2020250316154119.png)

- EGP이 필요한 정책 중 하나를 예를 들어보면
    - AS 100 -> AS 400 통신하려면 AS 200이나 AS 300 거쳐야 한다
    - 이때 중간 AS인 AS 200, AS 300은 무작정 이런 통신을 허락하면 안 된다
    - ISP 간에도 통신 비용을 지불한다. AS 200 등에서는 이런 통신을 쉽게 파악할 수 있어야 하고 EGP는 이런 통신을 정책적으로 조정할 수 있는 기능이 있어야 한다
    - 이런 정책 떄문에 AS를 건너 연결하는 것이 제한되고, AS 간 직접 연결을 주로 사용


- 인터넷이라고 모든 통신이 공통 경로로 이루어지는 것은 아니고 인터넷 사업자 간의 이해관계에 따라 연결 경로가 달라지므로 인터넷의 특정 서버로 통신이 빠르거나 느린 차이가 발생한다.
- 회선을 무한정 늘릴 수 없는 해외 사업자와 연결할 때 통신사업자마다 속도차를 느낄 수 있다.

![](files/Pasted%20image%2020250316154333.png)

- [[IT백과] SKB와 BGP 세션 설정한 넷플릭스, 망사용료 내야할까?](https://ddaily.co.kr/page/view/2022101711350616539)
- [인터넷 익스체인지 포인트란? | IXP 작동 방식은? | Cloudflare](https://www.cloudflare.com/ko-kr/learning/cdn/glossary/internet-exchange-point-ixp/)

#### 5.3.3.2 동작 원리에 따른 분류

- IGP 라우팅 프로토콜은 동작 원리에 따라 크게 Distance Vector와 Link-State로 나뉜다
- 두 원리의 장단점을 합친 Advanced Distance Vector가 있지만 특정 회사가 만든 프로토콜로 최근에는 많이 쓰이지는 않는다
    - EIGRP -> Cisco 전용 라우팅 프로토콜
    - 본래는 cisco에서 만든 cisco 전용 라우팅 프로토콜이었지만, 2016년 5월애 RFC 표준으로 등록되었다


- 디스턴스 벡터
    - 인접한 라우터에서 경로 정보를 습득하는 라우팅 프로토콜
- 링크 스테이트
    - 라우터에 연결된 링크 상태를 서로 교환하고 각 네트워크 맵을 그리는 라우팅 프로토콜

![](files/Pasted%20image%2020250316155156.png)

- 디스턴스 벡터 라우팅 프로토콜
    - RIP, BGP
    - 인접한 라우터에서 경로 정보를 습득
    - 인접 라우터가 아니면 간접적으로 한 단계 건너서 받는다
    - 인접 라우터가 이미 계산한 결과물을 받아 라우팅 정보 처리에 많은 리소스가 들지 않는다는 장점이 있어 간단한 네트워크 구축에 많이 사용
    - 그러나 인접 라우터에게서만 받으므로 멀리 떨어진 라우터의 경로 정보를 얻는 데 많은 라우터를 거쳐야 하므로 모든 라우터 정보가 동기화되는 데 많은 시간이 걸린다
    - 이런 동작 방식때문에 네트워크 변경이 발생하면 정확한 정보 파악에 오랜 시간이 걸린다.
- 어드밴스드 디스턴스 벡터
    - 시스코에서 개발한 IGRP, EIGRP

![](files/Pasted%20image%2020250316155249.png)

- 링크 스테이트 라우팅 프로토콜
    - 라우터들에 연결된 링크 상태를 교환
    - 이미 최적의 경로를 계산한 라우팅 테이블과 달리 직접적인 상태를 받아올 수 있다
    - 이런 링크 상태로 토폴로지 데이터베이스를 만들고, 이 정보를 다시 SPF(Shortest Path First) 알고리즘을 이용해 최단 경로 트리를 만든다.
    - [Dijkstra's Shortest Path First (SPF) Algorithm](https://www.learncisco.net/courses/icnd-2/an-overview-of-ospf/ospf-data-overview.html)
    - 최단 경로 트리로 최적의경로 선정한 후 라우팅 테이블에 추가

![](files/Pasted%20image%2020250316155541.png)

- 전체 네트워크 링크 정보를 받으므로 전체 네트워크 맵을 그리고 경로 변화 파악에 유리
- 그러나 이런 작업이 부하로 작용할 수 있어 네트워크 규모가 커지면 경로 파악에 CPU, 메모리 많이 쓴다
- 따라서 네트워크 변화를 더 빨리 감지하고 리소스를 최적화하기 위해 네트워크를 에어리어(AREA) 단위로 분리하고 분리된 에어리어 내에서만 링크 상태 정보를 교환


- 에어리어 내부에서는 전체 링크 정보를 공유하지만 에어리어 외부의 라우터는 링크 상태를 보내지 않고 가공된 라우팅 테이블 형태로 전달


- AREA 단위로 네트워크를 구분하고 확장하는 OSPF는 AREA0으로 불리는 Backbone AREA를 통해 모든 AREA가 연결된다
- AREA 간이나 OSPF 외부 네트워크와의 연결을 위해서는 특별한 라우터 이용
- ABR(Area Border Router)는 Backbone AREA와 다른 AREA를 연결시켜주는 경계 라우터
- ASBR(Autonomous System Border Route)은 OSPF가 아닌 다른 외부 정보를 OSPF와 연결해주는 외곽 라우터


- AS 내부에서 라우팅 정보를 교환하느냐, 외부와 교환하느냐에 따라 역할을 구분
- 내부 동작 원리에 따라 디스턴스 벡터, 링크 스테이트로 구분
- 대부분 IGP로 OSPF와 BGP가 많이 쓰이며
- EGP로는 BGP가 쓰인다.

| 분류 방법 | 분류            | 설명                                                                                        |
|-------|---------------|-------------------------------------------------------------------------------------------|
| 역할    | EGP           | 서로 다른 AS 간 정보교환용 라우팅 프로토콜. BGP가 여기에 속한다.                                                  |
|       | IGP           | AS 내부에서 동작하는 라우팅 프로토콜로 RIP, EIGRP, OSPF, IS-IS 등이 있다.                                     |
| 동작 원리 | 디스턴스 벡터       | 직접 연결된 장비가 보내준 정보를 기반으로 최적의 경로를 선정하는 라우팅 프로토콜로 RIP, BGP가 있다.                              |
|       | 어드밴스드 디스턴스 벡터 | 디스턴스 벡터보다 다양한 경로 선정을 위한 요소가 있으며 직접 연결된 장비를 지난 장비까지 고려해 경로를 선정할 수 있다.                      |
|       | 링크 스테이트       | 네트워크 맵에 속한 장비가 보내준 정보를 기반으로 토폴로지 맵을 만들고 SPF 알고리즘을 이용해 최적의 경로를 선정한다. OSPF와 IS-IS가 여기에 속한다. |

**[다이나믹 라우팅 활용 현황]**

- 기존에는 연산도 별로 필요없고 유지보수도 간단한 RIP가 소형 네트워크에서 많이 쓰임
- 그러나 느린 정보 교환, 홉 수 제한, 최적 경로 선택에 링크 속도를 제외시키는 등의 여러 제약으로 사용되지 않는 추세


- RIP의 단점을 보완환 EIGRP 프로토콜이 유행하던 때도 있었다
- OSPF처럼 전체 네트워크 지도를 그리지 않고 인접한 라우터 다음 라우터까지의 경로만 가진 EIGRP는 리소스 사용 적으면서 대체 경로 찾는 시간이 매우 짧았고, 유지보수도 쉬워 작은 회사부터 큰 회선 사업자까지
  도입할 정도로 유행했다.
- 그러나 시스코가 개발해서 다른 회사 장비에서는 쓸 수 없었고, 전체 맵을 그리는 라우팅 프로토콜이나 정책 기반 라우팅의 다양한 장점을 발휘할 수 없어 대부분 사라졌다.


- 최근에는 BGP 사용이 늘고 있다
- BGP는 다양한 프로토콜 정보를 한꺼번에 교환할 수 있다는 장점
- AS 외부뿐만 아니라 내부에서도 사용할 수 있어 많이 적용되고 있다
- 정책 기반 라우팅이므로 관리자의 의도대로 경로를 동적으로 변환할 수 있다는 큰 장점
- 라우팅 테이블이 크거나 IPv4, Ipv6 네트워크가 혼재되어 있거나 멀티테넌트 환경인 경우 다양한 정보 교환을 목적으로 BGP 프로토콜 사용
- 이때 사용하는 BGP를 MP-BGP(MultiProtocol Border Gateway Protocol)이라고 부른다.

[Facebook 접속 장애 사건 분석 (BGP Down) | Devkly](https://devkly.com/network/facebook-bgp-down/)
[Facebook 접속 오류 문제의 원인에 대해 이해하기](https://blog.cloudflare.com/ko-kr/october-2021-facebook-outage/)

[과기정통부, 케이티(KT) 연결망(네트워크) 장애 원인분석 결과 발표](https://www.msit.go.kr/bbs/view.do?sCode=user&mId=113&mPid=112&pageIndex=&bbsSeqNo=94&nttSeqNo=3180886&searchOpt=ALL&searchTxt=)

- KT 네트워크와 외부 네트워크 경로 구성에는 BGP 프로토콜을 사용하고, KT 내부 네트워크 경로 구성에는 IS-IS 프로토콜을 사용한다.
- 사고발생 라우터에 라우팅 설정명령어 입력과정에서 IS-IS 프로토콜 명령어를 마무리하는 부분에서 ‘exit’ 명령어를 누락했으며, 이로 인해, BGP 프로토콜에서 교환해야 할 경로정보가 IS-IS 프로토콜로
  전송되었다.
- 통상 1만개 내외의 정보를 교환하는 IS-IS 프로토콜에 수십만개의 BGP 프로토콜의 정보가 잘못 전송되면서, 라우팅 경로에 오류가 발생하게 되었다.
- IS-IS 프로토콜 내의 라우터들은 상호간의 정보 최신화를 위해 자동으로 데이터를 주고받는데, 부산 지역라우터에 잘못된 라우팅 경로가 설정된 이후, 다른 지역의 IS-IS 라우터 등에도 잘못된 업데이트 정보가
  전달되었다.
- KT 네트워크 내에 있는 라우터들을 연결하는 IS-IS 프로토콜은 잘못된 데이터 전달에 대한 안전장치 없이 전국을 모두 하나로 연결하고 있고,
- 결국 한 개 라우터의 잘못된 라우팅 경로 업데이트가 전국의 라우터에 연쇄적으로 일어나서 장애가 전국적으로 확대되었다.


