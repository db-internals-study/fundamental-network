# Router

Router는 3계층 장비, 경로를 지정해주는. 패킷 목적지 IP 주소를 확인하고 자신이 가진 경로 정보를 이용해 패킷을 최적의 경로로 포워딩.

현대에는 라우터와 L3 스위치를 구분하기 어렵다.

## 라우터의 동작 방식과 역할

스위치와 반대로 라우터는 들어온 패킷의 목적지 주소가 라우팅 테이블에 없으면 패킷을 버림.

패킷 포워딩 과정에서 기존 2계층 헤더 정보를 제거하고 새로운 2계층 헤더를 만들어 냄

(경로 지정 -> 브로드 캐스트 컨트롤 -> 프로토콜 변환)

### 경로 지정

가장 중요한 역할. 경로 정보를 모아 라우팅 테이블을 만들고 패킷이 라우터로 들어오면 패킷의 도착지 IP 주소를 확인해 경로를 지정하고 포워딩.

정확한 목적지 경로를 얻는 것이 매우 중요함. 경로 학습 방법 -> 1/ IP 주소를 입력하며 자연스러운 인접 네트워크 정보 파악 2/ 라우터끼리 서로 경로 정보 자동 교환

### 브로드캐스트 컨트롤

기본 동작은 멀티 캐스트 정보를 습득하지 않고 브로드캐스트 패킷을 전달하지 않음.

네트워크에 브로드캐스트가 많이 발생하는 경우, 라우터로 네트워크를 분리하면 브로드캐스트 네트워크를 분할해 네트워크 성능을 높일 수 있음.

### 프로토콜 변환

서로 다른 프로토콜로 구성된 네트워크를 연결. (e.g. LAN to WAN)

## 경로 지정 - 라우팅/스위칭

다양하고 많은 경로 정보를 얻을 수 있지만 원하는 목적지 정보와 정확히 일치하지 않는 경우가 더 많음.

Summary 작업을 통해 여러 개의 서브넷 정보를 뭉쳐 전달하며, 라우팅 테이블 정보가 정확히 일치하지 않아도 근접 정보를 찾아 패킷을 포워딩 해야 함.

### 라우팅 동작과 라우팅 테이블 

인접한 라우터까지만 경로를 지정하면 인접 라우터에서 최적의 경로를 다시 파악 후 라우터로 패킷 포워딩 (Hop by hop)

- 다음 라우터의 IP 지정 : 일반적.
- 라우터의 나가는 인터페이스를 지정 : Next hop router ip를 모르지만 MAC 주소 정보를 알아낼 수 있을 때 (한정 조건)
- 라우터의 나가는 인터페이스와 다음 라우터의 IP를 동시 지정 : 일반적으로 물리 인터페이스 지정하지만, 이 경우 논리적인 인터페이스 사용 가능

라우팅 테이블에 저장하는 데이터
- 목적지 주소
- Next hop IP 주소, 나가는 로컬 인터페이스(선택 가능)

패킷 출발지 주소를 이용해 라우팅 하도록 PBR(Policy-Based Routing) 기능을 사용할 수 있으나, 별도 설정이 필요하고 다른 라우터로의 전파가 어려움. -> 특별 목적

***Source Routing과 PBR, Policy Routing***

PBR은 출발지 IP 만으로 경로 지정하는 것이 아니라 도착지 IP + 포트 번호와 같은 다양한 조건을 합쳐 사용

PBR과 소스 라우팅을 동의어로 쓰기도 하지만, 소스 라우팅은 라우터가 경로를 지정하는 것이 아니라 출발지에서 경로를 지정한다는 의미.

***Loop Free 3-tier : TTL***

대안 경로를 찾다가 루프를 도는 경우가 있는데, 유령 패킷이 넘칠 수 있기 때문에 TTL을 사용. TTL은 실제 초 시간이 아니고 Hop을 지칭하며, 하나의 Hop을 지날 때마다 TTL 값은 1씩 감소.

### 라우팅 (라우터가 경로 정보를 얻는 방법)

1. 다이렉트 커넥티드
2. 스테틱 라우팅
3. 다이나믹 라우팅

이를 통해 경로 정보를 수집하고 수집된 경로 정보 중 목적지에 대한 최적의 경로를 선정해 라우팅 테이블을 만듭니다.

#### 다이렉트 커넥티드(Direct Connected)

IP 주소가 속한 네트워크 주소 정보를 기반으로 라우팅 테이블을 만드는 방식

정보를 강제로 지울 수 없고 해당 네트워크 설정 삭제, 인터페이스 비활성시에만 사라짐

#### 스테틱 라우팅

관리자가 목적지 네트워크와 넥스트 홉을 라우터에 직접 지정.

논리 인터페이스는 물리 인터페이스가 비활성화되더라도 함께 사라지지 않는 경우가 있어 라우팅 테이블에서 사라지지 않을 수 있음.

#### 다이나믹 라우팅

스테틱 라우팅 : 네트워크 크기가 커지거나 라우터 너머의 다른 라우터 상태 정보 파악이 어려움 -> 장애 발생시 대체 경로 활용이 불가능

라우터끼리 자신이 알고 있는 경로 정보나 링크 상태 정보를 교환해 전체 네트워크 정보를 학습하고, 대체 경로 사용이 가능.

다이나믹 라우팅에서는 자신이 광고할 네트워크를 선언해줘야 함.

다양한 경로 정보를 데이터베이스화하고 순위를 적절히 부여해 최선의 경로 정보를 수집 (원시 데이터 : 토폴로지 테이블, 최적의 경로 : 라우팅 테이블)

**중요한 것은** 다음 라우터까지만 패킷을 포워딩.

### 스위칭

최적의 경로로 생각되는 경로를 라우팅 테이블에 올려 유지하는 과정 : 라우팅

패킷이 들어와 라우팅 테이블을 참조하고 최적의 경로를 찾아 라우터 외부로 포둬딩 하는 작업 : 스위칭 -> 3계층 장비인 라우터가 패킷 경로를 지정해 보내는 작업

Longest Prefix Match(LPM, or Maximum Prefix Length Match) 를 통해 가장 가까운 경로를 선택

Longest Match처럼 부정확한 정보 중 가장 비슷한 경로를 찾는 작업은 더 많은 리소스를 소모한다.  -> 캐시

### 라우팅, 스위칭 우선순위

토폴로지 테이블 - 여러 경로 정보 얻음 - 정보 얻은 소스 기준으로 최적 정보 선정 - 라우팅 테이블

가중치 값 (경로 우선순위)

- 내가 갖고 있는 네트워크 (다이렉트 커넥티드)
- 내가 경로를 직접 지정한 네트워크 (스태틱 라우팅)
- 경로를 전달받은 네트워크 (다이나믹 라우팅)

필요에 따라 관리자가 우선순위를 조정할 수 있음(Administrative Distance, AD)

경로 정보를 얻은 소스가 같아 가중치 값이 동일한 경우에는 Cost 값으로 우선순위를 정함. Cost까지 동일한 경우 ECMP(Equal-Cost-Multi-Path) 기능으로 동일한 코스트 값을 가진 경로 값 정보를 모두 활용해 트래픽을 분산.

**우선순위**

1. 롱기스트 매치 (스위칭)
2. AD (라우팅)
3. 코스트 (라우팅)
4. 부하 분산, ECMP (라우팅)
   
## 라우팅 설정 방법

### 다이렉트 커넥티드

라우터나 PC에 IP 주소, 서브넷 마스크를 입력하면 다이렉트 커넥티드 라우팅 테이블이 생성

외부 네트워크로 통신하려면 다이렉트 커넥티드 외에 스태틱 라우팅이나 다이나믹 라우팅에서 얻은 원격지 네트워크에 대한 적절한 라우팅 정보가 있어야 함.

반대로 외부 네트워크에 대한 라우팅 정보가 있더라도 다이렉트 커넥티드 정보가 잘못되어 있으면 외부와 통신 X -> 첫 번째 길목이 다이렉트 커넥티드.

### 스테틱 라우팅

네트워크 정보를 쉽게 추가하고 경로를 직접 제어할 수 있는 가장 강력한 방법

인터넷은 라우팅 정보가 매우 많음 -> 대용량 인터넷 라우팅 전용 라우터가 필요 -> ISP 같은 인터넷 사업자가 운영

목적지 주소의 서브넷 마스크가 모두 0인 스태틱 라우팅을 디폴트 라우팅이라고 함. -> 인터넷 게이트웨이와 같은 의미.

### 다이나믹 라우팅

대체 걍로 찾는 프로토콜 : RIP, OSPF, BGP -> (유니캐스트 라우팅)

#### 역할에 따른 분류

라우팅 프로토콜 -> 유니캐스트 라우팅 프로토콜

AS(Autonomous System) 내부에서 사용하는 라우팅 프로토콜을 IGP(Interior Gateway Protocol), AS 간 통신에 사용하는 라우팅 프로토코릉ㄹ EGP(Exterior Gateway Protocol)이라고 함.

인터넷 사업자 간의 이해관계에 따라 연결 경로가 달라질 수 있음

#### 동작 원리에 따른 분류

IGP 프로토콜은 크게 Distance vector와 Link-State로 나뉨. Advanced Distance Vector도 있지만 특정 회사가 만든 프로토콜로 많이 사용되지는 않음.

- Distance Vector : 인접한 라우터에서 경로 정보를 습득 (RIP, BGP). 간단한 네트워크 구축 용이. 단, 모든 라우터 정보 동기화에 오랜 시간이 걸림.
- Link-State : 라우터에 연결된 링크 상태를 서로 교환하고 각 네트워크 맵을 그리기 (IGRP, EIGRP). 최단 경로 트리를 만듦. 부하가 커질 수 있고 네트워크 규모가 커지면 더 많은 자원을 소모. 따라서 Area 단위로 분리하고 여기서 교환.

IGP로 OSPF, BGP가 많이 사용되고 EGP로 BGP가 많이 사용됨.

***BGP 장점***

다양한 프로토콜 정보를 한꺼번에 교환, AS 외부 뿐 아니라 내부에서도 사용할 수 있어 많이 적용

BGP는 정책 기반 라우팅이기 떄문에 관리자의 의도대로 경로를 동적으로 변환할 수 있음.

  
