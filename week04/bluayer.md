# 스위치

MAC 주소를 기반으로 패킷을 전달하는 동작 수행 +  한 대의 장비에서 논리적으로 네트워크를 분리할 수 있는 VLAN + 네트워크 루프를 방지하는 스패닝 트리 프로토콜(STP)

그리고 보안, 모니터링도 가능

## 4.1 스위치 장비 동작

패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와주는 장비 : 스위치

여러 단말이 한꺼번에 통신 가능 -> 통신하기 위해 기다리거나 충돌 때문에 대기하는 문제가 해결

누가 어느 위치에 잇는지 파악하고 실제 통신 시 자신이 알고 있는 위치로 패킷을 정확히 전달 ->  단말 주소인 MAC 주소와 단말이 위치하는 인터페이스 정보를 매핑한  **MAC 주소 테이블**을 갖고 있어서 가능

아무튼 동작 방식이 총 3가지임

1. 플러딩(Flooding)
2. 어드레스 러닝(Address Learning)
3. 포워딩/필터링(Forwarding/Filtering)

### 플러딩

스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식 : 플러딩

당연히 플러딩이 많아지면 정상적인 동작이 불가능함

***비정상적인 플러딩***

이더넷-TCP/IP 네트워크에서는 ARP 브로드캐스트를 주고받은 후 데이터가 전달되므로 실제로 데이터를 보내고 받을 때는 스위치가 패킷을 플러딩하지 않음.

스위치 기능을 무력화하는 공격 기법 : 엉뚱한 MAC 주소를 습득시키거나 MAC 테이블을 꽉 차게함.

ARP 포이즈닝을 통해 모니터링해야 할 IP의 MAC 주소가 공격자 자신인 것처럼 속이기도 함.

### 어드레스 러닝

MAC 주소 테이블을 만들고 유지하는 과정을 어드레스 러닝이라고 함.

패킷이 특정 포트에 들어오면 패킷의 출발지 MAC 주소와 포트번호를 MAC 주소 테이블에 기록함. (브로드캐스트, 멀티캐스트에 대한 MAC 주소를 학습할 수 없음 -> 목적지 MAC 주소 필드에서만 사용하기 때문)

***사전 정의된 MAC 주소 테이블***

스위치 간 통신을 위해  사전에 미리 정의된 MAC 주소 정보를 가지고 있음

### 포워딩/필터링

도착지 MAC 주소를 확인하고 자신이 가진 MAC 테이블과 비교해 맞는 정보가 있으면 해당 포트로 패킷을 **포워딩**하고

다른 포트로는 해당 패킷을 보내지 않으므로 **필터링**하게 됨

일반적인 유니캐스트에 대해서만 포워딩과 필터링 작업을 하게 됨. BUM 트래픽은 플러딩

***LAN에서의 ARP***

이더넷-TCP/IP 네트워크에서는 스위치가 유니캐스트를 플러딩하는 경우가 거의 없음 -> ARP를 먼저하기 때문. 이 과정에서 스위치는 출발/목적지 MAC 주소를 습득

ARP, MAC 테이블은 일정 시간동안 지워지지 않으며 Aging Time이라고 함. (MAC Table aging > ARP aging -> No flooding!)

## VLAN

하나의 물리 스위치에서 여러 개의 네트워크를 나누어 사용할 수 있게 함

VLAN 간의 통신이 필요하다면 서로 다른 네트워크 간의 통신이므로 3계층 장비가 필요

VLAN을 통해 논리적, 서비스/단말의 성격에 따라 네트워크를 분리하거나 물리적으로 다른 층에 있는 단말을 동일한 네트워크로 묶을 수도 있음.

### VLAN의 종류와 특징

포트 기반 VLAN : 스위치를 논리적으로 분할해 사용, 일반적인 VLAN. VLAN 선정 기준은 스위치의 포트 (앞으로 다룰 VLAN)

MAC 기반 VLAN : 스위치에 연결되는 단말의 MAC을 기반으로 VLAN을 할당 (Dynamic VLAN)

### VLAN 모드(Trunk/Access) 동작 방식

같은 스위치에 연결되더라도 서로 다른 VLAN이 설정된 포트 간에는 통신할 수 없음. (분리된 스위치에 연결된 것과 동일하기 때문)

이 경우 3계층 장비를 이용해야 함.

여러 개의 VLAN이 존재할 때, 스위치를 서로 연결해야 한다면 VLAN 개수만큼 포트를 연결해야 함 -> 포트 낭비가 발생할 수 있음

그래서 VLAN 태그 기능을 통해 하나의 포트에 여러 개의 VLAN을 함께 전송할 수 있게 함 (Tagged 포트 or Trunk 포트)

이더넷 프레임 중간에 VLAN ID 필드를 끼워 넣어 이 정보를 이용

***알반적 용어는 "태그 포트"지만 시스코에서는 "트렁크 포트"라고 부르며, 타 제조사에서는 다른 의미로 사용하기 때문에 주의 필요. 일반 포트는 Untagged, Access 포트라고 부름***

MAC 테이블에도 VLAN 지정 필드가 생겨서, VLAN 별로 MAC 주소 테이블이 존재하는 것처럼 동작

스위치 간 연결 외에도 서버와 연결된 포트도 VMWare, ESXi 같은 가상화 서버와 연결된다면 태그 포트로 설정해야 함. (가상화 서버 내에 가상화 스위치가 있기 때문)

## STP

### 루프란?

두 대 이상의 스위치로 디자인하면 패킷이 네트워크를 따라 전송되므로 네트워크 마비 가능 -> 네트워크 루프

대부분 브로드캐스트 스톰으로 인한 문제

#### 브로드캐스트 스톹

3계층에는 TTL이 있지만 2계층에는 없기 때문에 패킷이 죽지 않고 계속 살아남아 패킷 하나가 전체 네트워크 대역폭을 차지

1. 네트워크에 접속된 단말의 속도가 느려짐 (많은 브로드캐스트 처리로 인해 CPU 사용률이 높아짐)
2. 네트워크 접속 속도가 느려짐 (거의 통신 불가능)
3. 네트워크에 설치된 스위치에 모든 LED가 동시에 깜빡임(?)

#### 스위치 MAC 러닝 중복 문제

브로드캐스트 뿐 아니라 유니캐스트도 문제. 중복 수신 뿐만 아니라 중간에 있는 스위치에서 MAC 러닝 문제가 발생.

직접 전달된 패킷과 돌아 들어간 패킷 간의 포트가 달라 정상적인 학습이 불가능 -> **MAC Address Flapping**

**How to solve?**

루프 구성 포트 중 하나만 셧다운되어도 루프 예방이 가능하지만, 수동으로 루프를 찾아 강제로 사용하지 못하게 하는 것은 바람직하지 않음.

심지어 케이블 연결을 통해 루프를 찾아내는 것이 힘듦.

### STP란?

루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘

전체 스위치 연결 상황 파악을 위해 BPDU(Bridge Protocol Data Unit) 프로토콜을 통해 스위치 간에 정보를 전달하고 전체 네트워크 트리를 만들어 루프 구간을 확인.

#### 스위치 포트의 상태 및 변경 과정

STP가 동작 중이라면 스위치 포트에 신규 스위치가 연결되면 바로 트래픽이 흐리지 않도록 차단하고, BPDU를 기다려 학습한 후 트래픽을 흘리거나 루프 구조면 차단 상태를 유지.

4가지 스위치 상태
- Blocking : 상대방이 보내는 BPDU를 기다림. 20초 Max Age 동안 BPDU를 못 받았거나 후순위 BPDU를 받으면 리스닝 상태로 변경. 기본 교환 주기는 2초, 10번의 BPDU를 기다림
- Listening : BPDU 정보를 상대방에서게 전송하기 시작. 총 15초 대기
- Learning : 해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 정상 동작하도록 MAC 주소를 러닝. 총 15초 대기.
- Forwarding : 정상 통신

스위치에 신규 장비를 붙이면 약 50여 초 소요. 스위치는 루프 방지를 위해 매우 방어적으로 동작하게 됨. (단말 연결도 동일)

스위치 자체 포트 이상은 즉시 Listening 단계로 넘어가기 때문에 시간이 짧음 (30초) -> 인접 스위치 포트 이상은 위처럼 동작

#### STP 동작 방식

가장 높은 스위치(루트) 선정 후 이것을 통해 BPDU 교환. BPDU를 통해 2초마다 본인이 루트 스위치임을 광고. BPDU에 있는 브릿지 ID 값을 비교해 더 작은 쪽을 루트 스위치로 선정

1. 루트 스위치 선정
2. 루트가 아닌 스위치 중 하나의 루트 포트(루트 브릿지로 가는 경로가 가장 짧은 포트, 루트 브릿지에서 보낸 BPDU를 받는 포트)를 선정
3. 하나의 세그먼트에서 하나의 지정(Designated) 포트, 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정, 를 선정 -> BPDU가 지정포트에서 나와 루트포트로 들어간다는데 반대 아닌가? 🤔

**Port Fast**

단말에서도 시간이 지연되는 문제 때문에 Port Fast를 통해 BPDU 대기, 습득 없이 포워딩 상태로 포트 사용 가능. 단, 해당 포트에 스위치 접속시 루프가 생길 수 있어 BPDU 가드 같은 기술이 함꼐 사용

### 향상된 STP (RSTP, MST)

TCP 기반 애플리케이션이 네트워크가 끊겼을 때 30초를 기다리지 못하다보니 STP 기반 네트워크에 장애가 생기면 통신이 끊길 수 있음.

혹은 스위치에 여러 VLAN이 있으면 각 VLAN별로 STP 계산하면서 부하가 발생하기도 함.

#### R(Rapid)STP

절체 시간이 2~3초로 짧고, BPDU 메시지 형식이 다양해져 여러 가지 상태 메시지를 교환할 수 있음.

토폴로지 변경 시 말단 스위치에서 루트 브릿지까지 변경 보고를 보내고, 루트 브릿지가 그에 대한 연산을 다시 하고 변경된 토폴로지 정보를 말단 스위치까지 보내는 과정을 거쳤으나,

RSTP는 토폴로지 변경이 일어난 스위치 자신이 모든 네트워크에 토폴로지 변경을 직접 전파할 수 있음.

#### MST

일반 스패닝 트리 프로토콜은 C(Commmon)ST라고 불림. VLAN 개수와 상관없이 한 개의 트리만 동작함. -> VLAN이 많아도 스패닝 트리는 한 개이기 때문에 관리 부하가 적지만, 루프가 생기는 토폴로지에서 한 개의 포트와 회선만 활성화되기 떄문에 자원이 비효율적 + VLAN마다 최적의 경로가 다른데 포트 한 개만 쓰다보니 통신이 비효율적.

이 문제 해결을 위해 PV(Per Vlan)ST가 개발되었고 VLAN마다 다른 스패닝 트리 프로세스가 동작. -> 최적 경로 디자인 + VLAN마다 블록 포트 지정을 통해 네트워크 로드를 셰어링하도록 구성할 수 있었음. 단, 2초마다 교환하는 프로토콜인데 별도의 스패닝 트리를 VLAN마다 유지해야 해서 더 부담되었음.

CST, PVST의 단점을 보완하기 위해 M(Multiple)ST가 개발되었음.

**MST란?** 여러 개의 VLAN을 그룹을 묶고 그 그룹마다 별도의 스패닝 트리가 동작. 이 경우, PVST보다 더 적은 STP 프로세스가 돌게 되고 PVST처럼 로드 셰어링도 가능

대체 경로의 개수나 용도에 따라 STP 프로세스 개수를 정의. 또한 리전 개념이 도입되어 여러 VLAN을 하나의 리전으로 묶을 수도 있음.

***스위치의 구조***

스위치는 Control Plane, 패킷을 포워딩 하는 Data Plan으로 크게 나뉨.

STP, 스위치 원격 관리용 텔넷, SSH, 웹은 컨트롤 플레인에서 수행.

동작 자체에는 IP가 필요없지만, 용이한 관리를 위해 IP 할당이 되기도 함.


