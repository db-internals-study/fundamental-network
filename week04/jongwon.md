```toc
```

# 4장 스위치 2계층 장비
 - 스위치는 MAC 주소를 기반으로 동작
- 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 중재자 역할
- 아무 설정 없이 네트워크에 연결해도 MAC 주소를 기반으로 패킷을 전달하는 기본 동작을 수행할 수 있다.

- 그 외에도 한 대의 장비에서 논리적으로 네트워크를 분리할 수 있는 VLAN 기능
- 네트워크 루프 방지하는 스패닝 트리 프로토콜(STP)와 같은 기본 기능을 지님
- 그 외에도 다양한 보안 기능, 모니터링 기능 등

- 패킷? 프레임?
	- 각 계층에서 헤더와 데이터를 합친 부분을 PDU(Protocol Data Unit)이라고 부름
	- 각 계층마다 PDU를 부르는 이름이 다름
	- 1계층: 비트
	- 2계층 : 프레임
	- 3계층 : 패킷
	- 4계층 : 세그먼트
	- 5~7계층 : 데이터
## 4.1 스위치 장비 동작
- 스위치가 없던 오래된 이더넷 네트워크에서는 패킷을 전송할 때 서로 경합해 그로 인한 네트워크 성능 저하가 컸다
- 이런 경쟁을 없애고 동시에 여러 장비가 간섭 없이 통신할 수 있도록 도와주는 장비
- 여러 단말이 한 번에 통신할 수 있어 기다리거나 충돌 떄문에 대기하는 문제가 해결, 효율성 올라감

- 스위치의 핵심은 누가 어느 위치에 있는지 파악하고 정확하게 알고있는 위치로만 전송하는 것
- 이는 스위치가 2계층 주소를 이해하고, MAC 주소와 단말 인터페이스 정보를 매핑한 MAC 주소 테이블을 가지고 있어서 가능

- 스위치는 헤더의 MAC 주소를 보고 어느 포트에 있는지 찾고, 패킷을 그 포트로만 전송
- 이를 위해서는 MAC 주소와 포트가 매핑된 MAC 주소 테이블이 필요
- 만약 테이블에 없는 주소가 들어오면 전체 포트로 패킷 전송

- 스위치의 동작 방식은 크게 3가지로 정리 가능
	- 플러딩(Flooding)
	- 어드레스 러닝(Address Learning)
	- 포워딩/필터링(Forwarding/Filtering)

### 4.1.1 플러딩
- 스위치는 부팅하면 아무런 정보가 없다
	- 이때 스위치는 허브처럼 동작한다.
	- 들어온 포트를 제외하고 모든 포트로 패킷을 전달한다
- 이렇게 모든 포트로 패킷을 흘리는 방식을 플러딩이라고 한다.

- 이런 플러딩은 스위치의 정상적인 동작이지만, 이런 동작이 많아지면 스위치가 제 역할을 못한다
- 패킷이 스위치에 들어오면 해당 패킷의 MAC 정보를 보고 이를 학습해 MAC 주소 테이블을 만든 후 이를 통해 패킷을 전송한다.

- 비정상적인 플러딩
	- 이더넷-TCP/IP 네트워크에서는 ARP 브로드캐스트 후 데이터를 전달하므로 실제로 데이터를 보내고 받을 때는 스위치가 패킷을 플러딩하지 않는다
		- 필요한 곳에만 패킷을 보내니 보안적으로도 도움이 된다
	- 이런 스위치 기능을 무력화해 주변 통신을 모니터링하는 공격 기법이 사용된다
	- 스위치에게 엉뚱한 MAC 주소를 습득시키거나 스위치의 MAC 테이블을 꽉 차게 해 플러딩 동작을 유도
	- 아무런 이유 없이 스위치가 패킷을 플러딩한다면 스위치가 정상적으로 동작하지 않거나 주변에서 공격이 수행되는 상황
	- 이 외에도 ARP 포이즈닝 기법을 이용해 모니터링해야 할 IP의 MAC 주소가 공격자 자신인 것처럼 속여 원하는 통신을 받는 기법을 사용하기도 한다.

[ARP 포이즈닝: 정의, 기법, 방어 및 차단 | Okta Identity Korea](https://www.okta.com/kr/identity-101/arp-poisoning/)

### 4.1.2 어드레스 러닝
- 스위치가 패킷을 원하는 곳으로만 보내려면 MAC 주소 테이블을 만들고 유지해야 함
- MAC 주소 테이블은 어느 포트에 어떤 MAC 주소가 연결되었는지에 대한 정보가 저장된 임시 테이블
- 이런 MAC 주소 테이블을 만들고 유지하는 과정을 어드레스 러닝이라고 한다.

- 어드레스 러닝은 출발지 MAC 주소를 이용
- 패킷이 특정 포트에서 들어오면 스위치는 해당 패킷의 출발지 MAC 주소와 포트 번호를 테이블에 기록
- 어드레스 러닝은 출발지의 MAC 주소 정보를 사용하므로 브로드캐스트나 멀티캐스트에 대한 MAC 주소를 학습할 수 없다
	- 두 가지 모두 목적지 MAC 주소 필드에서만 사용하므로

- 사전 정의된 MAC 주소 테이블
	- 스위치는 어드레스 러닝 외에도 미리 정의된 MAC 주소 정보를 가지고 있다
	- 보통 패킷 처리보다는 스위치 간 통신을 위해 주로 사용되는 주소
	- 이런 종류의 주소도 MAC 주소 테이블에서 확인 가능
	- 스위치에서 자체 처리되는 주소는 특정 포트로 내보내는 것이 아니라 스위치에서 자체 처리하므로 인접 포트 정보가 없거나 CPU 혹은 관리 모듈을 지칭하는 용어로 표시된다

### 4.1.3 포워딩/필터링
- 스위치의 동작은 패킷이 스위치에 들어오면 도착지 MAC 주소를 보고 MAC 테이블과 비교해 맞는 정보가 있다면 해당 포트로 패킷을 **포워딩**하는 것
- 이때 다른 포트로는 패킷을 안 보내므로 이런 동작을 **필터링**이라고 한다

- 스위치는 포워딩과 필터링이 여러 포트에서 동시에 수행될 수 있다
- 즉, 통신이 다른 포트에 영향을 미치지 않음

- 스위치는 일반적인 유니캐스트에 대해서만 포워딩, 필터링 수행
- BUM 트래픽이라 불리는 브로드캐스트와 언노운 유니캐스트, 멀티캐스트는 조금 다르게 동작
	- 출발지 MAC 주소로 브로드캐스트나 멀티캐스트 모두 출발지가 사용되지 않으므로 필터링 없이 모두 플러딩
	- 언노운 유니캐스트도 MAC 테이블에 없는 주소이므로 플러딩

- 이더넷 TCP/IP 네트워크에서는 ARP 브로드캐스트로 플러딩이 거의 없음
- ARP와 MAC 테이블 모두 일정 시간 동안 지워지지 않는데 이 시간을 Aging Time이라고 함
- 일반적으로 MAC 테이블의 에이징 타임이 단말의 ARP 에이징 타임보다 길어 이더넷 네트워크를 플러딩 없이 효율적으로 운영 가능

## 4.2 VLAN
- 스위치에서는 오래 전부터 VLAN이라는 가상화 기술 사용
- 하나의 물리 스위치에서 여러 개의 네트워크를 나누어 사용할 수 있는 VLAN(Virtual Local Area Network)

### 4.2.1 VLAN이란?
- VLAN은 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술
- 과도한 브로드캐스트로 인한 단말들의 성능 저하, 보안 향상을 위한 차단 용도, 서비스 성격에 따른 정책 적용과 같은 이유로 네트워크 분리 필요

![](files/Pasted%20image%2020250309184050.png)

- VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할하므로 유니캐스트뿐만 아니라 브로드캐스트도 VLAN 간에 통신할 수 없다
- VLAN 간의 통신이 필요하다면 3계층 장비가 필요하다

![](files/Pasted%20image%2020250309184154.png)

- VLAN을 사용하면 물리적 구성과 상관없이 네트워크를 분리할 수 있고 물리적으로 다른 층에 있는 단말이 하나의 VLAN을 사용해 동일한 네트워크로 묶는 것도 가능하다.

### 4.2.2 VLAN의 종류와 특징
- VLAN 할당 방식에는 포트 기반의 VLAN, MAC 주소 기반의 VLAN이 있따
- 초기에는 스위치가 비쌌고 여러 허브를 스위치가 묶어서 스위치를 분할해 여러 네트워크에 사용하는 것이 VLAN의 목적
- 이렇게 스위치를 논리적으로 분할해 사용하는 것이 목적인 VLAN을 포트 기반 VLAN(Port Based VLAN)이라고 부른다
- 우리가 일반적으로 언급하는 대부분의 VLAN은 포트 기반
- 어떤 단말이 접속하든지 스위치가 특정 포트에 VLAN을 할당하면 할당된 VLAN에 속함

![](files/Pasted%20image%2020250309184355.png)

- 사용자들의 자리 이동이 많아지면서 MAC 기반 VLAN(MAC Based VLAN)이 개발됨
- 고정 포트에 VLAN을 할당하는 게 아니라 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN 할당
- 단말에 따라 VLAN 정보가 바뀔 수 있어 Dynamic VLAN이라고도 부른다

- 앞으로 다룰 내용은 포트 기반 VLAN이다.

- 데이터 센터에서 스위치 VLAN은 포트 기반 VLAN으로 구성하는 게 일반적
- 오피스나 캠퍼스 네트워크에서도 포트 기반 VLAN 구성이 일반적이지만 사용자의 이동성 요구하는 스마트 오피스 요구로 MAC 기반 VLAN도 많아지고 있다

### 4.2.3 VLAN 모드(Trunk/Access) 동작 방식
- 포트 기반 VLAN에서는 스위치의 각 포트에 사용할 VLAN을 설정
- 한 대 스위치에 연결되더라도 서로 다른 VLAN이 설정된 포트 간에는 통신할 수 없다
- VLAN이 다르면 별도의 분리된 스위치에 연결된 것과 같음 -> 3계층 장비 필요
	- VLAN으로 구분된 네트워크에서는 브로드캐스트인 ARP 요청이 다른 VLAN으로 전달 불가능

![](files/Pasted%20image%2020250309184608.png)

- 스위치 포트에 VLAN 설정해 네트워크 분리하면 물리적으로 스위치를 분리할 때보다 효율적으로 장비 사용 가능

![](files/Pasted%20image%2020250309184656.png)

- 여러 개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우 각 VLAN끼리 통신하려면 VLAN 개수만큼 포트 연결 필요
- VLAN으로 분할된 스위치는 물리적인 별도 스위치 취급

- VLAN을 많이 사용하는 중, 대형 네트워크에서는 VLAN 포트 연결로 포트가 많이 소비된다

![](files/Pasted%20image%2020250309184727.png)

![](files/Pasted%20image%2020250309184913.png)

- 그래서 VLAN 태그 기능이 있음
- 태그 기능은 하나의 포트에 여러 개의 VLAN 전송이 가능하도록 해줌
- 이 포트를 Tagged 포트 혹은 Trunk 포트라고 부름
- 여러 개의 VLAN을 동시에 전송해야 하는데 태그 포트는 이더넷 프레임 중간에 VLAN ID 필드를 끼워 넣음
- 수신 측에서는 VLAN ID를 제거하고, VLAN ID의 VLAN으로 패킷을 보낼 수 있음

- 일반적인 용어는 Tagged 포트이나 시스코에서 Trunk 포트라고 부름
- 타 제조사에서는 트렁크 포트는 여러 개의 포트를 묶어 사용하기 위한 링크 애그리게이션 의미로 사용됨

- 태그 포트 사용하면 포트 낭비가 줄어들어 네트워크를 더 유연하게 디자인 가능
- 태그 포트 기능이 생기면서 MAC  주소 테이블에도 변화가 생김
- 다른 VLAN끼리 통신을 못하도록 MAC 테이블에 VLAN 지정하는 필드가 추가됨
- 즉, VLAN별로 MAC 주소 테이블이 따로 있는 것처럼 동작함

- 일반적인 포트를 Untagged 포트 혹은 Access 포트라고 함
- 일반적으로 태그 포트는 여러 네트워크가 동시에 설정된 스위치 간 연결에 사용
- 하나의 네트워크에 속한 서버의 경우 언태그로 설정

![](files/Pasted%20image%2020250309185216.png)

- 스위치 간의 연결이 아닌 서버와 연결된 포트도 Vmware의 ESXi와 같은 가상화 서버로 연결될 경우 여러 VLAN과 통신 필요
- 이 경우 서버와 연결된 스위치의 포트더라도 태그로 설정한다
	- 물론 가상화 서버 쪽 인터페이스에서도 태그 상태로 설정

- VLAN 간 통신
	- VLAN이 다르면 별도의 네트워크이므로 네트워크도 다르고 IP 주소 할당도 다른 네트워크로 할당되는 것이 일반적

## 4.3 STP
- IT 환경에서는 SPoF 막으려고 노력한다
- 네트워크에서도 하나의 장비 고장으로 전체 네트워크가 마비되는 것을 막기 위해 이중화, 다중화된 네트워크를 디자인하고 구성

![](files/Pasted%20image%2020250309185324.png)

- 네트워크를 하나의 스위치로 구성하면 그 스위치에 장애가 생겼을 때 전체 네트워크에 장애가 생김
- 이를 피하기 위해 스위치 두 대로 네트워크를 디자인하지만, 두 대 이상의 스위치로 디자인하면 패킷이 네트워크를 따라 계속 전송되므로 네트워크를 마비시킬 수 있음
- 이를 네트워크 루프라고 함
- 루프를 예방하려면 별도의 메커니즘 필요

### 4.3.1 루프란?
![](files/Pasted%20image%2020250309185452.png)

- 말 그대로 네트워크에 연결된 모양이 고리처럼 되돌아오는 형태로 구성된 상황
- 루프 상황이 발생하면 네트워크가 마비되고 통신이 안 될 수 있음
	- 보통 브로드캐스트 스톰으로 인한 문제

#### 4.3.1.1 브로드캐스트 스톰
- 루프 상태에서 브로드캐스트 쏘면 스위치는 모든 포트로 플러딩하고, 이를 받은 스위치는 또 플러딩해 패킷이 계속 돌아간다
- 3계층 헤더에는 TTL이 있지만 스위치에는 이런 메커니즘이 없어 루프가 발생하면 패킷이 죽지 않고 계속 살아 남아 패킷 하나가 전체 네트워크 대역폭을 차지할 수 있다
	- 단말의 속도가 느려지거나 (브로드캐스트 처리하느라 CPU 많이 씀)
	- 네트워크 접속 속도가 느려짐 (혹은 거의 사용 불가능)
	- 네트워크에 설치된 스위치의 모든 LED들이 동시에 빠른 속도로 깜빡임

- 이 경우 케이블을 제거하기 전까지 지속된다

#### 4.3.1.2 스위치 MAC 러닝 중복 문제
- 브로드캐스트 뿐만 아니라 유니캐스트도 문제가 있다
- 같은 패킷이 루프를 돌아 도착지 쪽에서 중복 수신되는 혼란을 일으키지만
- 중간에 있는 스위치에서도 MAC 러닝 문제가 발생

- 출발지 MAC 주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷 간의 포트가 달라 MAC 주소를 정상적으로 학습할 수 없음
- 동일한 MAC 주소가 여러 포트에서 학습되면 MAC 주소 테이블이 반복 갱신되어 정상적으로 동작하지 않음
- 이를 MAC Address Flapping이라고 부른다.

![](files/Pasted%20image%2020250309185812.png)

- 이런 현상이 발생하면 스위치가 패킷을 계속 플러딩한다
- 이런 현상을 예방하기 위해 스위치 설정에 따라 경고 메시지를 관리자에게 알려주거나 수시로 일어나는 플래핑 현상을 학습하지 않도록 자동으로 조치

![](files/Pasted%20image%2020250309185930.png)

- 네트워크에 루프가 발생한 경우, 앞의 문제들 떄문에 네트워크가 정상적으로 동작하지 않으므로 루프가 생기지 않도록 미리 네트워크에 조치 필요
- 루프 구성 포트 중 하나의 포트만 사용하지 못하도록 셧다운 되어 있어도 루프 예방 가능

- 하지만 SPoF 막기 위해서 스위치 두 개 이상 넣었는데 다시 수동으로 루프를 찾아 강제로 사용하지 못하게 하는 것은 바람직하지 않다
- 네트워크는 케이블 연결이 복잡해 루프 찾아내는 게 어렵고
- 강제로 포트를 비활성화해도 네트워크 장애 발생하면 해당 포트를 수동으로 다시 사용해야 함
- 사용자가 적극적으로 개입하는 방법으로는 네트워크 장애 적절히 대응할 수 없다

![](files/Pasted%20image%2020250309190102.png)

- 이런 이유로 루프를 자동 감지해 포트를 차단하고, 장애 때문에 우회로가 없을 때 차단된 포트를 다시 풀어주는 스패닝 트리 프로토콜이 개발되었다.

### 4.3.2 STP란?
- Spanning Tree Protocol
- 루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘
- 용어 그대로 뿌리부터 가지까지 루프가 생기지 않도록 유지하는 것이 목적

- STP 이용해 루프 막으려면 전체 스위치가 어떻게 연결됐는지 알아야 한다
- BPDU(Bridge Protocol Data Unit)이라는 프로토콜로 스위치 간에 정보를 전달하고 이렇게 수집된 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간을 확인

![](files/Pasted%20image%2020250309204535.png)

- BPDU에는 스위치가 갖고 있는 ID와 같은 고유값이 들어가고 이런 정보들이 스위치 간에 서로 교환되면서 루프 파악이 가능해진다
- 확인된 루프 지점을 차단해 루프를 예방

![](files/Pasted%20image%2020250309204610.png)

#### 4.3.2.1 스위치 포트의 상태 및 변경 과정
- STP 동작 중인 스위치에서는 루프 막기 위해 스위치 포트에 신규 스위치가 연결되어도 바로 트래픽을 흘리지 않는다
- 해당 포트로 트래픽을 흘려도 되는지 파악하기 위해 BPDU를 기다려 학습하고 구조를 파악한 후 흘리거나 차단한다

![](files/Pasted%20image%2020250309204940.png)
- 차단 상태에서 트래픽이 흐를 때까지 스위치 포트의 상태는 4개로 구분할 수 있다
	- Blocking
		- 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU 기다림
		- 총 20초인 Max Age 동안 BPDU를 받지 못했거나 후순위 BPDU를 받았을 때 포트는 리스닝 상태로 변경
		- BPDU 기본 교환 주기는 2초, 10번의 BPDU 기다림
	- Listeneing
		- 해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계
		- 자신의 BPDU를 상대방에게 전송하기 시작
		- 총 15초 동안 대기
	- Learning
		- 이미 해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소를 러닝하는 단계
		- 총 15초 동안 대기
	- Forwarding
		- 패킷을 포워딩하는 단계

- 스위치에 신규로 장비를 붙이면 통신하는 데 50여초 걸림
	- 루프 예방을 위해 매우 방어적으로 동작
	- 새로 연결된 단말이 스위치일 가능성이 있어 BPDU를 일정 시간 이상 기다려 스위치 여부 파악
	- 즉, 스위치 연결 뿐만 아니라 일반 단말 연결에도 동일한 시간이 걸림 

![](files/Pasted%20image%2020250309205114.png)

- 이중화된 링크 절체(전환)도 STP 동작 순서대로 진행
- 특정 링크가 다운되어 블로킹 포트가 포워딩되기 위해 초기와 마찬가지로 20초 동안 Max Age를 거쳐 총 50초 후 포워딩 상태로 변경
- 다운된 링크가 자신의 인터페이스인 경우 토폴로지가 변했음을 직접 감지할 수 있어 Max Age 거치지 않고 리스닝부터 STP 상태 변화가 즉시 이루어지므로 30초 만에 절체된다

- STP가 활성화된 경우 스위치 포트는 곧바로 포워딩 상태가 되지 않는다
- 이로 인해 다양한 장애가 발생하거나 스위치 이상으로 생각되는 경우가 많다
- 부팅 시간이 매우 빠른 OS가 DHCP 네트워크 접속할 때 부팅 단계에 IP를 요청하지만 스위치 포트가 포워딩 상태가 되지 않아 IP 할당 못 받기도 한다

#### 4.3.2.2 STP 동작 방식
- 네트워크 상에서 뿌리가 되는 가장 높은 스위치 선출
- 그 스위치를 통해 모든 BPDU가 교환되도록 함
	- 이를 루트 스위치라고 부름
- 모든 스위치는 처음에 자신을 루트 스위치로 인식해 동작
- BPDU를 통해 2초마다 자신이 루트 스위치임을 광고하는 데 새로운 스위치가 들어오면 서로 교환된 BPDU에 들어있는 브릿지 ID 값을 비교
- 브릿지 ID 값이 더 적은 스위치를 루트 스위치로 선정하고 루트 스위치로 선정된 스위치가 BPDU를 다른 스위치로 보냄

![](files/Pasted%20image%2020250309205620.png)

- 루프 예방을 위해 아래처럼 동작
	1. 하나의 루트 스위치 선정
		- 전체 네트워크에 하나 선정
		- 자신을 전체 네트워크의 대표 스위치로 적은 BPDU를 옆 스위치로 전달
	2. 루트가 아닌 스위치 중 하나의 루트 포트 선정
		- 루트 브릿지로 가는 경로가 가장 짧은 포트를 루트 포트라고 함
		- 루트 브릿지에서 보낸 BPDU를 받는 포트
	3. 하나의 세그먼트에 하나의 지정(Designated) 포트 선정
		- 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정
		- 스위치 간의 연결에서 이미 루트 포트로 선정된 경우, 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태가 됨
		- 스위치 간 연결에서 아무도 루트 포트가 아닐 경우, 한쪽은 지정 포트로 선정되고 다른 한 쪽은 대체 포트(Alternative, Non-designated)가 되어 차단 상태가 됨
		- BPDU가 전달되는 포트다

- STP 사용 시 대안(Port Fast)
	- STP는 단말이 연결되면 포워딩 상태가 될 때까지 시간이 좀 걸림
	- 스위치가 아닌 일반 PC나 서버가 연결될 포트라면 이런 메커니즘을 아예 없애거나 좀 더 빠른 시간 안에 포워딩 상태로 변경되어야 함
	- 해당 포트를 포트 패스트(Port Fast)로 설정하면 BPDU 대기, 습득 과정 없이 곧바로 포워딩
	- 포트 패스트를 설정한 포트에 스위치를 연결하면 루프가 생길 수 있어 별도로 해당 포트에 BPDU가 들어오자마자 포트를 차단하는 BPDU Guard 같은 기술이 함께 사용되어야 함

### 4.3.3 향상된 STP(RSTP, MST)
- STP는 루프 예방을 위해 같은 네트워크에 속한 모든 스위치까지 BPDU가 전달되는 시간을 고려
- 블로킹 포트가 포워딩 상태로 변경될 때까지 30 ~ 50초 소요
- 통신에 가장 많이 쓰이는 TCP 기반 애플리케이션이 네트워크가 끊겼을 때 30초를 기다리지 못하다보니 STP 기반 네트워크에 장애가 생기면 통신이 끊길 수 있따
- 스위치에 여러 개의 VLAN이 있으면 각 VLAN 별로 STP를 계산하면서 부하가 생기기도 한다

#### 4.3.3.1 RSTP
- STP는 이중화된 스위치 경로 중 정상적인 경로에 문제가 발생할 경우, 백업 경로를 활성화하는 데 30 ~ 50초가 걸린다
- 이렇게 백업 경로를 활성화하는 데 시간이 너무 오래 걸리는 문제를 해결하기 위해 RSTP(Rapid Spanning Tree Protocol)가 개발됨
- RSTP는 2~3초로 절체 시간이 짧아 일반적인 TCP 기반 애플리케이션에서 세션을 유지할 수 있다.

![](files/Pasted%20image%2020250309210726.png)

- 기본적인 구성과 동작은 STP와 같지만 BPDU 메시지 형식이 다양해져 여러 가지 상태 메시지 교환 가능
- STP는 일반 토폴로지 변경과 관련된 두 가지 메시지(TCN, TCA BPDU)만 있지만 RSTP는 8개 비트를 모두 활용해 다양한 정보를 주고받을 수 있다.

![](files/Pasted%20image%2020250309210853.png)
![](files/Pasted%20image%2020250309210916.png)

- 기존 STP에서는 토폴로지가 변경되면 말단 스위치에서 루트 브릿지까지 변경 보고를 보내고 루트 브릿지가 그에 대한 연산을 다시 완료하고 이후 변경된 토폴로지 정보를 말단 스위치까지 보내는 과정을 거침
- 이런 정보가 네트워크에 있는 모든 스위치까지 전파되는 예비시간까지 고려해야 하므로 시간이 오래 걸렸다
- RSTP에서는 토폴로지 변경이 일어난 스위치 자신이 모든 네트워크에 토폴로지 변경을 직접 전파할 수 있다.

- RSTP는 다양한 BPDU 메시지, 대체 포트 개념, 토폴로지 변경 전달 방식의 변화로 STP보다 빠르게 토폴로지 변경을 감지, 복구할 수 있다
- 실제로 RSTP는 2~3초 안에 복구되므로 애플리케이션 세션이 끊기지 않아 보다 안정적으로 네트워크 운영하는 데 도움이 된다

#### 4.3.3.2 MST
- 일반 STP는 CST(Common Spanning Tree)라고 부른다
- VLAN 개수와 상관없이 스패닝 트리 한 개만 동작
- VLAN이 많더라도 스패닝 트리는 하나이므로 스위치 관리 부하가 적다
- 하지만 CST는 루프가 생기는 토폴로지에서 한 개의 포트와 회선만 활성화되므로 자원을 효율적으로 활용할 수 없다
- VLAN마다 최적 경로가 다를 수 있는 데 하나의 포트만 사용하다보니 멀리 돌아가는 경우도 생긴다.

![](files/Pasted%20image%2020250309211421.png)
![](files/Pasted%20image%2020250309211434.png)

- 이런 문제를 해결하기 위해 PVST(Per Vlan Spanning Tree)가 개발됨
- VLAN마다 다른 스패닝 트리 프로세스가 동작하므로 VLAN마다 별도의 경로와 트리를 만들 수 있게 되었다
- 덕분에 최적 경로를 디자인하고 VLAN마다 별도의 블록 포트를 지정해 네트워크 로드를 쉐어링하도록 구성할 수 있음

- 하지만 STP 자체가 스위치에 많은 부담을 주는 프로토콜(2초마다 교환)인데 PVSt는 모든 VLAN마다 별도의 스패닝 트리를 유지해야 하므로 더 많은 부담이 됨
- 이를 보완하기 위해 MST(Multiple Spanning Tree)가 개발됨

- MST의 기본적인 아이디어는 매우 단순
- 여러 개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패닝 트리가 동작
- 이 경우 PVST보다 훨씬 적은 스패닝 트리 프로토콜 프로세스가 돌게 되고, PVST의 장점인 로드 쉐어링 기능도 이용 가능

- 일반적으로 대체 경로의 개수나 용도에 따라 MST의 스패닝 트리 프로토콜 프로세스 개수를 정의
- MST에는 리전 개념이 도입되어 여러 개의 VLAN을 하나의 리전으로 묶을 수 있다
- 리전 하나 당 스패닝 트리 하나

- STP는 루프 예방에 필수적인 메커니즘이지만 스위치에 부담이 많은 프로토콜이고 포트가 차단되거나 늦게 포워딩되어 불편한 점이 있다
- 이를 해결하기 위해 PortFast, UplinkFast, BackboneFast와 같은 다수 기능이 있지만 잘못 사용하면 장애 발생 원인이 되기도 한다
- 여러 가지 불편한 STP를 근본적으로 대체하기 위해 네트워크를 잘개 쪼개서 디자인하거나 대체재를 사용하는 경우가 많다
- 이런 대체재 프로토콜은 대부분 모두 호환되는 게 아니라 스위치 제작업체에서만 동작하거나 이름은 같아도 동작 방식이 다르거나 호환성이 없는 경우가 있다
	- SLPP, Extreme STP, Loop Guard, BPDU Guard

![](files/Pasted%20image%2020250309212154.png)

- 스위치의 구조와 스위치에 IP 주소가 할당된 이유
	- 스위치는 스위치 관리용 컨트롤 플레인과 패킷을 포워딩하는 데이터 플레인으로 나뉜다
	-  STP, 스위치 원격관리용 텔넷, SSH, 웹과 같은 서비스는 컨트롤 플레인에서 수행
	- 스위치는 2계층에서 동작하는 장비여서 MAC 주소만 이해
	- 스위치가 동작하는 데 IP 주소는 필요없지만
	- 일정 규모 이상의 네트워크에서 운영되는 스위치는 관리 목적으로 대부분 IP가 할당된다
